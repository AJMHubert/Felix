<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Felix: /home/alex/Work/Felix/src/felix/ug_matrix_mod.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Felix
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_f1e7363fc85375508a63a202db318404.html">felix</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ug_matrix_mod.f90</div>  </div>
</div><!--header-->
<div class="contents">
<a href="ug__matrix__mod_8f90.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">! Felix</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">! Richard Beanland, Keith Evans &amp; Rudolf A Roemer</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">! (C) 2013-17, all rights reserved</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">! Version: :VERSION:</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">! Date:    :DATE:</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">! Time:    :TIME:</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">! Status:  :RLSTATUS:</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">! Build:   :BUILD:</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">! Author:  :AUTHOR:</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">! </span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">!  Felix is free software: you can redistribute it and/or modify</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">!  it under the terms of the GNU General Public License as published by</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">!  the Free Software Foundation, either version 3 of the License, or</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">!  (at your option) any later version.</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">!  </span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">!  Felix is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">!  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">!  GNU General Public License for more details.</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">!  </span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">!  You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">!  along with Felix.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%               </span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html">   36</a></span>&#160;<span class="keyword">MODULE</span> <a class="code" href="namespaceug__matrix__mod.html">ug_matrix_mod</a></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  <span class="keywordtype">PRIVATE</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="keywordtype">PUBLIC</span> :: <a class="code" href="namespaceug__matrix__mod.html#add186c4b63f545bc1cec1d65317fd4fa">absorption</a>, <a class="code" href="namespaceug__matrix__mod.html#a474715ded1528587b5e199891234a860">getvgcontributionij</a>, <a class="code" href="namespaceug__matrix__mod.html#aefbfaa87735de589ffff68e6d7faaa86">structurefactorinitialisation</a> </div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keyword">CONTAINS</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#add186c4b63f545bc1cec1d65317fd4fa">absorption</a>(IErr)</div><div class="line"><a name="l00048"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#add186c4b63f545bc1cec1d65317fd4fa">   48</a></span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="comment">! calculate CUgMatPrime then ----&gt; CUgMat = CUgMatNoAbs + CUgMatPrime</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemessage__mod.html">message_mod</a></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemympi.html">mympi</a>   <span class="comment">!?? used for parallel</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;   </div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">! global outputs</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacecpara.html">cpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacecpara.html#ab994df5c023832e6fbc15e15b5b28358">cugmat</a>, <a class="code" href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cugmatprime</a></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">! global outputs - seemingly local or minor</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>, <a class="code" href="namespacerpara.html#a059f75f4839e9c616dc85dbe4418d234">rcurrentb</a></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">! global inputs</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacecpara.html">cpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a4178ca9371949c00795220c776bf9d92">iabsorbflag</a>, <a class="code" href="namespaceipara.html#ae62c03ed7743a867fb778bcb19a5e4b6">inatomsunitcell</a>, <a class="code" href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">isymmetryrelations</a>, <a class="code" href="namespaceipara.html#aced1da6491258b042163e55f4231e905">iequivalentugkey</a>, &amp;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;          <a class="code" href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">iatomicnumber</a></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#aa6e33f58b9a58ec8271fa0a00f187fc7">rabsorptionpercentage</a>, rangstromconversion, relectroncharge, &amp;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;          relectronmass, <a class="code" href="namespacerpara.html#ac6e1b12192449367c347418574c2aaac">relectronvelocity</a>, rplanckconstant, <a class="code" href="namespacerpara.html#a339178d3a4919cad9490211dc57bae40">rrelativisticcorrection</a>, &amp;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;          <a class="code" href="namespacerpara.html#a52787d6e96b170221373591f4e1ef159">rvolume</a>, <a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>, <a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>, <a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>, <a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>, <a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>, <a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>, &amp;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;          <a class="code" href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rscattfactovolts</a></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">! local variables</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: ind,jnd,knd,lnd,IErr,IUniqueUgs,ILocalUgCountMin,ILocalUgCountMax</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">DIMENSION(2)</span> :: ILoc</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: Rintegral,RfPrime,RAbsPreFactor</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(3)</span> :: RCurrentG</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordtype">COMPLEX(CKIND)</span>,<span class="keywordtype">DIMENSION(:)</span>,<span class="keywordtype">ALLOCATABLE</span> :: CLocalUgPrime,CUgPrime</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(:)</span>,<span class="keywordtype">ALLOCATABLE</span> :: RLocalUgReal,RLocalUgImag,RUgReal,RUgImag</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">DIMENSION(:)</span>,<span class="keywordtype">ALLOCATABLE</span> :: Ipos,Inum</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keywordtype">COMPLEX(CKIND)</span> :: CVgPrime,CFpseudo</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordtype">CHARACTER*100</span> :: SPrintString</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    </div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    rabsprefactor = <a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*rplanckconstant*rangstromconversion/(relectronmass*<a class="code" href="namespacerpara.html#ac6e1b12192449367c347418574c2aaac">relectronvelocity</a>)</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    </div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="comment">!--------------------------------------------------------------------  </span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="comment">!  select absorption model</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    cugmatprime = <a class="code" href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">czero</a></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="keywordflow">SELECT CASE</span> (<a class="code" href="namespaceipara.html#a4178ca9371949c00795220c776bf9d92">iabsorbflag</a>)</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordflow">CASE</span>(0) <span class="comment">! No absorption</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;      cugmatprime = <a class="code" href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">czero</a></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keywordflow">CASE</span>(1) <span class="comment">! Proportional</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;      cugmatprime = <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>*exp(<a class="code" href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">cimagone</a>*<a class="code" href="namespacemynumbers.html#af76db902418e20dbe03bca6471edcfcd">pi</a>/2)*(<a class="code" href="namespacerpara.html#aa6e33f58b9a58ec8271fa0a00f187fc7">rabsorptionpercentage</a>/100_rkind)</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    </div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="keywordflow">CASE</span>(2) </div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="comment">!--------------------------------------------------------------------  </span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="comment">!  Bird &amp; King absorption</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;      <span class="comment">!--------------------------------------------------------------------  </span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;      <span class="comment">! allocate U&#39;g calculated by this core and setup cores for absorption</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      <span class="comment">! work through unique Ug&#39;s</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      iuniqueugs = <span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#aced1da6491258b042163e55f4231e905">iequivalentugkey</a>)</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;      <span class="comment">! allocations for the U&#39;g to be calculated by this core  </span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;      ilocalugcountmin = (iuniqueugs*(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>)+1</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;      ilocalugcountmax = (iuniqueugs*(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>+1)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;      <span class="keyword">ALLOCATE</span>(ipos(<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>),inum(<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>),stat=ierr)</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;allocate Ipos&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;      <span class="comment">! U&#39;g list for this core</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      <span class="keyword">ALLOCATE</span>(clocalugprime(ilocalugcountmax-ilocalugcountmin+1),stat=ierr)</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;allocate CLocalUgPrime&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;      <span class="comment">! U&#39;g list for this core [Re,Im]</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;      <span class="keyword">ALLOCATE</span>(rlocalugreal(ilocalugcountmax-ilocalugcountmin+1),stat=ierr)</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;allocate RLocalUgReal&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      <span class="comment">! U&#39;g list for this core [Re,Im]</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;      <span class="keyword">ALLOCATE</span>(rlocalugimag(ilocalugcountmax-ilocalugcountmin+1),stat=ierr)</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;allocate RLocalUgImag&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;      <span class="keyword">ALLOCATE</span>(cugprime(iuniqueugs),stat=ierr) <span class="comment">! complete U&#39;g list</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;allocate CUgPrime&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;      <span class="keyword">ALLOCATE</span>(rugreal(iuniqueugs),stat=ierr) <span class="comment">! complete U&#39;g list [Re]</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;allocate RUgReal&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      <span class="keyword">ALLOCATE</span>(rugimag(iuniqueugs),stat=ierr) <span class="comment">! complete U&#39;g list [Im]</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;allocate RUgImag&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;      <span class="comment">! setup position and number for each core</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      <span class="keywordflow">DO</span> ind = 1,<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a> <span class="comment">! p is the number of cores</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        ipos(ind) = iuniqueugs*(ind-1)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a> <span class="comment">! position in the MPI buffer</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        inum(ind) = iuniqueugs*(ind)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a> - iuniqueugs*(ind-1)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a> <span class="comment">! number of U&#39;g components</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      <span class="comment">!--------------------------------------------------------------------  </span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="comment">! fill each core&#39;s U&#39;g list </span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <span class="keywordflow">DO</span> ind=ilocalugcountmin,ilocalugcountmax <span class="comment">! Different U&#39;g s for each core</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        cvgprime = <a class="code" href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">czero</a></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="comment">! number of this Ug</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        jnd=<a class="code" href="namespaceipara.html#aced1da6491258b042163e55f4231e905">iequivalentugkey</a>(ind)</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="comment">! find the position of this Ug in the matrix</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        iloc = minloc(abs(<a class="code" href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">isymmetryrelations</a>-jnd))</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        rcurrentg = <a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(iloc(1),iloc(2),:) <span class="comment">! g-vector, local variable</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        rcurrentgmagnitude = <a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>(iloc(1),iloc(2)) <span class="comment">! g-vector magnitude</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        lnd=0 <span class="comment">! pseudoatom counter</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="comment">! Structure factor calculation for absorptive form factors</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">DO</span> knd=1,<a class="code" href="namespaceipara.html#ae62c03ed7743a867fb778bcb19a5e4b6">inatomsunitcell</a></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;          icurrentz = <a class="code" href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">iatomicnumber</a>(knd) <span class="comment">! Atomic number, global variable</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;          rcurrentb = <a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(knd) <span class="comment">! Debye-Waller constant, global variable</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;          <span class="keywordflow">IF</span> (icurrentz.LT.105) <span class="keywordflow">THEN</span> <span class="comment">! It&#39;s not a pseudoatom </span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="comment">! Uses numerical integration to calculate absorptive form factor f&#39;</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;            <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#a5177d1f0166d49e5e8049a2b497f2a12">doubleintegratebk</a>(rfprime,ierr) <span class="comment">! NB uses Kirkland scattering factors</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;CALL DoubleIntegrateBK&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;          <span class="keywordflow">ELSE</span> <span class="comment">! It is a pseudoatom, proportional model </span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            lnd=lnd+1</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#adbada2b45121e0cc2db9f126d4da6f17">pseudoatom</a>(cfpseudo,iloc(1),iloc(2),lnd,ierr)</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            rfprime=cfpseudo*exp(<a class="code" href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">cimagone</a>*<a class="code" href="namespacemynumbers.html#af76db902418e20dbe03bca6471edcfcd">pi</a>/2)*(<a class="code" href="namespacerpara.html#aa6e33f58b9a58ec8271fa0a00f187fc7">rabsorptionpercentage</a>/<a class="code" href="namespacemynumbers.html#af4fc12a8277bcb2b36bc43248b1fa1cd">hundred</a>)</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <span class="comment">! RfPrime=ZERO</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;          <span class="comment">! Occupancy</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;          rfprime=rfprime*<a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>(knd)</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;          <span class="comment">! Debye Waller factor, isotropic only </span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;          rfprime=rfprime*exp(-<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(knd)*(rcurrentgmagnitude**2)/(4*<a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a>**2) )</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;          <span class="comment">! Absorptive Structure factor equation giving imaginary potential</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;          cvgprime = cvgprime + <a class="code" href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">cimagone</a> * rfprime * &amp;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                exp(-<a class="code" href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">cimagone</a>*dot_product(rcurrentg,<a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>(knd,:)) )</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="keywordflow">        END DO</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <span class="comment">! V&#39;g in volts</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        cvgprime=cvgprime*rabsprefactor*<a class="code" href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rscattfactovolts</a></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="comment">! Convert to U&#39;g=V&#39;g*(2*m*e/h^2)      </span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        clocalugprime(ind-ilocalugcountmin+1) = cvgprime*<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*relectronmass * &amp;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;              <a class="code" href="namespacerpara.html#a339178d3a4919cad9490211dc57bae40">rrelativisticcorrection</a>*relectroncharge / &amp;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;              ((rplanckconstant*rangstromconversion)**2)</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      <span class="comment">!--------------------------------------------------------------------  </span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;      <span class="comment">! join the U&#39;g lists of each core to CUgPrime</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      rlocalugreal=<span class="keywordtype">REAL</span>(clocalugprime)</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;      rlocalugimag=aimag(clocalugprime)</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;      <span class="comment">!?? RB I give up trying to MPI a complex number, do it with two REAL ones</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      <span class="comment">! MPI gatherv the new U&#39;g s into CUgPrime</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;      <span class="comment">! NB MPI_GATHERV(BufferToSend,No.of elements,datatype,ReceivingArray,No.of elements,)</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;      <span class="keyword">CALL </span>mpi_gatherv(rlocalugreal,<span class="keyword">SIZE</span>(rlocalugreal),mpi_double_precision,&amp;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                     rugreal,inum,ipos,mpi_double_precision,&amp;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                     <a class="code" href="namespacemympi.html#af24ff9c69dacd045d989d47842d0ffcf">root</a>,mpi_comm_world,ierr)</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;MPI_GATHERV RLocalUgReal&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      <span class="keyword">CALL </span>mpi_gatherv(rlocalugimag,<span class="keyword">SIZE</span>(rlocalugimag),mpi_double_precision,&amp;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                     rugimag,inum,ipos,mpi_double_precision,&amp;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                     <a class="code" href="namespacemympi.html#af24ff9c69dacd045d989d47842d0ffcf">root</a>,mpi_comm_world,ierr)</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;Absorption&quot;</span>,<span class="stringliteral">&quot;MPI_GATHERV RLocalUgImag&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      <span class="comment">!===================================== send out the full list to all cores</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="keyword">CALL </span>mpi_bcast(rugreal,iuniqueugs,mpi_double_precision,&amp;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                     <a class="code" href="namespacemympi.html#af24ff9c69dacd045d989d47842d0ffcf">root</a>,mpi_comm_world,ierr)</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      <span class="keyword">CALL </span>mpi_bcast(rugimag,iuniqueugs,mpi_double_precision,&amp;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                     <a class="code" href="namespacemympi.html#af24ff9c69dacd045d989d47842d0ffcf">root</a>,mpi_comm_world,ierr)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      <span class="comment">!=====================================</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      <span class="keywordflow">DO</span> ind=1,iuniqueugs</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        cugprime(ind)=cmplx(rugreal(ind),rugimag(ind))</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      <span class="comment">!--------------------------------------------------------------------  </span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      <span class="comment">! construct CUgMatPrime</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      <span class="keywordflow">DO</span> ind=1,iuniqueugs</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="comment">! number of this Ug</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        jnd=<a class="code" href="namespaceipara.html#aced1da6491258b042163e55f4231e905">iequivalentugkey</a>(ind)</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="comment">! Fill CUgMatPrime</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keywordflow">WHERE</span>(<a class="code" href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">isymmetryrelations</a>.EQ.jnd)</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;          cugmatprime = cugprime(ind)</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="keywordflow">        END WHERE</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="comment">! NB for imaginary potential U&#39;(g)=-U&#39;(-g)*</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordflow">WHERE</span>(<a class="code" href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">isymmetryrelations</a>.EQ.-jnd)</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;          cugmatprime = -conjg(cugprime(ind))</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordflow">        END WHERE</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    </div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="keywordflow">    CASE Default</span> <span class="comment">! Default case is no absorption</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    </div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="keywordflow">    END SELECT</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="comment">!--------------------------------------------------------------------  </span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="comment">! the final Ug matrix with absorption</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    cugmat = <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a> + cugmatprime </div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, <span class="stringliteral">&quot;Ug matrix, including absorption (nm^-2)&quot;</span> )</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">DO</span> ind = 1,40</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;      <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(3(I2,1X),A2,1X,8(F7.4,1X))&#39;</span>) nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(ind,:)),<span class="stringliteral">&quot;: &quot;</span>,100*cugmat(ind,1:4)</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, sprintstring )</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#add186c4b63f545bc1cec1d65317fd4fa">absorption</a></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#a474715ded1528587b5e199891234a860">getvgcontributionij</a>(RScatteringFactor,ind,jnd,CVgij,IErr) </div><div class="line"><a name="l00254"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#a474715ded1528587b5e199891234a860">  254</a></span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="comment">! ----&gt; CVgij, used to make/update CUgMatNoAbs</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="comment">! used each SimulateAndFit update scattering matrix Ug</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="comment">! used once felixrefine setup via StructureFactorInitialisation </span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemessage__mod.html">message_mod</a></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="comment">! global outputs</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="comment">! global inputs</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#ae62c03ed7743a867fb778bcb19a5e4b6">inatomsunitcell</a>,<a class="code" href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">iatomicnumber</a>,<a class="code" href="namespaceipara.html#af2e0ad210330d3d0d5e33b9c5dea9659">ianisodebyewallerfactorflag</a>,<a class="code" href="namespaceipara.html#adee5a4247435a83b19c439de4b1f3138">ianisodw</a></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>,<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>,<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>,<a class="code" href="namespacerpara.html#a52787d6e96b170221373591f4e1ef159">rvolume</a>, &amp;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;          <a class="code" href="namespacerpara.html#a51da34af20479323de36d5e2c2f334c0">ranisotropicdebyewallerfactortensor</a>,<a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>,<a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>, &amp;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;          <a class="code" href="namespacerpara.html#a536937282195ef9f91baa00ad0a2e605">rdebyewallerconstant</a>,<a class="code" href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rscattfactovolts</a></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacecpara.html">cpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">cimagone</a></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerconst.html">rconst</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerconst.html#a197d5b0781324ed2c51391b89387589f">rplanckconstant</a>,<a class="code" href="namespacerconst.html#abf3e0e151d78d15c709e9f2c6165075b">rangstromconversion</a>,<a class="code" href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">relectronmass</a>,<a class="code" href="namespacerconst.html#aa897c1c825282cfa362db0fb72b9b8ad">relectroncharge</a></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">INTENT(INOUT)</span> :: RScatteringFactor</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">INTENT(IN)</span> :: ind, jnd</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordtype">COMPLEX(CKIND)</span>,<span class="keywordtype">INTENT(OUT)</span> :: CVgij</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">INTENT(OUT)</span> :: IErr</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordtype">COMPLEX(CKIND)</span> :: CFpseudo</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: knd, INumPseudAtoms=0</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    </div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    cvgij = <a class="code" href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">czero</a><span class="comment">!this is in Volts</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="comment">! Sums CVgij contribution from each atom and pseudoatom</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">DO</span> knd=1,<a class="code" href="namespaceipara.html#ae62c03ed7743a867fb778bcb19a5e4b6">inatomsunitcell</a></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;      icurrentz = <a class="code" href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">iatomicnumber</a>(knd) <span class="comment">! atomic number, Z, NB passed as a global variable for absorption</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      <span class="keywordflow">IF</span> (icurrentz.LT.105) <span class="keywordflow">THEN</span> <span class="comment">! It&#39;s not a pseudoatom</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="comment">! Get scattering factor</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#ab4c81d3ea03906bd1c3870d569ef8424">atomicscatteringfactor</a>(rscatteringfactor,ierr)</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="comment">!IF (my_rank.EQ.0) PRINT*, knd,RCurrentGMagnitude,RScatteringFactor</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="comment">! Occupancy</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        rscatteringfactor = rscatteringfactor*<a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>(knd)</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <span class="comment">! Isotropic Debye-Waller factor</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#af2e0ad210330d3d0d5e33b9c5dea9659">ianisodebyewallerfactorflag</a>.EQ.0) <span class="keywordflow">THEN</span> </div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;          <span class="keywordflow">IF</span>(<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(knd).GT.10.OR.<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(knd).LT.0) <a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(knd) = <a class="code" href="namespacerpara.html#a536937282195ef9f91baa00ad0a2e605">rdebyewallerconstant</a><span class="comment">!use default in felix.inp for unrealistic values in the cif</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;          <span class="comment">! Isotropic D-W factor</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;          <span class="comment">! exp(-B sin(theta)^2/lamda^2) = exp(-Bs^2) = exp(-Bg^2/16pi^2), see e.g. Bird&amp;King</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;          rscatteringfactor = rscatteringfactor*exp(-<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(knd) * &amp;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                (<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>**2)/(<a class="code" href="namespacemynumbers.html#a6ac8a693759aee2814707afa2bd31c9f">four</a>*<a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a>**2) )</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <span class="keywordflow">ELSE</span> <span class="comment">! anisotropic Debye-Waller factor</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;          <span class="comment">!?? this will need sorting out, may not work</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;          rscatteringfactor = rscatteringfactor * &amp;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                exp( -dot_product( <a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(ind,jnd,:), &amp;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                matmul(<a class="code" href="namespacerpara.html#a51da34af20479323de36d5e2c2f334c0">ranisotropicdebyewallerfactortensor</a>(<a class="code" href="namespaceipara.html#adee5a4247435a83b19c439de4b1f3138">ianisodw</a>(knd),:,:),&amp;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                <a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(ind,jnd,:)) ) )</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="comment">! The structure factor equation, complex Vg(ind,jnd)=sum(f*exp(-ig.r)) in Volts</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        cvgij=cvgij+rscatteringfactor*<a class="code" href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rscattfactovolts</a>*exp(-<a class="code" href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">cimagone</a>*dot_product(<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(ind,jnd,:),&amp;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;              <a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>(knd,:)) )</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      <span class="keywordflow">ELSE</span> <span class="comment">! pseudoatom</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        inumpseudatoms=inumpseudatoms+1</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#adbada2b45121e0cc2db9f126d4da6f17">pseudoatom</a>(cfpseudo,ind,jnd,inumpseudatoms,ierr)</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="comment">! Occupancy</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        cfpseudo = cfpseudo*<a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>(knd)</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        <span class="comment">! Error check: only isotropic Debye-Waller for pseudoatoms currently</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#af2e0ad210330d3d0d5e33b9c5dea9659">ianisodebyewallerfactorflag</a>.NE.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Pseudo atom - isotropic Debye-Waller factor only!&quot;</span>)</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;          ierr=1</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;          <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <span class="comment">!?? DW factor: Need to work out how to get it from the REAL atom at same site</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="comment">! assume it is the next atom in the list, for now</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        cfpseudo = cfpseudo*exp(-<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(knd+1)*(<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>**2)/(<a class="code" href="namespacemynumbers.html#a6ac8a693759aee2814707afa2bd31c9f">four</a>*<a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a>**2) )</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        </div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        cvgij = cvgij + cfpseudo * &amp;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;              exp(-<a class="code" href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">cimagone</a>*dot_product(<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(ind,jnd,:), <a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>(knd,:)) )</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="keywordflow">    ENDDO</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#a474715ded1528587b5e199891234a860">getvgcontributionij</a></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#aefbfaa87735de589ffff68e6d7faaa86">structurefactorinitialisation</a>(IErr)</div><div class="line"><a name="l00341"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#aefbfaa87735de589ffff68e6d7faaa86">  341</a></span>&#160;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="comment">! sets up pseudoatoms,CUgMatNoAbs, mean inner potential,IEquivalentUgKey  </span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemessage__mod.html">message_mod</a></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemyfftw.html">myfftw</a></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceutilities__mod.html">utilities_mod</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceutilities__mod.html#a83141a0af6980a17e7c19d75bd978311">gaussian</a>, <a class="code" href="namespaceutilities__mod.html#a641423e4d5641b454aa83d103960153e">lorentzian</a>, <a class="code" href="namespaceutilities__mod.html#a8f7f53cf13182ea6a9d69bc979850808">resortugs</a></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="comment">! global outputs</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacecpara.html">cpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>,<a class="code" href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cugmatprime</a>,<a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>,<a class="code" href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpseudoatom</a>,<a class="code" href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpseudoscatt</a></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>, <a class="code" href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">isymmetryrelations</a></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#ad436575fe72edabf3ccd27c824c345ee">rmeaninnerpotential</a>,<a class="code" href="namespacerpara.html#a9d1675bd0647c4bdb98816ea5d62623f">rgsummat</a></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceblochpara.html">blochpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceblochpara.html#ad7128c5fd60af08b5eefac99c9d7976c">rbigk</a></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="comment">! global inputs</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#af2e0ad210330d3d0d5e33b9c5dea9659">ianisodebyewallerfactorflag</a>,<a class="code" href="namespaceipara.html#a2619ac66077b12f37446261601018738">iinitialsimulationflag</a>,<a class="code" href="namespaceipara.html#ae62c03ed7743a867fb778bcb19a5e4b6">inatomsunitcell</a>,&amp;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;          <a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">iatomicnumber</a>,<a class="code" href="namespaceipara.html#aced1da6491258b042163e55f4231e905">iequivalentugkey</a>,&amp;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;          <a class="code" href="namespaceipara.html#adee5a4247435a83b19c439de4b1f3138">ianisodw</a></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : rangstromconversion,relectroncharge,relectronmass,&amp;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;          <a class="code" href="namespacerpara.html#a339178d3a4919cad9490211dc57bae40">rrelativisticcorrection</a>,<a class="code" href="namespacerpara.html#a52787d6e96b170221373591f4e1ef159">rvolume</a>,<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>,<a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>,<a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>,&amp;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;          <a class="code" href="namespacerpara.html#abc550cca4c99bd31b505746288b104d4">relectronwavevectormagnitude</a>,<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>,<a class="code" href="namespacerpara.html#a536937282195ef9f91baa00ad0a2e605">rdebyewallerconstant</a>,rtolerance,&amp;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;          <a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>,<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>,<a class="code" href="namespacerpara.html#a51da34af20479323de36d5e2c2f334c0">ranisotropicdebyewallerfactortensor</a>,<a class="code" href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rscattfactovolts</a>,&amp;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;          <a class="code" href="namespacerpara.html#a6cb4ca3b46d5b0c45b8cf13a82d55986">rlengthx</a>,<a class="code" href="namespacerpara.html#a47d963f4545c0874e2f088de604007a9">rlengthy</a>,<a class="code" href="namespacerpara.html#a39325df9a7a8ea72c4a6b313ccb1e5a1">rlengthz</a></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceichannels.html">ichannels</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerconst.html">rconst</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerconst.html#a197d5b0781324ed2c51391b89387589f">rplanckconstant</a></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">! global should be local to Ug.f90</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>,<a class="code" href="namespacerpara.html#aa9b4dd990d8bf0aad278aa432c06c0ae">rpscale</a></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;          </div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: ind,jnd,knd,lnd,mnd,oddindlorentz,evenindlorentz,&amp;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;          oddindgauss,evenindgauss,currentatom,IErr,Iuid,Iplan_forward,IPseudo</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">DIMENSION(2)</span> :: IPos,ILoc</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordtype">COMPLEX(CKIND)</span> :: CVgij,CFpseudo</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: RMeanInnerPotentialVolts,RScatteringFactor,&amp;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;          RPMag,Rx,Ry,Rr,RPalpha,RTheta,Rfold</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordtype">CHARACTER*200</span> :: SPrintString</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    </div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="comment">! count pseudoatoms &amp; allocate pseudoatom arrays</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="comment">! count Pseudoatoms</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    ipseudo=0</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">DO</span> jnd=1,inatomsunitcell</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;      <span class="keywordflow">IF</span> (iatomicnumber(jnd).GE.105) ipseudo = ipseudo + 1</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      <span class="comment">! calculate pseudo potential and pseudo factor for any pseudoatoms</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">IF</span> (ipseudo.GT.0) then<span class="comment">!Calculate pseudoatom potentials</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;      <span class="comment">! size of the array used to calculate the pseudoatom FFT, global variable  </span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;      <a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>=1024 <span class="comment">! must be an EVEN number (preferably 2^n)!</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;      <span class="comment">! matrices with Pseudoatom potentials (REAL space)  </span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;      <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpseudoatom</a>(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>,<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>,ipseudo),stat=ierr)</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;StructureFactorInitialisation&quot;</span>,<span class="stringliteral">&quot;allocate CPseudoAtom&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;      <span class="comment">! matrices with Pseudoatom scattering factor (reciprocal space)</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpseudoscatt</a>(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>,<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>,ipseudo),stat=ierr)</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;StructureFactorInitialisation&quot;</span>,<span class="stringliteral">&quot;allocate CPseudoScatt&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;      <a class="code" href="namespacerpara.html#aa9b4dd990d8bf0aad278aa432c06c0ae">rpscale</a> = 0.01 <span class="comment">! one picometre per pixel, working in Angstroms</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      <span class="comment">! Magnitude of pseudoatom potential, in volts</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;      rpmag = 0.01815 <span class="comment">! set such that a Ja gives the same Ug matrix as a hydrogen atom</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;      mnd = 0 <span class="comment">! pseudoatom counter</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">DO</span> lnd=1,inatomsunitcell </div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;          <span class="keywordflow">IF</span> (iatomicnumber(lnd).GE.105) <span class="keywordflow">THEN</span> <span class="comment">! we have a pseudoatom</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;          <span class="comment">! intialise pseudoatom variables</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;          mnd=mnd+1</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;          <span class="comment">! The Debye-Waller factor is used to determine alpha for pseudoatoms</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;          rpalpha=10.0*risodw(lnd)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;          <span class="keywordflow">IF</span> (iatomicnumber(lnd).EQ.105) rfold=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>   <span class="comment">!Ja</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;          <span class="keywordflow">IF</span> (iatomicnumber(lnd).EQ.106) rfold=<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>    <span class="comment">!Jb</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;          <span class="keywordflow">IF</span> (iatomicnumber(lnd).EQ.107) rfold=<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>    <span class="comment">!Jc</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;          <span class="keywordflow">IF</span> (iatomicnumber(lnd).EQ.108) rfold=<a class="code" href="namespacemynumbers.html#adb56c5b8455aec4b975cac5fd4577755">three</a>  <span class="comment">!Jd</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;          <span class="keywordflow">IF</span> (iatomicnumber(lnd).EQ.109) rfold=<a class="code" href="namespacemynumbers.html#a6ac8a693759aee2814707afa2bd31c9f">four</a>   <span class="comment">!Je</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;          <span class="keywordflow">IF</span> (iatomicnumber(lnd).EQ.110) rfold=<a class="code" href="namespacemynumbers.html#a6b4c826c0f354d297730e322b74a4070">six</a>    <span class="comment">!Jf</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;          <span class="comment">! potential in REAL space</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;          <span class="keywordflow">DO</span> ind=1,<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            <span class="keywordflow">DO</span> jnd=1,<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a> <span class="comment">! x&amp;y run from e.g. -511.5 to +511.5 picometres</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;              rx=<a class="code" href="namespacerpara.html#aa9b4dd990d8bf0aad278aa432c06c0ae">rpscale</a>*(<span class="keywordtype">REAL</span>(ind-(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>/2))-HALF)</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;              ry=<a class="code" href="namespacerpara.html#aa9b4dd990d8bf0aad278aa432c06c0ae">rpscale</a>*(<span class="keywordtype">REAL</span>(jnd-(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>/2))-HALF)</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;              rr=sqrt(rx*rx+ry*ry)</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;              rtheta=acos(rx/rr)</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;              <span class="comment">!?? Easier to make a complex input to fftw rather than fanny around</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;              <span class="comment">!?? with the different format needed for a REAL input. Lazy.</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;              <a class="code" href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpseudoatom</a>(ind,jnd,mnd)=cmplx(rpmag*rpalpha*rr*exp(-rpalpha*rr) * &amp;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                  cos(rfold*rtheta),<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>)        </div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="keywordflow">            END DO</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordflow">          END DO</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;          <span class="comment">! output each pseudo potential .img to check</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;          <span class="keywordflow">IF</span> (my_rank.EQ.0) <span class="keywordflow">THEN</span> </div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;            <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A15,I1,A3)&#39;</span>) <span class="stringliteral">&quot;PseudoPotential&quot;</span>,mnd,<span class="stringliteral">&quot;.img&quot;</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;            <span class="keyword">OPEN</span>(unit=<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>, status= <span class="stringliteral">&#39;UNKNOWN&#39;</span>, file=sprintstring,&amp;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                  form=<span class="stringliteral">&#39;UNFORMATTED&#39;</span>,access=<span class="stringliteral">&#39;DIRECT&#39;</span>,iostat=ierr,recl=8192)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;StructureFactorInitialisation&quot;</span>,&amp;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                  <span class="stringliteral">&quot;WRITE a pseudo factor.img&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            <span class="keywordflow">DO</span> jnd = 1,<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;              <span class="keyword">WRITE</span>(<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>,rec=jnd) <span class="keywordtype">REAL</span>(<a class="code" href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpseudoatom</a>(jnd,:,mnd))</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="keywordflow">            END DO</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;            <span class="keyword">CLOSE</span>(<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>,iostat=ierr)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;          <span class="comment">! CPseudoScatt = a 2d fft of RPseudoAtom</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;          <span class="keyword">CALL </span>dfftw_plan_dft_2d_ ( iplan_forward, <a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>,<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>,&amp; </div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                <a class="code" href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpseudoatom</a>(:,:,mnd),<a class="code" href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpseudoscatt</a>(:,:,mnd),&amp;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                fftw_forward,fftw_estimate )</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;          <span class="keyword">CALL </span>dfftw_execute_ (iplan_forward)</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;          <span class="keyword">CALL </span>dfftw_destroy_plan_ (iplan_forward) <span class="comment">! could be moved to clean up?</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;          <span class="comment">! output each pseudo factor .img to check</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;          <span class="keywordflow">IF</span> (my_rank.EQ.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A12,I1,A3)&#39;</span>) <span class="stringliteral">&quot;PseudoFactor&quot;</span>,mnd,<span class="stringliteral">&quot;.img&quot;</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            <span class="keyword">OPEN</span>(unit=<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>, status= <span class="stringliteral">&#39;UNKNOWN&#39;</span>, file=sprintstring,&amp;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                form=<span class="stringliteral">&#39;UNFORMATTED&#39;</span>,access=<span class="stringliteral">&#39;DIRECT&#39;</span>,iostat=ierr,recl=8192)</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;StructureFactorInitialisation&quot;</span>,&amp;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                <span class="stringliteral">&quot;WRITE a pseudo factor.img&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            <span class="keywordflow">DO</span> jnd = 1,<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;              <span class="keyword">WRITE</span>(<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>,rec=jnd) abs(<a class="code" href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpseudoscatt</a>(jnd,:,mnd))</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="keywordflow">            END DO</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;            <span class="keyword">CLOSE</span>(<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>,iostat=ierr)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="comment">! calculate Ug matrix (excluding absorption)</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="comment">! fill lower diagonal of Ug matrix(excluding absorption) with Fourier components of the potential Vg</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a> = <a class="code" href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">czero</a> <span class="comment">! </span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordflow">DO</span> ind=2,nreflections</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      <span class="keywordflow">DO</span> jnd=1,ind-1</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a> = rgmatrixmagnitude(ind,jnd) <span class="comment">! g-vector magnitude, global variable</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="comment">! Sums CVgij contribution from each atom and pseudoatom in Volts</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#a474715ded1528587b5e199891234a860">getvgcontributionij</a>(rscatteringfactor,ind,jnd,cvgij,ierr)</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>(ind,jnd)=cvgij</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keywordflow">    ENDDO</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">!Convert to Ug</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>=<a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>*<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*relectronmass*rrelativisticcorrection*relectroncharge/((<a class="code" href="namespacerconst.html#a197d5b0781324ed2c51391b89387589f">rplanckconstant</a>**2)*(rangstromconversion**2))</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="comment">! NB Only the lower half of the Vg matrix was calculated, this completes the upper half</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <a class="code" href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cugmatprime</a> = transpose(<a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>)<span class="comment">! Prime is usually the absorptive potential, here just used as a box to avoid the bug when conj(transpose) is used</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a> = <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a> + conjg(<a class="code" href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cugmatprime</a>)</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <a class="code" href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cugmatprime</a> = <a class="code" href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">czero</a></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <span class="comment">! set diagonals to zero</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="comment">!DO ind=1,nReflections</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="comment">!  CUgMatNoAbs(ind,ind)=CZERO</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    <span class="comment">!END DO</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, <span class="stringliteral">&quot;Ug matrix, without absorption (nm^-2)&quot;</span> )<span class="comment">!LM, dbg3</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    <span class="keywordflow">DO</span> ind = 1,16</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(3(I2,1X),A2,1X,8(F7.4,1X))&#39;</span>) nint(rhkl(ind,:)),<span class="stringliteral">&quot;: &quot;</span>,100*<a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>(ind,1:4)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, sprintstring)</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;   </div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">! calculate mean inner potential and wave vector magnitude</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="comment">! calculate the mean inner potential as the sum of scattering factors</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="comment">! at g=0 multiplied by h^2/(2pi*m0*e*CellVolume)</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    rmeaninnerpotential=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="keywordflow">DO</span> ind=1,inatomsunitcell</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;      icurrentz = iatomicnumber(ind)</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;      <span class="keywordflow">IF</span>(icurrentz.LT.105) <span class="keywordflow">THEN</span> <span class="comment">! It&#39;s not a pseudoatom</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#ab4c81d3ea03906bd1c3870d569ef8424">atomicscatteringfactor</a>(rscatteringfactor,ierr)</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, <span class="stringliteral">&quot;Atom &quot;</span>,ind)</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, <span class="stringliteral">&quot;f(theta) at g=0 &quot;</span>,rscatteringfactor)</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        rmeaninnerpotential = rmeaninnerpotential+rscatteringfactor</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    rmeaninnerpotential = rmeaninnerpotential*rscattfactovolts</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A21,F6.2,A6)&#39;</span>) <span class="stringliteral">&quot;Mean inner potential &quot;</span>,rmeaninnerpotential,<span class="stringliteral">&quot; Volts&quot;</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    sprintstring=trim(adjustl(sprintstring))</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,sprintstring)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="comment">! Wave vector magnitude in crystal</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="comment">! high-energy approximation (not HOLZ compatible)</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="comment">! K^2=k^2+U0</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <a class="code" href="namespaceblochpara.html#ad7128c5fd60af08b5eefac99c9d7976c">rbigk</a>= sqrt(relectronwavevectormagnitude**2 + <span class="keywordtype">REAL</span>(<a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>(1,1)))</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, <span class="stringliteral">&quot;K (Angstroms) = &quot;</span>,<a class="code" href="namespaceblochpara.html#ad7128c5fd60af08b5eefac99c9d7976c">rbigk</a> )</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="comment">!?? does this match Acta Cryst. (1998). A54, 388-398 equation (3)</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    </div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="keywordflow">IF</span> (iinitialsimulationflag.EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      <span class="comment">! count equivalent Ugs</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;      </div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;      <span class="comment">! IEquivalentUgKey is used later in absorption case 2 Bird &amp; king</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      rgsummat = <a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;      <span class="comment">! equivalent Ug&#39;s are identified by abs(h)+abs(k)+abs(l)+a*h^2+b*k^2+c*l^2...</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;      <span class="keywordflow">DO</span> ind = 1,nreflections</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keywordflow">DO</span> jnd = 1,ind</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;          rgsummat(ind,jnd)=abs(rhkl(ind,1)-rhkl(jnd,1))+abs(rhkl(ind,2)-rhkl(jnd,2))+abs(rhkl(ind,3)-rhkl(jnd,3))+ &amp;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;            rlengthx*(rhkl(ind,1)-rhkl(jnd,1))**<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>+rlengthy*(rhkl(ind,2)-rhkl(jnd,2))**<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>+ &amp;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            rlengthz*(rhkl(ind,3)-rhkl(jnd,3))**<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="keywordflow">        END DO</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;      <span class="comment">! it&#39;s symmetric</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      rgsummat = rgsummat+transpose(rgsummat)</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, <span class="stringliteral">&quot;hkl: g Sum matrix&quot;</span> )</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <span class="keywordflow">DO</span> ind =1,16</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(3(I2,1X),A2,1X,12(F6.1,1X))&#39;</span>) nint(rhkl(ind,:)),<span class="stringliteral">&quot;: &quot;</span>,rgsummat(ind,1:12)</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, sprintstring )<span class="comment">!LM, dbg3</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      isymmetryrelations = 0_ikind </div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      iuid = 0_ikind </div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      <span class="keywordflow">DO</span> jnd = 1,nreflections</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <span class="keywordflow">DO</span> ind = 1,nreflections</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;          <span class="keywordflow">IF</span>(isymmetryrelations(ind,jnd).NE.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            cycle</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;          <span class="keywordflow">ELSE</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            iuid = iuid + 1_ikind</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            <span class="comment">! fill the symmetry relation matrix with incrementing numbers</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            <span class="comment">! that have the sign of the imaginary part</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="keywordflow">WHERE</span> (abs(rgsummat-rgsummat(ind,jnd)).LE.rtolerance)</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;              isymmetryrelations = iuid*sign(1_ikind,nint(aimag(<a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>)/(<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>)))</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="keywordflow">            END WHERE</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">        END DO</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;      <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(I5,A25)&#39;</span>) iuid,<span class="stringliteral">&quot; unique structure factors&quot;</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;      sprintstring=trim(adjustl(sprintstring))</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, sprintstring )</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, <span class="stringliteral">&quot;hkl: symmetry matrix&quot;</span> )</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;      <span class="keywordflow">DO</span> ind =1,16</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(3(I2,1X),A2,1X,16(I4,1X))&#39;</span>) nint(rhkl(ind,:)),<span class="stringliteral">&quot;: &quot;</span>,isymmetryrelations(ind,1:16)</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, sprintstring )</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      <span class="comment">! link each key with its Ug, from 1 to the number of unique Ug&#39;s Iuid</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      <span class="keyword">ALLOCATE</span>(iequivalentugkey(iuid),stat=ierr)</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;StructureFactorInitialisation&quot;</span>,<span class="stringliteral">&quot;allocate IEquivalentUgKey&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;      <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>(iuid),stat=ierr)</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;StructureFactorInitialisation&quot;</span>,<span class="stringliteral">&quot;allocate CUniqueUg&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;      <span class="keywordflow">DO</span> ind = 1,iuid</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        iloc = minloc(abs(isymmetryrelations-ind))</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        iequivalentugkey(ind) = ind</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>(ind) = <a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>(iloc(1),iloc(2))</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;      <span class="comment">! put them in descending order of magnitude</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;      <span class="comment">! IEquivalentUgKey is used later in absorption case 2 Bird &amp; king  </span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespaceutilities__mod.html#a8f7f53cf13182ea6a9d69bc979850808">resortugs</a>(iequivalentugkey,<a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>,iuid) <span class="comment">! modifies those arrays</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    </div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#aefbfaa87735de589ffff68e6d7faaa86">structurefactorinitialisation</a></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  </div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keyword">  SUBROUTINE  </span><a class="code" href="namespaceug__matrix__mod.html#ab4c81d3ea03906bd1c3870d569ef8424">atomicscatteringfactor</a>(RScatteringFactor,IErr)  </div><div class="line"><a name="l00606"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#ab4c81d3ea03906bd1c3870d569ef8424">  606</a></span>&#160;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceutilities__mod.html">utilities_mod</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceutilities__mod.html#a83141a0af6980a17e7c19d75bd978311">gaussian</a>, <a class="code" href="namespaceutilities__mod.html#a641423e4d5641b454aa83d103960153e">lorentzian</a></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="comment">! global inputs</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>, <a class="code" href="namespaceipara.html#afc4f119295fdea846160e89888095a6d">iscatterfactormethodflag</a></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>, <a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    </div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">INTENT(OUT)</span> :: RScatteringFactor</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: ind,jnd,knd,IErr</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    </div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="comment">! select scattering factor method</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    rscatteringfactor = <a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordflow">SELECT CASE</span> (<a class="code" href="namespaceipara.html#afc4f119295fdea846160e89888095a6d">iscatterfactormethodflag</a>)</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            </div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="keywordflow">CASE</span>(0) <span class="comment">! Kirkland Method using 3 Gaussians and 3 Lorentzians</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      <span class="comment">! NB Kirkland scattering factor is in Angstrom units</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      <span class="comment">! NB atomic number and g-vector passed as global variables</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;      rscatteringfactor = <a class="code" href="namespaceug__matrix__mod.html#abdf96d7501ffb06eb806d0b0c78a3f49">kirkland</a>(<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>)</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        </div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="keywordflow">CASE</span>(1) <span class="comment">! 8 Parameter Method with Scattering Parameters from Peng et al 1996 </span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      <span class="keywordflow">DO</span> ind = 1,4</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        <span class="comment">! Peng Method uses summation of 4 Gaussians</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        rscatteringfactor = rscatteringfactor + &amp;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;          <a class="code" href="namespaceutilities__mod.html#a83141a0af6980a17e7c19d75bd978311">gaussian</a>(<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,ind),<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>,<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>, &amp; </div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;          sqrt(2/<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,ind+4)),<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    </div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keywordflow">CASE</span>(2) <span class="comment">! 8 Parameter Method with Scattering Parameters from Doyle and Turner Method (1968)</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;      <span class="keywordflow">DO</span> ind = 1,4</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        jnd = ind*2</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        knd = ind*2 -1</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="comment">! Doyle &amp;Turner uses summation of 4 Gaussians</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        rscatteringfactor = rscatteringfactor + &amp;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;          <a class="code" href="namespaceutilities__mod.html#a83141a0af6980a17e7c19d75bd978311">gaussian</a>(<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,knd),<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>,<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>, &amp; </div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;          sqrt(2/<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,jnd)),<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>)</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        </div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keywordflow">CASE</span>(3) <span class="comment">! 10 Parameter method with Scattering Parameters from Lobato et al. 2014</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;      <span class="comment">!?? update github wiki</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;      <span class="keywordflow">DO</span> ind = 1,5</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        jnd=ind+5</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        rscatteringfactor = rscatteringfactor + &amp;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;          <a class="code" href="namespaceutilities__mod.html#a641423e4d5641b454aa83d103960153e">lorentzian</a>(<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,ind)* &amp;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;         (<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>+<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,jnd)*(<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>**<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>)),<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>, &amp;</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;          <a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,jnd)*(<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>**<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>),<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>)</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="keywordflow">    END SELECT</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#ab4c81d3ea03906bd1c3870d569ef8424">atomicscatteringfactor</a></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#adbada2b45121e0cc2db9f126d4da6f17">pseudoatom</a>(CFpseudo,i,j,k,IErr)</div><div class="line"><a name="l00668"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#adbada2b45121e0cc2db9f126d4da6f17">  668</a></span>&#160;</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    <span class="comment">! Reads a scattering factor from the kth Stewart pseudoatom in CPseudoScatt </span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="comment">! RCurrentGMagnitude is passed as a global variable</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="comment">! IPsize is the size, RPscale the scale factor of:</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    <span class="comment">! the matrix holding the scattering factor, global variable</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="comment">! i and j give the location of the g-vector in the appropriate matrices</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">relectronwavelength</a>,<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>,<a class="code" href="namespacerpara.html#aa9b4dd990d8bf0aad278aa432c06c0ae">rpscale</a>,<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacecpara.html">cpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpseudoscatt</a></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    </div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    </div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="keywordtype">COMPLEX(CKIND)</span>,<span class="keywordtype">INTENT(OUT)</span> :: CFpseudo</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: i,j,k,Ix,Iy,IErr</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: RPMag,Rx,Ry,Rr,Rtheta</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keywordflow">IF</span> (<a class="code" href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">relectronwavelength</a>*abs(<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>)*<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>)*RPscale/TWOPI.GE.ONE) then</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;      <span class="comment">! g vector is out of range of the fft</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;      cfpseudo=<a class="code" href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">czero</a></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">ELSE</span> <span class="comment">! Find the pixel corresponding to g</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      ix=nint(<a class="code" href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">relectronwavelength</a>*<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(i,j,1) * &amp;</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            <span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>)*<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>)*RPscale/(<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*twopi))</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      iy=nint(<a class="code" href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">relectronwavelength</a>*<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(i,j,2) * &amp;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>)*<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a>)*RPscale/(<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*twopi))</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      <span class="comment">! fft has the origin at [0,0], negative numbers wrap around from edges</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;      <span class="keywordflow">IF</span> (ix.LE.0) ix=ix+<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a> </div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;      <span class="keywordflow">IF</span> (iy.LE.0) iy=iy+<a class="code" href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipsize</a></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      cfpseudo=<a class="code" href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpseudoscatt</a>(ix,iy,k)</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    </div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#adbada2b45121e0cc2db9f126d4da6f17">pseudoatom</a></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="keyword">  FUNCTION </span><a class="code" href="namespaceug__matrix__mod.html#abdf96d7501ffb06eb806d0b0c78a3f49">kirkland</a>(Rg)</div><div class="line"><a name="l00711"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#abdf96d7501ffb06eb806d0b0c78a3f49">  711</a></span>&#160;    <span class="comment">! used in each (case 0 Kirkland) AtomicScatteringFactor</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="comment">! used in each (case 2 Bird &amp; King) absorption via BirdKing</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <span class="comment">! From Appendix C of Kirkland, &quot;Advanced Computing in Electron Microscopy&quot;, 2nd ed.</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="comment">! ICurrentZ is atomic number, passed as a global variable</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="comment">! Rg is magnitude of scattering vector in 1/A</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    <span class="comment">! (NB exp(-i*g.r), physics negative convention), global variable</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <span class="comment">! Kirkland scattering factor is in Angstrom units</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="comment">! global inputs</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a> </div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordtype">use </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    </div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    </div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: ind,IErr</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: Kirkland,Ra,Rb,Rc,Rd,Rq,Rg</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="comment">! NB Kirkland scattering factors are calculated in the optics convention exp(2*pi*i*q.r)</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    rq = rg / <a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    kirkland=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="comment">! Equation C.15</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordflow">DO</span> ind = 1,3</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;      ra=<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,ind*2-1);</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;      rb=<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,ind*2);</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;      rc=<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,ind*2+5);</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;      rd=<a class="code" href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rscattfactors</a>(<a class="code" href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">icurrentz</a>,ind*2+6);</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;      kirkland = kirkland + ra/((rq**2)+rb) + rc*exp(-(rd*rq**2))</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    </div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keyword">  END FUNCTION </span><a class="code" href="namespaceug__matrix__mod.html#abdf96d7501ffb06eb806d0b0c78a3f49">kirkland</a></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#a5177d1f0166d49e5e8049a2b497f2a12">doubleintegratebk</a>(RResult,IErr) </div><div class="line"><a name="l00753"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#a5177d1f0166d49e5e8049a2b497f2a12">  753</a></span>&#160;    <span class="comment">! used in each (case 2 Bird &amp; King) absorption</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemessage__mod.html">message_mod</a></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>, <span class="keywordtype">PARAMETER</span> :: inf=1</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>, <span class="keywordtype">PARAMETER</span> :: limit=500</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>, <span class="keywordtype">PARAMETER</span> :: lenw= limit*4</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: IErr,Ieval,last, iwork(limit)</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: RAccuracy,RError,RResult,dd</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: work(lenw)</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    </div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    dd=1.0 <span class="comment">! Do I need this? what does it do?</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    raccuracy=0.00000001d0 <span class="comment">! accuracy of integration</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="comment">! use single integration IntegrateBK as an external function of one variable</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="comment">! Quadpack integration 0 to infinity</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="keyword">CALL </span><a class="code" href="quadpack__double_8f90.html#aa62896aeb27d272531de002660a33d3c">dqagi</a>(<a class="code" href="namespaceug__matrix__mod.html#a16f7ba9fe4c5cb2faf8bdaf12462de4b">integratebk</a>,<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>,inf,0,raccuracy,rresult,rerror,ieval,ierr,&amp;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;         limit, lenw, last, iwork, work )</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="comment">! The integration required is actually -inf to inf in 2 dimensions</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="comment">! We used symmetry to just do 0 to inf, so multiply by 4</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    rresult=rresult*4</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    </div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="namespaceug__matrix__mod.html#a5177d1f0166d49e5e8049a2b497f2a12">doubleintegratebk</a></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="keyword">  FUNCTION </span><a class="code" href="namespaceug__matrix__mod.html#a16f7ba9fe4c5cb2faf8bdaf12462de4b">integratebk</a>(Sy) </div><div class="line"><a name="l00788"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#a16f7ba9fe4c5cb2faf8bdaf12462de4b">  788</a></span>&#160;    <span class="comment">! used in each (case 2 Bird &amp; King) absorption (indirectly)</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="comment">! &#39;CALL dqagi(IntegrateBK,---)&#39; each DoubleIntegrateBK</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#a06fa91af6c497dd65bbd3f0635e9769e">rsprimey</a></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: IErr,Ieval</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>, <span class="keywordtype">PARAMETER</span> :: inf = 1</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>, <span class="keywordtype">PARAMETER</span> :: limit = 500</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>, <span class="keywordtype">PARAMETER</span> :: lenw = limit*4</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: RAccuracy, RError, IntegrateBK, Sy</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> last, iwork(limit)</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> work(lenw)</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <a class="code" href="namespacerpara.html#a06fa91af6c497dd65bbd3f0635e9769e">rsprimey</a> = sy</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    raccuracy = 0.00000001d0 <span class="comment">! accuracy of integration</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="comment">! use BirdKing as an external function of one variable</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="comment">! Quadpack integration 0 to infinity</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="keyword">CALL </span><a class="code" href="quadpack__double_8f90.html#aa62896aeb27d272531de002660a33d3c">dqagi</a>(<a class="code" href="namespaceug__matrix__mod.html#aef03dbf532ff87ad9c8f8ccd2ade9a3d">birdking</a>,<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>,inf,0,raccuracy,integratebk,rerror,ieval,ierr,&amp;</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;         limit, lenw, last, iwork, work )</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    </div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="keyword">  END FUNCTION </span><a class="code" href="namespaceug__matrix__mod.html#a16f7ba9fe4c5cb2faf8bdaf12462de4b">integratebk</a></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;  <span class="comment">!!$%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="keyword">  FUNCTION </span><a class="code" href="namespaceug__matrix__mod.html#aef03dbf532ff87ad9c8f8ccd2ade9a3d">birdking</a>(RSprimeX)</div><div class="line"><a name="l00824"></a><span class="lineno"><a class="line" href="namespaceug__matrix__mod.html#aef03dbf532ff87ad9c8f8ccd2ade9a3d">  824</a></span>&#160;    <span class="comment">! used in each (case 2 Bird &amp; King) absorption (indirectly)</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="comment">! &#39;CALL dqagi(BirdKing,---)&#39; each IntegrateBK</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="comment">! From Bird and King, Acta Cryst A46, 202 (1990)</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="comment">! ICurrentZ is atomic number, global variable</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    <span class="comment">! RCurrentB is Debye-Waller constant b=8*pi*&lt;u^2&gt;, </span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="comment">! where u is mean square thermal vibration amplitude in Angstroms, global variable</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <span class="comment">! RCurrentGMagnitude is magnitude of scattering vector in 1/A </span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="comment">! NB exp(-i*g.r), physics negative convention, global variable</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="comment">! RSprime is dummy parameter for integration [s&#39;x s&#39;y]</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <span class="comment">! NB can&#39;t print from here as it is called EXTERNAL in Integrate</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="comment">! global inputs</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="keywordtype">USE </span><a class="code" href="namespacerpara.html">rpara</a><span class="keywordtype">, ONLY</span> : <a class="code" href="namespacerpara.html#a059f75f4839e9c616dc85dbe4418d234">rcurrentb</a>, <a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>, <a class="code" href="namespacerpara.html#a06fa91af6c497dd65bbd3f0635e9769e">rsprimey</a></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    </div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    </div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: ind</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>:: BirdKing, Rs, Rg1, Rg2, RsEff</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>, <span class="keywordtype">INTENT(IN)</span> :: RSprimeX</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(2)</span> :: RGprime</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    </div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="comment">! NB Kirkland scattering factors in optics convention</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    rgprime = 2 * <a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a> * [rsprimex,<a class="code" href="namespacerpara.html#a06fa91af6c497dd65bbd3f0635e9769e">rsprimey</a>]</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="comment">! Since [s&#39;x s&#39;y]  is a dummy parameter for integration I can assign s&#39;x //g</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    rg1 = sqrt( (<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>/2+rgprime(1))**2 + rgprime(2)**2 )</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    rg2 = sqrt( (<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>/2-rgprime(1))**2 + rgprime(2)**2 )</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    rseff = rsprimex**2+<a class="code" href="namespacerpara.html#a06fa91af6c497dd65bbd3f0635e9769e">rsprimey</a>**2-<a class="code" href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rcurrentgmagnitude</a>**2/(16*<a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a>**2)</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    birdking = <a class="code" href="namespaceug__matrix__mod.html#abdf96d7501ffb06eb806d0b0c78a3f49">kirkland</a>(rg1)*<a class="code" href="namespaceug__matrix__mod.html#abdf96d7501ffb06eb806d0b0c78a3f49">kirkland</a>(rg2)*(1-exp(-2*<a class="code" href="namespacerpara.html#a059f75f4839e9c616dc85dbe4418d234">rcurrentb</a>*rseff ) )</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    </div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="keyword">  END FUNCTION </span><a class="code" href="namespaceug__matrix__mod.html#aef03dbf532ff87ad9c8f8ccd2ade9a3d">birdking</a></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="keyword">END MODULE </span><a class="code" href="namespaceug__matrix__mod.html">ug_matrix_mod</a></div><div class="ttc" id="namespaceutilities__mod_html"><div class="ttname"><a href="namespaceutilities__mod.html">utilities_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="utilities__mod_8f90_source.html#l00036">utilities_mod.f90:36</a></div></div>
<div class="ttc" id="namespacerconst_html_abf3e0e151d78d15c709e9f2c6165075b"><div class="ttname"><a href="namespacerconst.html#abf3e0e151d78d15c709e9f2c6165075b">rconst::rangstromconversion</a></div><div class="ttdeci">real(rkind), parameter rangstromconversion</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespaceipara_html_adee5a4247435a83b19c439de4b1f3138"><div class="ttname"><a href="namespaceipara.html#adee5a4247435a83b19c439de4b1f3138">ipara::ianisodw</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable ianisodw</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00187">smodules.f90:187</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a63b53f58059e69a9ca811158132eb671"><div class="ttname"><a href="namespacemynumbers.html#a63b53f58059e69a9ca811158132eb671">mynumbers::cimagone</a></div><div class="ttdeci">complex(rkind), parameter cimagone</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00055">gmodules.f90:55</a></div></div>
<div class="ttc" id="namespacerpara_html_ac6e1b12192449367c347418574c2aaac"><div class="ttname"><a href="namespacerpara.html#ac6e1b12192449367c347418574c2aaac">rpara::relectronvelocity</a></div><div class="ttdeci">real(rkind) relectronvelocity</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacerconst_html_a77ee671bb619df43cd56811461facac8"><div class="ttname"><a href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">rconst::relectronmass</a></div><div class="ttdeci">real(rkind), parameter relectronmass</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespacerpara_html"><div class="ttname"><a href="namespacerpara.html">rpara</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00231">smodules.f90:231</a></div></div>
<div class="ttc" id="namespaceipara_html_aced1da6491258b042163e55f4231e905"><div class="ttname"><a href="namespaceipara.html#aced1da6491258b042163e55f4231e905">ipara::iequivalentugkey</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable iequivalentugkey</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00195">smodules.f90:195</a></div></div>
<div class="ttc" id="namespacemympi_html"><div class="ttname"><a href="namespacemympi.html">mympi</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00124">gmodules.f90:124</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_a474715ded1528587b5e199891234a860"><div class="ttname"><a href="namespaceug__matrix__mod.html#a474715ded1528587b5e199891234a860">ug_matrix_mod::getvgcontributionij</a></div><div class="ttdeci">subroutine, public getvgcontributionij(RScatteringFactor, ind, jnd, CVgij, IErr)</div><div class="ttdoc">Procedure-description: Calculate a single fourier components of the potential Vg for atoms and pseudo...</div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00254">ug_matrix_mod.f90:254</a></div></div>
<div class="ttc" id="namespacerpara_html_a06fa91af6c497dd65bbd3f0635e9769e"><div class="ttname"><a href="namespacerpara.html#a06fa91af6c497dd65bbd3f0635e9769e">rpara::rsprimey</a></div><div class="ttdeci">real(rkind) rsprimey</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00256">smodules.f90:256</a></div></div>
<div class="ttc" id="namespacerpara_html_a536937282195ef9f91baa00ad0a2e605"><div class="ttname"><a href="namespacerpara.html#a536937282195ef9f91baa00ad0a2e605">rpara::rdebyewallerconstant</a></div><div class="ttdeci">real(rkind) rdebyewallerconstant</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespacemympi_html_af24ff9c69dacd045d989d47842d0ffcf"><div class="ttname"><a href="namespacemympi.html#af24ff9c69dacd045d989d47842d0ffcf">mympi::root</a></div><div class="ttdeci">integer, parameter root</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00130">gmodules.f90:130</a></div></div>
<div class="ttc" id="namespacerpara_html_a059f75f4839e9c616dc85dbe4418d234"><div class="ttname"><a href="namespacerpara.html#a059f75f4839e9c616dc85dbe4418d234">rpara::rcurrentb</a></div><div class="ttdeci">real(rkind) rcurrentb</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00256">smodules.f90:256</a></div></div>
<div class="ttc" id="namespaceipara_html_afc4f119295fdea846160e89888095a6d"><div class="ttname"><a href="namespaceipara.html#afc4f119295fdea846160e89888095a6d">ipara::iscatterfactormethodflag</a></div><div class="ttdeci">integer(ikind) iscatterfactormethodflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespaceutilities__mod_html_a8f7f53cf13182ea6a9d69bc979850808"><div class="ttname"><a href="namespaceutilities__mod.html#a8f7f53cf13182ea6a9d69bc979850808">utilities_mod::resortugs</a></div><div class="ttdeci">subroutine resortugs(ISymmetryIntegers, CUgs, N)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="utilities__mod_8f90_source.html#l00140">utilities_mod.f90:140</a></div></div>
<div class="ttc" id="namespacecpara_html_aafee78324879785fd9f639bd433c23bc"><div class="ttname"><a href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpara::cpseudoatom</a></div><div class="ttdeci">complex(ckind), dimension(:,:,:), allocatable cpseudoatom</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00334">smodules.f90:334</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_aefbfaa87735de589ffff68e6d7faaa86"><div class="ttname"><a href="namespaceug__matrix__mod.html#aefbfaa87735de589ffff68e6d7faaa86">ug_matrix_mod::structurefactorinitialisation</a></div><div class="ttdeci">subroutine, public structurefactorinitialisation(IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00341">ug_matrix_mod.f90:341</a></div></div>
<div class="ttc" id="namespaceichannels_html"><div class="ttname"><a href="namespaceichannels.html">ichannels</a></div><div class="ttdoc">Module-description: Input and output channels. </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00362">smodules.f90:362</a></div></div>
<div class="ttc" id="quadpack__double_8f90_html_aa62896aeb27d272531de002660a33d3c"><div class="ttname"><a href="quadpack__double_8f90.html#aa62896aeb27d272531de002660a33d3c">dqagi</a></div><div class="ttdeci">subroutine dqagi(f, bound, inf, epsabs, epsrel, result, abserr, neval, ier, limit, lenw, last, iwork, work)</div><div class="ttdef"><b>Definition:</b> <a href="quadpack__double_8f90_source.html#l01178">quadpack_double.f90:1178</a></div></div>
<div class="ttc" id="namespacerpara_html_ad7ecaa7ef8d6f1ada5da6875346ac976"><div class="ttname"><a href="namespacerpara.html#ad7ecaa7ef8d6f1ada5da6875346ac976">rpara::rscattfactors</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rscattfactors</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00261">smodules.f90:261</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_ab4c81d3ea03906bd1c3870d569ef8424"><div class="ttname"><a href="namespaceug__matrix__mod.html#ab4c81d3ea03906bd1c3870d569ef8424">ug_matrix_mod::atomicscatteringfactor</a></div><div class="ttdeci">subroutine atomicscatteringfactor(RScatteringFactor, IErr)</div><div class="ttdoc">Procedure-description: Choose scattering factors using IScatterFactorMethodFLAG. </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00606">ug_matrix_mod.f90:606</a></div></div>
<div class="ttc" id="namespacecpara_html_ad5180d94d16b2d27f935a3fd8f473ed2"><div class="ttname"><a href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpara::cpseudoscatt</a></div><div class="ttdeci">complex(ckind), dimension(:,:,:), allocatable cpseudoscatt</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00334">smodules.f90:334</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a58e7d42c3fbc3ff54b387ea470e4ec67"><div class="ttname"><a href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">message_mod::dbg3</a></div><div class="ttdeci">type(msgtags) dbg3</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00201">message_mod.f90:201</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a782923fd3fc790ea0a52f32ed16d2ab5"><div class="ttname"><a href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">mynumbers::one</a></div><div class="ttdeci">real(rkind), parameter one</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespaceipara_html_a8df9db4bd56d00b01dbf96206f1e3338"><div class="ttname"><a href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">ipara::iatomicnumber</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable iatomicnumber</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00175">smodules.f90:175</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_a16f7ba9fe4c5cb2faf8bdaf12462de4b"><div class="ttname"><a href="namespaceug__matrix__mod.html#a16f7ba9fe4c5cb2faf8bdaf12462de4b">ug_matrix_mod::integratebk</a></div><div class="ttdeci">real(rkind) function integratebk(Sy)</div><div class="ttdoc">Procedure-description: Used as part of numerical integration to calculate absorptive form factor f&amp;#39; f...</div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00788">ug_matrix_mod.f90:788</a></div></div>
<div class="ttc" id="namespacerconst_html_a197d5b0781324ed2c51391b89387589f"><div class="ttname"><a href="namespacerconst.html#a197d5b0781324ed2c51391b89387589f">rconst::rplanckconstant</a></div><div class="ttdeci">real(rkind), parameter rplanckconstant</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespacerpara_html_ace58eb6ea2923f20fe329cb88d8f91e4"><div class="ttname"><a href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rpara::rgmatrixmagnitude</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rgmatrixmagnitude</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00287">smodules.f90:287</a></div></div>
<div class="ttc" id="namespacecpara_html_a8d69fd485c9166c98eccabb12182af55"><div class="ttname"><a href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cpara::cugmatnoabs</a></div><div class="ttdeci">complex(ckind), dimension(:,:), allocatable cugmatnoabs</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00331">smodules.f90:331</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_abdf96d7501ffb06eb806d0b0c78a3f49"><div class="ttname"><a href="namespaceug__matrix__mod.html#abdf96d7501ffb06eb806d0b0c78a3f49">ug_matrix_mod::kirkland</a></div><div class="ttdeci">real(rkind) function kirkland(Rg)</div><div class="ttdoc">Procedure-description: Returns a Kirkland scattering factor. </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00711">ug_matrix_mod.f90:711</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a956c73bb092dda3957965063393d991c"><div class="ttname"><a href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">mynumbers::two</a></div><div class="ttdeci">real(rkind), parameter two</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespaceipara_html_ae62c03ed7743a867fb778bcb19a5e4b6"><div class="ttname"><a href="namespaceipara.html#ae62c03ed7743a867fb778bcb19a5e4b6">ipara::inatomsunitcell</a></div><div class="ttdeci">integer(ikind) inatomsunitcell</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00189">smodules.f90:189</a></div></div>
<div class="ttc" id="namespaceipara_html_a4178ca9371949c00795220c776bf9d92"><div class="ttname"><a href="namespaceipara.html#a4178ca9371949c00795220c776bf9d92">ipara::iabsorbflag</a></div><div class="ttdeci">integer(ikind) iabsorbflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespaceipara_html"><div class="ttname"><a href="namespaceipara.html">ipara</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00151">smodules.f90:151</a></div></div>
<div class="ttc" id="namespacemympi_html_a596963d73195aa4cf33f7cf8d3239560"><div class="ttname"><a href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">mympi::my_rank</a></div><div class="ttdeci">integer(ikind) my_rank</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00129">gmodules.f90:129</a></div></div>
<div class="ttc" id="namespacecpara_html"><div class="ttname"><a href="namespacecpara.html">cpara</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00326">smodules.f90:326</a></div></div>
<div class="ttc" id="namespacemynumbers_html_af4fc12a8277bcb2b36bc43248b1fa1cd"><div class="ttname"><a href="namespacemynumbers.html#af4fc12a8277bcb2b36bc43248b1fa1cd">mynumbers::hundred</a></div><div class="ttdeci">real(rkind), parameter hundred</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespacerpara_html_a52787d6e96b170221373591f4e1ef159"><div class="ttname"><a href="namespacerpara.html#a52787d6e96b170221373591f4e1ef159">rpara::rvolume</a></div><div class="ttdeci">real(rkind) rvolume</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespacemynumbers_html_af4c9376fd4e698082245efc2fd7416fe"><div class="ttname"><a href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">mynumbers::tiny</a></div><div class="ttdeci">real(rkind) tiny</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00054">gmodules.f90:54</a></div></div>
<div class="ttc" id="namespacerpara_html_abc550cca4c99bd31b505746288b104d4"><div class="ttname"><a href="namespacerpara.html#abc550cca4c99bd31b505746288b104d4">rpara::relectronwavevectormagnitude</a></div><div class="ttdeci">real(rkind) relectronwavevectormagnitude</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacemessage__mod_html"><div class="ttname"><a href="namespacemessage__mod.html">message_mod</a></div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00034">message_mod.f90:34</a></div></div>
<div class="ttc" id="namespacerpara_html_a978f58fc9c3fbad2e3358d6723e5059d"><div class="ttname"><a href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rpara::rhkl</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rhkl</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00258">smodules.f90:258</a></div></div>
<div class="ttc" id="namespacerpara_html_a9c2af5aebf9f72fa157caa770d60ce13"><div class="ttname"><a href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">rpara::roccupancy</a></div><div class="ttdeci">real(rkind), dimension(:), allocatable roccupancy</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00240">smodules.f90:240</a></div></div>
<div class="ttc" id="namespaceichannels_html_ad296a36723368957d48d82a46df5d0b5"><div class="ttname"><a href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichannels::ichoutwiimage</a></div><div class="ttdeci">integer, parameter ichoutwiimage</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00369">smodules.f90:369</a></div></div>
<div class="ttc" id="namespacerpara_html_aa9b4dd990d8bf0aad278aa432c06c0ae"><div class="ttname"><a href="namespacerpara.html#aa9b4dd990d8bf0aad278aa432c06c0ae">rpara::rpscale</a></div><div class="ttdeci">real(rkind) rpscale</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00256">smodules.f90:256</a></div></div>
<div class="ttc" id="namespacerpara_html_aa6e33f58b9a58ec8271fa0a00f187fc7"><div class="ttname"><a href="namespacerpara.html#aa6e33f58b9a58ec8271fa0a00f187fc7">rpara::rabsorptionpercentage</a></div><div class="ttdeci">real(rkind) rabsorptionpercentage</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespaceipara_html_a2619ac66077b12f37446261601018738"><div class="ttname"><a href="namespaceipara.html#a2619ac66077b12f37446261601018738">ipara::iinitialsimulationflag</a></div><div class="ttdeci">integer(ikind) iinitialsimulationflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00168">smodules.f90:168</a></div></div>
<div class="ttc" id="namespacerpara_html_a339178d3a4919cad9490211dc57bae40"><div class="ttname"><a href="namespacerpara.html#a339178d3a4919cad9490211dc57bae40">rpara::rrelativisticcorrection</a></div><div class="ttdeci">real(rkind) rrelativisticcorrection</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacerpara_html_a8c9761c04f3578ddf07953c8c83f33df"><div class="ttname"><a href="namespacerpara.html#a8c9761c04f3578ddf07953c8c83f33df">rpara::rcurrentgmagnitude</a></div><div class="ttdeci">real(rkind) rcurrentgmagnitude</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00256">smodules.f90:256</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_ae398ebe57130cf5ef472717a97184d53"><div class="ttname"><a href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">message_mod::ls</a></div><div class="ttdeci">type(msgpriorities) ls</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00200">message_mod.f90:200</a></div></div>
<div class="ttc" id="interfacemessage__mod_1_1message_html"><div class="ttname"><a href="interfacemessage__mod_1_1message.html">message_mod::message</a></div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00144">message_mod.f90:144</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html"><div class="ttname"><a href="namespaceug__matrix__mod.html">ug_matrix_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00036">ug_matrix_mod.f90:36</a></div></div>
<div class="ttc" id="namespacerpara_html_a8e36d6af507d9c8a3678c311ab32b979"><div class="ttname"><a href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">rpara::relectronwavelength</a></div><div class="ttdeci">real(rkind) relectronwavelength</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a6aff313862cb947c1e0ba29dddeaf9b0"><div class="ttname"><a href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">mynumbers::twopi</a></div><div class="ttdeci">real(rkind) twopi</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00048">gmodules.f90:48</a></div></div>
<div class="ttc" id="namespaceutilities__mod_html_a641423e4d5641b454aa83d103960153e"><div class="ttname"><a href="namespaceutilities__mod.html#a641423e4d5641b454aa83d103960153e">utilities_mod::lorentzian</a></div><div class="ttdeci">real(rkind) function lorentzian(FWHM, x, x_0, offset)</div><div class="ttdoc">Procedure-description: Defines a Lorentzian Distribution for any parameter input. ...</div><div class="ttdef"><b>Definition:</b> <a href="utilities__mod_8f90_source.html#l00309">utilities_mod.f90:309</a></div></div>
<div class="ttc" id="namespacemympi_html_ac0410c4231c11381dc6f3809435b993f"><div class="ttname"><a href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">mympi::p</a></div><div class="ttdeci">integer(ikind) p</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00129">gmodules.f90:129</a></div></div>
<div class="ttc" id="namespacerpara_html_a51da34af20479323de36d5e2c2f334c0"><div class="ttname"><a href="namespacerpara.html#a51da34af20479323de36d5e2c2f334c0">rpara::ranisotropicdebyewallerfactortensor</a></div><div class="ttdeci">real(rkind), dimension(:,:,:), allocatable ranisotropicdebyewallerfactortensor</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00274">smodules.f90:274</a></div></div>
<div class="ttc" id="namespaceipara_html_a780d9ba54711b2405c115b9250fe243c"><div class="ttname"><a href="namespaceipara.html#a780d9ba54711b2405c115b9250fe243c">ipara::ipsize</a></div><div class="ttdeci">integer(ikind) ipsize</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00210">smodules.f90:210</a></div></div>
<div class="ttc" id="namespaceblochpara_html_ad7128c5fd60af08b5eefac99c9d7976c"><div class="ttname"><a href="namespaceblochpara.html#ad7128c5fd60af08b5eefac99c9d7976c">blochpara::rbigk</a></div><div class="ttdeci">real(rkind) rbigk</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00386">smodules.f90:386</a></div></div>
<div class="ttc" id="namespacemyfftw_html"><div class="ttname"><a href="namespacemyfftw.html">myfftw</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00140">gmodules.f90:140</a></div></div>
<div class="ttc" id="namespacemynumbers_html"><div class="ttname"><a href="namespacemynumbers.html">mynumbers</a></div><div class="ttdoc">Module-description: Some numeric computational and mathematical paramter constants as well as maths f...</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00039">gmodules.f90:39</a></div></div>
<div class="ttc" id="namespacemynumbers_html_af76db902418e20dbe03bca6471edcfcd"><div class="ttname"><a href="namespacemynumbers.html#af76db902418e20dbe03bca6471edcfcd">mynumbers::pi</a></div><div class="ttdeci">real(rkind) pi</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00048">gmodules.f90:48</a></div></div>
<div class="ttc" id="namespacerpara_html_a6cb4ca3b46d5b0c45b8cf13a82d55986"><div class="ttname"><a href="namespacerpara.html#a6cb4ca3b46d5b0c45b8cf13a82d55986">rpara::rlengthx</a></div><div class="ttdeci">real(rkind) rlengthx</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a222fbc4caf1099e925c1f952df880c2b"><div class="ttname"><a href="namespacemynumbers.html#a222fbc4caf1099e925c1f952df880c2b">mynumbers::czero</a></div><div class="ttdeci">complex(rkind), parameter czero</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00055">gmodules.f90:55</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a5cd27d8a0370b0f228dd54c51a761481"><div class="ttname"><a href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">mynumbers::zero</a></div><div class="ttdeci">real(rkind), parameter zero</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a6b4c826c0f354d297730e322b74a4070"><div class="ttname"><a href="namespacemynumbers.html#a6b4c826c0f354d297730e322b74a4070">mynumbers::six</a></div><div class="ttdeci">real(rkind), parameter six</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_aef03dbf532ff87ad9c8f8ccd2ade9a3d"><div class="ttname"><a href="namespaceug__matrix__mod.html#aef03dbf532ff87ad9c8f8ccd2ade9a3d">ug_matrix_mod::birdking</a></div><div class="ttdeci">real(rkind) function birdking(RSprimeX)</div><div class="ttdoc">Procedure-description: Used as part of numerical integration to calculate absorptive form factor f&amp;#39; f...</div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00824">ug_matrix_mod.f90:824</a></div></div>
<div class="ttc" id="namespaceblochpara_html"><div class="ttname"><a href="namespaceblochpara.html">blochpara</a></div><div class="ttdoc">Module-description: Eigen problem variables. </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00379">smodules.f90:379</a></div></div>
<div class="ttc" id="namespacemynumbers_html_adb56c5b8455aec4b975cac5fd4577755"><div class="ttname"><a href="namespacemynumbers.html#adb56c5b8455aec4b975cac5fd4577755">mynumbers::three</a></div><div class="ttdeci">real(rkind), parameter three</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespacerpara_html_ae5ce1aff41155b702b4313ac8af0ab82"><div class="ttname"><a href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">rpara::ratomcoordinate</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable ratomcoordinate</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00271">smodules.f90:271</a></div></div>
<div class="ttc" id="namespaceutilities__mod_html_a83141a0af6980a17e7c19d75bd978311"><div class="ttname"><a href="namespaceutilities__mod.html#a83141a0af6980a17e7c19d75bd978311">utilities_mod::gaussian</a></div><div class="ttdeci">real(rkind) function gaussian(height, x, peakcentre, standarddeviation, intercept)</div><div class="ttdoc">Procedure-description: Defines a Gaussian distribution for any parameter input. </div><div class="ttdef"><b>Definition:</b> <a href="utilities__mod_8f90_source.html#l00329">utilities_mod.f90:329</a></div></div>
<div class="ttc" id="namespacerpara_html_a60e0ebdfd9538d38bf140bd8ccdda637"><div class="ttname"><a href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rpara::rgmatrix</a></div><div class="ttdeci">real(rkind), dimension(:,:,:), allocatable rgmatrix</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00288">smodules.f90:288</a></div></div>
<div class="ttc" id="namespacerpara_html_a47d963f4545c0874e2f088de604007a9"><div class="ttname"><a href="namespacerpara.html#a47d963f4545c0874e2f088de604007a9">rpara::rlengthy</a></div><div class="ttdeci">real(rkind) rlengthy</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespaceipara_html_a37b853026542315a295df2e63a51dbd4"><div class="ttname"><a href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">ipara::isymmetryrelations</a></div><div class="ttdeci">integer(ikind), dimension(:,:), allocatable isymmetryrelations</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00194">smodules.f90:194</a></div></div>
<div class="ttc" id="namespaceipara_html_ad159cf79ceb8d3b646c0110467969418"><div class="ttname"><a href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">ipara::nreflections</a></div><div class="ttdeci">integer(ikind) nreflections</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00186">smodules.f90:186</a></div></div>
<div class="ttc" id="namespaceipara_html_af2e0ad210330d3d0d5e33b9c5dea9659"><div class="ttname"><a href="namespaceipara.html#af2e0ad210330d3d0d5e33b9c5dea9659">ipara::ianisodebyewallerfactorflag</a></div><div class="ttdeci">integer(ikind) ianisodebyewallerfactorflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespacerpara_html_aefec739ba942da517044c39761b42979"><div class="ttname"><a href="namespacerpara.html#aefec739ba942da517044c39761b42979">rpara::risodw</a></div><div class="ttdeci">real(rkind), dimension(:), allocatable risodw</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00240">smodules.f90:240</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_adbada2b45121e0cc2db9f126d4da6f17"><div class="ttname"><a href="namespaceug__matrix__mod.html#adbada2b45121e0cc2db9f126d4da6f17">ug_matrix_mod::pseudoatom</a></div><div class="ttdeci">subroutine pseudoatom(CFpseudo, i, j, k, IErr)</div><div class="ttdoc">Procedure-description: Returns a PseudoAtom scattering factor. </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00668">ug_matrix_mod.f90:668</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_ab1e3789e4680b59e9d81bd1d30e3f88a"><div class="ttname"><a href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">message_mod::lm</a></div><div class="ttdeci">type(msgpriorities) lm</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00200">message_mod.f90:200</a></div></div>
<div class="ttc" id="namespacecpara_html_a2e58cbe91faca3bbe004c6995f0a086e"><div class="ttname"><a href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cpara::cugmatprime</a></div><div class="ttdeci">complex(ckind), dimension(:,:), allocatable cugmatprime</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00331">smodules.f90:331</a></div></div>
<div class="ttc" id="namespacecpara_html_a587592c122334a3ab662dc0283313bc5"><div class="ttname"><a href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cpara::cuniqueug</a></div><div class="ttdeci">complex(ckind), dimension(:), allocatable cuniqueug</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00329">smodules.f90:329</a></div></div>
<div class="ttc" id="namespacerpara_html_a39325df9a7a8ea72c4a6b313ccb1e5a1"><div class="ttname"><a href="namespacerpara.html#a39325df9a7a8ea72c4a6b313ccb1e5a1">rpara::rlengthz</a></div><div class="ttdeci">real(rkind) rlengthz</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespacerpara_html_ad436575fe72edabf3ccd27c824c345ee"><div class="ttname"><a href="namespacerpara.html#ad436575fe72edabf3ccd27c824c345ee">rpara::rmeaninnerpotential</a></div><div class="ttdeci">real(rkind) rmeaninnerpotential</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00286">smodules.f90:286</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a6ac8a693759aee2814707afa2bd31c9f"><div class="ttname"><a href="namespacemynumbers.html#a6ac8a693759aee2814707afa2bd31c9f">mynumbers::four</a></div><div class="ttdeci">real(rkind), parameter four</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_a5177d1f0166d49e5e8049a2b497f2a12"><div class="ttname"><a href="namespaceug__matrix__mod.html#a5177d1f0166d49e5e8049a2b497f2a12">ug_matrix_mod::doubleintegratebk</a></div><div class="ttdeci">subroutine doubleintegratebk(RResult, IErr)</div><div class="ttdoc">Procedure-description: Used as part of numerical integration to calculate absorptive form factor f&amp;#39; f...</div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00753">ug_matrix_mod.f90:753</a></div></div>
<div class="ttc" id="namespacecpara_html_ab994df5c023832e6fbc15e15b5b28358"><div class="ttname"><a href="namespacecpara.html#ab994df5c023832e6fbc15e15b5b28358">cpara::cugmat</a></div><div class="ttdeci">complex(ckind), dimension(:,:), allocatable cugmat</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00331">smodules.f90:331</a></div></div>
<div class="ttc" id="namespacerconst_html_aa897c1c825282cfa362db0fb72b9b8ad"><div class="ttname"><a href="namespacerconst.html#aa897c1c825282cfa362db0fb72b9b8ad">rconst::relectroncharge</a></div><div class="ttdeci">real(rkind), parameter relectroncharge</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespacerpara_html_a89cf29de5c55a865bd717f19cc538f1d"><div class="ttname"><a href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rpara::rscattfactovolts</a></div><div class="ttdeci">real(rkind) rscattfactovolts</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00286">smodules.f90:286</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_add186c4b63f545bc1cec1d65317fd4fa"><div class="ttname"><a href="namespaceug__matrix__mod.html#add186c4b63f545bc1cec1d65317fd4fa">ug_matrix_mod::absorption</a></div><div class="ttdeci">subroutine, public absorption(IErr)</div><div class="ttdoc">Procedure-description: Select case using IAbsorbFLAG and calculate U&amp;#39;g prime in parallel. </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00048">ug_matrix_mod.f90:48</a></div></div>
<div class="ttc" id="namespaceipara_html_a26f97ba029bff593f5662c432380e4a7"><div class="ttname"><a href="namespaceipara.html#a26f97ba029bff593f5662c432380e4a7">ipara::icurrentz</a></div><div class="ttdeci">integer(ikind) icurrentz</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00210">smodules.f90:210</a></div></div>
<div class="ttc" id="namespacerconst_html"><div class="ttname"><a href="namespacerconst.html">rconst</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00131">smodules.f90:131</a></div></div>
<div class="ttc" id="namespacerpara_html_a9d1675bd0647c4bdb98816ea5d62623f"><div class="ttname"><a href="namespacerpara.html#a9d1675bd0647c4bdb98816ea5d62623f">rpara::rgsummat</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rgsummat</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00287">smodules.f90:287</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
