<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Felix: /home/alex/Work/Felix/src/felix/felixrefine.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Felix
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_f1e7363fc85375508a63a202db318404.html">felix</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">felixrefine.f90</div>  </div>
</div><!--header-->
<div class="contents">
<a href="felixrefine_8f90.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">! Felix</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">! Richard Beanland, Keith Evans &amp; Rudolf A Roemer</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">! (C) 2013-18, all rights reserved</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">! Version: :VERSION:</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">! Date:    :DATE:</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">! Time:    :TIME:</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">! Status:  :RLSTATUS:</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">! Build:   :BUILD:</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">! Author:  :AUTHOR:</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">! </span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">!  Felix is free software: you can redistribute it and/or modify</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">!  it under the terms of the GNU General Public License as published by</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">!  the Free Software Foundation, either version 3 of the License, or</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">!  (at your option) any later version.</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">!  </span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">!  Felix is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">!  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">!  GNU General Public License for more details.</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">!  </span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">!  You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">!  along with Felix.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#aecbf263fc9c06070ed63b7a31c76bbef">   36</a></span>&#160;<span class="keyword">PROGRAM</span> <a class="code" href="felixrefine_8f90.html#aecbf263fc9c06070ed63b7a31c76bbef">felixrefine</a></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  </div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacemynumbers.html">mynumbers</a></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacemessage__mod.html">message_mod</a></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keywordtype">USE </span>mpi</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacemympi.html">mympi</a></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceread__files__mod.html">read_files_mod</a></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceread__cif__mod.html">read_cif_mod</a></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceset__scatter__factors__mod.html">set_scatter_factors_mod</a></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacesetup__reflections__mod.html">setup_reflections_mod</a></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceimage__initialisation__mod.html">image_initialisation_mod</a></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacesetup__space__group__mod.html">setup_space_group_mod</a></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacecrystallography__mod.html">crystallography_mod</a></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceug__matrix__mod.html">ug_matrix_mod</a></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacerefinementcontrol__mod.html">refinementcontrol_mod</a>       <span class="comment">! CONTAINS Simulate and SimulateAndFit</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacewrite__output__mod.html">write_output_mod</a></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespacesimplex__mod.html">simplex_mod</a></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceiconst.html">iconst</a>; use <a class="code" href="namespacerconst.html">rconst</a>; use <a class="code" href="namespacesconst.html">sconst</a></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceipara.html">ipara</a>;  use <a class="code" href="namespacerpara.html">rpara</a>;  use <a class="code" href="namespacecpara.html">cpara</a>; use <a class="code" href="namespacespara.html">spara</a>;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceblochpara.html">blochpara</a> </div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keywordtype">USE </span><a class="code" href="namespaceichannels.html">ichannels</a></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  <span class="comment">! local variable definitions</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordtype">IMPLICIT NONE</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keywordtype">INTEGER(IKIND)</span> :: IErr,ind,jnd,knd,lnd,mnd,nnd,Iter,ICutOff,IHOLZgPoolMag,&amp;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        IBSMaxLocGVecAmp,ILaueLevel,INumTotalReflections,ITotalLaueZoneLevel,&amp;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        INhkl,IExitFLAG,ICycle,INumInitReflections,IZerothLaueZoneLevel,&amp;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        INumFinalReflections,IThicknessIndex,IVariableType,IArrayIndex,&amp;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        IAnisotropicDebyeWallerFactorElementNo</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="keywordtype">INTEGER(IKIND)</span> :: IStartTime,IStartTime2</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="keywordtype">REAL(RKIND)</span> :: RHOLZAcceptanceAngle,RLaueZoneGz,RMaxGMag,RPvecMag,&amp;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        RScale,RMaxUgStep,Rdx,RStandardDeviation,RMean,RGzUnitVec,RMinLaueZoneValue,&amp;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        Rdf,RLastFit,RBestFit,RMaxLaueZoneValue,RMaxAcceptanceGVecMag,&amp;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        RLaueZoneElectronWaveVectorMag,RvarMin,RfitMin,RFit0,Rconvex,Rtest</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(ITHREE)</span> :: R3var,R3fit</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">DIMENSION(10)</span> :: INoOfVariablesForRefinementType</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="comment">! allocatable arrays</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">DIMENSION(:)</span>,<span class="keywordtype">ALLOCATABLE</span> :: IOriginGVecIdentifier</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(:)</span>,<span class="keywordtype">ALLOCATABLE</span> :: RSimplexFoM,RIndependentVariable,&amp;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        RCurrentVar,RVar0,RLastVar,RPvec,RFitVec</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(:,:)</span>,<span class="keywordtype">ALLOCATABLE</span> :: RSimplexVariable,RgDummyVecMat,&amp;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        RgPoolMagLaue,RTestImage,ROnes,RVarMatrix,RSimp</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  </div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordtype">CHARACTER(40)</span> :: my_rank_string</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordtype">CHARACTER(20)</span> :: h,k,l</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordtype">CHARACTER(100)</span> :: SPrintString</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="comment">! startup</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="comment">! initialise constants</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacemynumbers.html#a6c534f4b86169a7c5d8d3296e270c3f0">init_numbers</a> <span class="comment">! constants for calculations</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacemessage__mod.html#ad65131f38bb57632c5079934b5b9bb0e">initialisemessage</a> <span class="comment">! constants required for formatted terminal output</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  ierr=0</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <a class="code" href="namespaceipara.html#a2619ac66077b12f37446261601018738">iinitialsimulationflag</a> = 1</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="comment">! MPI initialization</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keyword">CALL </span>mpi_init(ierr) </div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;MPI_Init&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <span class="keyword">CALL </span>mpi_comm_rank(mpi_comm_world,<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>,ierr) <span class="comment">! get rank of the current process</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;MPI_Comm_rank&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keyword">CALL </span>mpi_comm_size(mpi_comm_world,<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>,ierr) <span class="comment">! get size of the current communicator</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;MPI_Comm_size&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="comment">! startup terminal output</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;-----------------------------------------------------------------&quot;</span>)</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;felixrefine: &quot;</span>, <a class="code" href="namespacesconst.html#a0203aa3599dd217fe8d28989aca34ae6">rstr</a>)</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;             &quot;</span>, <a class="code" href="namespacesconst.html#abd18ba1f2720af1402a35dd82dee22dc">dstr</a>)</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;             &quot;</span>, <a class="code" href="namespacesconst.html#a774e4ba9dd9a2730ad4a811f7bbe5163">astr</a>)</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;-----------------------------------------------------------------&quot;</span>)</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;total number of MPI ranks &quot;</span>, <a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>, <span class="stringliteral">&quot;, screen messages via rank&quot;</span>, <a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>)</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;-----------------------------------------------------------------&quot;</span>)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="comment">! timing setup</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <span class="keyword">CALL </span>system_clock( istarttime,<a class="code" href="namespacemessage__mod.html#acbdfcb06d476307c8feb5c6bd1100384">iclockrate</a> )</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="comment">! input section </span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  </div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceread__files__mod.html#a54c266f7664ec67ee2668b302f21b857">readinpfile</a>(ierr) <span class="comment">! felix.inp</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ReadInpFile&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacemessage__mod.html#a329f2b63cff4fd55c1d08da7d826ebcc">setmessagemode</a>( <a class="code" href="namespaceipara.html#a328551d3e73c899d0adcb6c81de6015e">iwriteflag</a>, ierr )</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;set_message_mod_mode&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<span class="stringliteral">&#39;IBlochMethodFLAG =&#39;</span>,<a class="code" href="namespaceipara.html#ac2fc611e13e537adda7e9a570cc6d380">iblochmethodflag</a>)</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceread__cif__mod.html#a6e43e371f6f9c1aa08a172d0fc6ef061">read_cif</a>(ierr) <span class="comment">! felix.cif ! some allocations are here</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ReadCif&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceread__files__mod.html#ab3053752748a330bd9bdfbbe9b5bb90e">readhklfile</a>(ierr) <span class="comment">! the list of hkl&#39;s to input/output</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ReadHklFile&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="comment">! read experimental images (if in refinement mode)</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#affe4955befe0b01618d77941d0c70fe9">isimflag</a>.EQ.0) <span class="keywordflow">THEN</span> <span class="comment">! it&#39;s a refinement, so read-IN experimental images</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#ace33cd9a5b6ab325821876a86059d399">rimageexpi</a>(2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>),stat=ierr)  </div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RImageExpi&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespaceread__files__mod.html#afc88192b25e5a8c1d0ac2b88d8e2e29a">readexperimentalimages</a>(ierr)</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ReadExperimentalImages&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="keywordflow">ELSE</span> <span class="comment">! not refinement, simulation only</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Simulation only&quot;</span>)</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="comment">! set up scattering factors, relativistic electrons, reciprocal lattice</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceset__scatter__factors__mod.html#afa6ecf739cd73eb7ab07728f42ccb4d5">setscatteringfactors</a>(<a class="code" href="namespaceipara.html#afc4f119295fdea846160e89888095a6d">iscatterfactormethodflag</a>,ierr)</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;SetScatteringFactors&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <span class="comment">! returns global RScattFactors depeding upon scattering method: Kirkland, Peng, etc.</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="comment">! Calculate wavevector magnitude k and relativistic mass</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="comment">! Electron Velocity in metres per second</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <a class="code" href="namespacerpara.html#ac6e1b12192449367c347418574c2aaac">relectronvelocity</a> = &amp;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <a class="code" href="namespacerconst.html#acd0b84e445113cfb708f67d2490699b8">rspeedoflight</a>*sqrt( <a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a> - ((<a class="code" href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">relectronmass</a>*<a class="code" href="namespacerconst.html#acd0b84e445113cfb708f67d2490699b8">rspeedoflight</a>**2) / &amp;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        (<a class="code" href="namespacerconst.html#aa897c1c825282cfa362db0fb72b9b8ad">relectroncharge</a>*<a class="code" href="namespacerpara.html#a3e1ea863b25489d2f5a117bf018898f8">racceleratingvoltage</a>*<a class="code" href="namespacemynumbers.html#a6494cb5525586ad433cd54d5590adbca">thousand</a>+<a class="code" href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">relectronmass</a>*<a class="code" href="namespacerconst.html#acd0b84e445113cfb708f67d2490699b8">rspeedoflight</a>**2))**2 )</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">! Electron WaveLength in metres</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <a class="code" href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">relectronwavelength</a> = <a class="code" href="namespacerconst.html#a197d5b0781324ed2c51391b89387589f">rplanckconstant</a> / &amp;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        (  sqrt(<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*<a class="code" href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">relectronmass</a>*<a class="code" href="namespacerconst.html#aa897c1c825282cfa362db0fb72b9b8ad">relectroncharge</a>*<a class="code" href="namespacerpara.html#a3e1ea863b25489d2f5a117bf018898f8">racceleratingvoltage</a>*<a class="code" href="namespacemynumbers.html#a6494cb5525586ad433cd54d5590adbca">thousand</a>) * &amp;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        sqrt( <a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a> + (<a class="code" href="namespacerconst.html#aa897c1c825282cfa362db0fb72b9b8ad">relectroncharge</a>*<a class="code" href="namespacerpara.html#a3e1ea863b25489d2f5a117bf018898f8">racceleratingvoltage</a>*<a class="code" href="namespacemynumbers.html#a6494cb5525586ad433cd54d5590adbca">thousand</a>) / &amp;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        (<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*<a class="code" href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">relectronmass</a>*<a class="code" href="namespacerconst.html#acd0b84e445113cfb708f67d2490699b8">rspeedoflight</a>**2) )  ) * <a class="code" href="namespacerconst.html#abf3e0e151d78d15c709e9f2c6165075b">rangstromconversion</a></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="comment">! NB --- k=2pi/lambda and exp(i*k.r), physics convention</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <a class="code" href="namespacerpara.html#abc550cca4c99bd31b505746288b104d4">relectronwavevectormagnitude</a>=<a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a>/<a class="code" href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">relectronwavelength</a></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <a class="code" href="namespacerpara.html#a339178d3a4919cad9490211dc57bae40">rrelativisticcorrection</a> = <a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>/sqrt( <a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a> - (<a class="code" href="namespacerpara.html#ac6e1b12192449367c347418574c2aaac">relectronvelocity</a>/<a class="code" href="namespacerconst.html#acd0b84e445113cfb708f67d2490699b8">rspeedoflight</a>)**2 )</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  <a class="code" href="namespacerpara.html#a52616e7e78c617015f75d7ef990beba7">rrelativisticmass</a> = <a class="code" href="namespacerpara.html#a339178d3a4919cad9490211dc57bae40">rrelativisticcorrection</a>*<a class="code" href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">relectronmass</a></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="comment">!conversion from Vg to Ug, h^2/(2pi*m0*e), see e.g. Kirkland eqn. C.5</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <a class="code" href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rscattfactovolts</a>=(<a class="code" href="namespacerconst.html#a197d5b0781324ed2c51391b89387589f">rplanckconstant</a>**2)*(<a class="code" href="namespacerconst.html#abf3e0e151d78d15c709e9f2c6165075b">rangstromconversion</a>**2)/&amp;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  (<a class="code" href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">twopi</a>*<a class="code" href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">relectronmass</a>*<a class="code" href="namespacerconst.html#aa897c1c825282cfa362db0fb72b9b8ad">relectroncharge</a>*<a class="code" href="namespacerpara.html#a52787d6e96b170221373591f4e1ef159">rvolume</a>)</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="comment">! Creates reciprocal lattice vectors in Microscope reference frame</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacecrystallography__mod.html#a8bcf725498414cb7ac7ce808ba2051be">reciprocallattice</a>(ierr)</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ReciprocalLattice&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  <span class="comment">! allocate atom and Debye-Waller factor arrays</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="comment">! total possible atoms/unit cell</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>=<span class="keyword">SIZE</span>(<a class="code" href="namespacerpara.html#ad410dacc219d75ed02822705e40185c0">rbasisatomposition</a>,1)*<span class="keyword">SIZE</span>(<a class="code" href="namespacerpara.html#a02a9b407c398ac1fa9d488aa4f30fad5">rsymvec</a>,1)</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  <span class="comment">! over-allocate since actual size not known before calculation of unique positions </span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <span class="comment">! (atoms in special positions will be duplicated)</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="comment">! allocations using that RBasisAtomPosition, RSymVec have now been setup</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="comment">! fractional unit cell coordinates are used for RAtomPosition, like BasisAtomPosition</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a0876e889f6ebb06fa81cc8276ec6a131">ratomposition</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>,<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a>),stat=ierr)</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RAtomPosition&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="comment">! RAtomCoordinate is in the microscope reference frame in Angstrom units</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>,<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a>),stat=ierr)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RAtomCoordinate&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacespara.html#a68b06af6b6fec154d76e1267678421c3">satomlabel</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>),stat=ierr) <span class="comment">! atom label</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate SAtomLabel&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacespara.html#a6a49bd4357ec329e1bb9c4de6be9c276">satomname</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>),stat=ierr) <span class="comment">! atom name</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate SAtomName&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>),stat=ierr) <span class="comment">! Isotropic Debye-Waller factor</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RIsoDW&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>),stat=ierr)</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate ROccupancy&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">iatomicnumber</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>),stat=ierr)</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate IAtomicNumber&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="comment">! Anisotropic Debye-Waller factor</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespaceipara.html#adee5a4247435a83b19c439de4b1f3138">ianisodw</a>(<a class="code" href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">imaxpossiblenatomsunitcell</a>),stat=ierr)</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate IAnisoDW&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="comment">! set up unique atom positions, reflection pool</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="comment">! fills unit cell from basis and symmetry, removes duplicate atoms at special positions</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacecrystallography__mod.html#a2ee814f536b5ab881409758b980dcd10">uniqueatompositions</a>(ierr)</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;UniqueAtomPositions&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="comment">!?? RB could re-allocate RAtomCoordinate,SAtomName,RIsoDW,ROccupancy,</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="comment">!?? IAtomicNumber,IAnisoDW to match INAtomsUnitCell?</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  rholzacceptanceangle=<a class="code" href="namespacemynumbers.html#a5f9279872ada05b1ce8888a3a9a64b78">twodeg2radian</a> <span class="comment">!?? RB seems way too low?</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  <a class="code" href="namespaceipara.html#a76cb3f709ca8ca3f1444325f4a5906a5">ihklmaxvalue</a> = 5 <span class="comment">! starting value, increments in loop below</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="comment">!?? RB Note the application of acceptance angle is incorrect since it uses hkl;</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="comment">!?? it should use the reciprocal lattice vectors as calculated in RgPool</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  <span class="comment">! Count the reflections that make up the pool of g-vectors, simply returns INhkl</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacesetup__reflections__mod.html#aacc9940f2b54fd9de9c07819b6c63fc9">hklcount</a>(<a class="code" href="namespaceipara.html#a76cb3f709ca8ca3f1444325f4a5906a5">ihklmaxvalue</a>,<a class="code" href="namespacerpara.html#a8cf94222498f09d89ab12f4ea792c3cc">rzdirc</a>,inhkl,rholzacceptanceangle,ierr)</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;HKLCount&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keywordflow">DO</span> <span class="keywordflow">WHILE</span> (inhkl.LT.<a class="code" href="namespaceipara.html#acb246c6c38569637049523935014fd2d">iminreflectionpool</a>) </div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <a class="code" href="namespaceipara.html#a76cb3f709ca8ca3f1444325f4a5906a5">ihklmaxvalue</a> = <a class="code" href="namespaceipara.html#a76cb3f709ca8ca3f1444325f4a5906a5">ihklmaxvalue</a>+1</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespacesetup__reflections__mod.html#aacc9940f2b54fd9de9c07819b6c63fc9">hklcount</a>(<a class="code" href="namespaceipara.html#a76cb3f709ca8ca3f1444325f4a5906a5">ihklmaxvalue</a>,<a class="code" href="namespacerpara.html#a8cf94222498f09d89ab12f4ea792c3cc">rzdirc</a>,inhkl,rholzacceptanceangle,ierr)</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keywordflow">  END DO</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  </div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  <span class="comment">! Fill the list of reflections Rhkl</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="comment">! NB Rhkl are in INTEGER form [h,k,l] but are REAL to allow dot products etc.</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(inhkl,<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a>),stat=ierr)</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate Rhkl&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacesetup__reflections__mod.html#a74fc591a7e77c30486b2b93a0640caa9">hklmake</a>(<a class="code" href="namespaceipara.html#a76cb3f709ca8ca3f1444325f4a5906a5">ihklmaxvalue</a>,<a class="code" href="namespacerpara.html#a8cf94222498f09d89ab12f4ea792c3cc">rzdirc</a>,rholzacceptanceangle,ierr)</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;HKLMake&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">dbg7</a>,<span class="stringliteral">&quot;Rhkl matrix: &quot;</span>,nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(1:inhkl,:)))</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  <span class="comment">! sort HKL, specific reflections</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="comment">! sort hkl in descending order of magnitude</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacesetup__reflections__mod.html#a27b6c4289cce9c86414ea90509990d30">hklsort</a>(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>,inhkl,ierr) </div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;SortHKL&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="comment">!?? RB may result in an error when the reflection pool does not reach</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="comment">!?? the highest hkl of the experimental data? </span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="comment">! Assign numbers to different reflections -&gt; IOutputReflections, INoOfLacbedPatterns</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacesetup__reflections__mod.html#a698f914dd9471567b485f41c6b7c8f2f">hkllist</a>(ierr)</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;SpecificReflectionDetermination&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="comment">! allocate RgPool and dummy</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="comment">! RgPool is a list of g-vectors in the microscope ref frame,</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="comment">! units of 1/A (NB exp(-i*q.r),  physics negative convention)</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(inhkl,<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a>),stat=ierr)</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgPool&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  <span class="keyword">ALLOCATE</span>(rgdummyvecmat(inhkl,<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a>),stat=ierr)</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgDummyVecMat&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  <span class="comment">! calculate g vector list, considering zeroth order Laue zone</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="comment">! Calculate the g vector list RgPool in reciprocal angstrom units</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="comment">! in the microscope reference frame</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  icutoff = 1</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keywordflow">DO</span> ind=1,inhkl</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordflow">DO</span> jnd=1,<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      <a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(ind,jnd) = <a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(ind,1)*<a class="code" href="namespacerpara.html#ac3f76b98beae63fa0068cc5fbf2e3ef9">rarvecm</a>(jnd) + &amp;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;            <a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(ind,2)*<a class="code" href="namespacerpara.html#a7fa8bfd8c3361f8ba839ec6461dcd0ae">rbrvecm</a>(jnd) + <a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(ind,3)*<a class="code" href="namespacerpara.html#a17372b60679b620c6d7727811dc92d27">rcrvecm</a>(jnd)</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="keywordflow">    ENDDO</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;      <span class="comment">! If a g-vector has a non-zero z-component it is not in the ZOLZ</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordflow">IF</span>(abs(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(ind,3)).GT.<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>.AND.icutoff.NE.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      rgzunitvec=abs(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(ind,3))</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      icutoff=0</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="keywordflow">  ENDDO</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <span class="comment">! This should occur when no higher Laue zones (IHolzFLAG off)</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  <span class="keywordflow">IF</span>(icutoff.EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! all g-vectors have z-component equal to zero</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    rgzunitvec=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  <span class="keywordflow">IF</span>( icutoff.EQ.1 .AND. <a class="code" href="namespaceipara.html#a05b32257189f2a78d3240abeee76d8be">iholzflag</a>.EQ.1 ) ierr = 1</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="keywordflow">IF</span>( l_alert(ierr, <span class="stringliteral">&quot;felixrefine&quot;</span>, &amp;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="stringliteral">&quot;fill Laue Zones. IHolzFLAG = 1 in felix.inp, however no higher order g-vectors &quot;</span> &amp;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        //<span class="stringliteral">&quot;were found. Continuing with zeroth-order Laue zone only.&quot;</span>) ) ierr = 0</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  </div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  <span class="comment">! sort into Laue Zones</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  rgdummyvecmat=<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="keywordflow">WHERE</span>(abs(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(:,3)).GT.<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>) <span class="comment">! higher order Laue zones cases</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    rgdummyvecmat(:,3)=rgdummyvecmat(:,3)/rgzunitvec </div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="keywordflow">  END WHERE</span> <span class="comment">! divide zero is not a concern as condition matches above</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <span class="comment">! min &amp; max Laue Zones </span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  rmaxlauezonevalue=maxval(rgdummyvecmat(:,3),dim=1)</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  rminlauezonevalue=minval(rgdummyvecmat(:,3),dim=1)</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  itotallauezonelevel=nint(rmaxlauezonevalue+abs(rminlauezonevalue)+1,<a class="code" href="namespacemynumbers.html#aa13f60b32e8784cd78d2fdc5bf775dca">ikind</a>)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  </div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  <span class="keyword">DEALLOCATE</span>(rgdummyvecmat, stat=ierr)</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;deallocate RgDummyVecMat&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  <span class="comment">! (optional) calculate higher order Laue zone </span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="keyword">ALLOCATE</span>(rgpoolmaglaue(inhkl,itotallauezonelevel),stat=ierr)</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgPoolMagLaue&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  <span class="comment">! calculate higher order Laue zones</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  <span class="keywordflow">IF</span>(<a class="code" href="namespacerpara.html#a046c2835d55be915c22548463c97b14c">racceptanceangle</a>.NE.<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>.AND.<a class="code" href="namespaceipara.html#a05b32257189f2a78d3240abeee76d8be">iholzflag</a>.EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="comment">!?? currently not working, unused variables here, lots needs to be checked</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    inumtotalreflections=0</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordflow">DO</span> ind=1,itotallauezonelevel</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      ilauelevel=ind-izerothlauezonelevel</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;      rlauezonegz=rgzunitvec*ilauelevel</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      <span class="keywordflow">DO</span> jnd=1,inhkl</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="keywordflow">IF</span>(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(jnd,3).GE.(rlauezonegz-<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>).AND. &amp;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;             <a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(jnd,3).LE.(rlauezonegz+<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>)) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;          rgpoolmaglaue(jnd,ind)=sqrt((<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(jnd,1)**2)+(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(jnd,2)**2))              </div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <span class="keywordflow">ELSE</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;          rgpoolmaglaue(jnd,ind)=<a class="code" href="namespacemynumbers.html#a42ec1d61ae72aab517835b64eb079242">neghuge</a></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;      inuminitreflections = count(rgpoolmaglaue(:,ind).NE.<a class="code" href="namespacemynumbers.html#a42ec1d61ae72aab517835b64eb079242">neghuge</a>)</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;      rlauezoneelectronwavevectormag = <a class="code" href="namespacerpara.html#abc550cca4c99bd31b505746288b104d4">relectronwavevectormagnitude</a>-abs(rlauezonegz)           </div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;      rmaxacceptancegvecmag = (rlauezoneelectronwavevectormag * &amp;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            tan(<a class="code" href="namespacerpara.html#a046c2835d55be915c22548463c97b14c">racceptanceangle</a>*<a class="code" href="namespacemynumbers.html#a9eaca1a20a550c924bcb94deb804d1d8">deg2radian</a>))</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;      <span class="keywordflow">WHERE</span>(abs(rgpoolmaglaue(:,ind)).GT.rmaxacceptancegvecmag)</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        rgpoolmaglaue(:,ind)=<a class="code" href="namespacemynumbers.html#a42ec1d61ae72aab517835b64eb079242">neghuge</a></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="keywordflow">      END WHERE</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;      inumfinalreflections=count(rgpoolmaglaue(:,ind).NE.<a class="code" href="namespacemynumbers.html#a42ec1d61ae72aab517835b64eb079242">neghuge</a>)</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;      inumtotalreflections=inumtotalreflections+inuminitreflections</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    knd=0</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">DO</span> ind=1,inhkl</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;      <span class="keywordflow">IF</span>(sum(rgpoolmaglaue(ind,:))/<span class="keywordtype">REAL</span>(itotallauezonelevel,<a class="code" href="namespacemynumbers.html#a31c0ed8207e9cd37552632a597a2f067">rkind</a>).GT.NEGHUGE) then</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        knd=knd+1</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    iholzgpoolmag=knd</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keyword">ALLOCATE</span>(iorigingvecidentifier(iholzgpoolmag),stat=ierr)</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate IOriginGVecIdentifier&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    iorigingvecidentifier=0</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    knd=1</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="keywordflow">DO</span> ind=1,inhkl</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      <span class="keywordflow">IF</span>((sum(rgpoolmaglaue(ind,:))/<span class="keywordtype">REAL</span>(itotallauezonelevel,<a class="code" href="namespacemynumbers.html#a31c0ed8207e9cd37552632a597a2f067">rkind</a>)).GT.neghuge) then</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        iorigingvecidentifier(knd)=ind</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        knd=knd+1</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="comment">! calculate g vector magnitudes and components parallel to the surface</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  <span class="comment">! calculate g-vector magnitudes for the reflection pool RgPoolMag</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  <span class="comment">! in reciprocal Angstrom units, in the Microscope reference frame</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(inhkl),stat=ierr)</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgPoolMag&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  <span class="keywordflow">DO</span> ind=1,inhkl</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;     <a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(ind)= sqrt(dot_product(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(ind,:),<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(ind,:)))</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="keywordflow">  END DO</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">dbg7</a>,<span class="stringliteral">&quot;g-vectors and magnitude (1/A), in the microscope reference frame&quot;</span> )</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="keywordflow">DO</span> ind = 1,<span class="keyword">SIZE</span>(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>,1)</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">dbg7</a>,<span class="stringliteral">&quot;hkl  :&quot;</span>,nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(ind,:)))</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">dbg7</a>,<span class="stringliteral">&quot;g mag:&quot;</span>,<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(ind))</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="keywordflow">  END DO</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  <span class="comment">! g-vector components parallel to the surface unit normal</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a5f621d5437e3eee27971ec962a75db0e">rgdotnorm</a>(inhkl),stat=ierr)</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgDotNorm&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">DO</span> ind =1,inhkl</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <a class="code" href="namespacerpara.html#a5f621d5437e3eee27971ec962a75db0e">rgdotnorm</a>(ind) = dot_product(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(ind,:),<a class="code" href="namespacerpara.html#a0969e192bfe5abf3e5bd3dd41e1eabe4">rnormdirm</a>)</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keywordflow">  END DO</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">dbg7</a>,<span class="stringliteral">&quot;g.n list&quot;</span>)</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordflow">DO</span> ind = 1,<span class="keyword">SIZE</span>(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>,1)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">dbg7</a>,<span class="stringliteral">&quot;hkl :&quot;</span>,nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(ind,:)))</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">dbg7</a>,<span class="stringliteral">&quot;g.n :&quot;</span>,<a class="code" href="namespacerpara.html#a5f621d5437e3eee27971ec962a75db0e">rgdotnorm</a>(ind))</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="keywordflow">  END DO</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <span class="comment">! calculate resolution in k space</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <a class="code" href="namespacerpara.html#ab7db7986597161f727087ceddf86b5ab">rminimumgmag</a> = <a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(2)<span class="comment">!since the first one is always 000</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <a class="code" href="namespacerpara.html#a28e140902500ccaf75631cb870647256">rdeltak</a> = <a class="code" href="namespacerpara.html#ab7db7986597161f727087ceddf86b5ab">rminimumgmag</a>*<a class="code" href="namespacerpara.html#a6f6910638fe224fd061d7cdeeb21d1c0">rconvergenceangle</a>/<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,<a class="code" href="namespacemynumbers.html#a31c0ed8207e9cd37552632a597a2f067">rkind</a>)</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="comment">! calculate RMaxGMag using acceptance angle, count number reflections</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="comment">! acceptance angle</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordflow">IF</span>(<a class="code" href="namespacerpara.html#a046c2835d55be915c22548463c97b14c">racceptanceangle</a>.NE.<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>.AND.<a class="code" href="namespaceipara.html#a05b32257189f2a78d3240abeee76d8be">iholzflag</a>.EQ.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    rmaxacceptancegvecmag=(<a class="code" href="namespacerpara.html#abc550cca4c99bd31b505746288b104d4">relectronwavevectormagnitude</a>*tan(<a class="code" href="namespacerpara.html#a046c2835d55be915c22548463c97b14c">racceptanceangle</a>*<a class="code" href="namespacemynumbers.html#a9eaca1a20a550c924bcb94deb804d1d8">deg2radian</a>))</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="keywordflow">IF</span>(<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(<a class="code" href="namespaceipara.html#acb246c6c38569637049523935014fd2d">iminreflectionpool</a>).GT.rmaxacceptancegvecmag) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;      rmaxgmag = rmaxacceptancegvecmag </div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <span class="keywordflow">ELSE</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      rmaxgmag = <a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(<a class="code" href="namespaceipara.html#acb246c6c38569637049523935014fd2d">iminreflectionpool</a>)</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keywordflow">ELSEIF</span>(<a class="code" href="namespacerpara.html#a046c2835d55be915c22548463c97b14c">racceptanceangle</a>.NE.<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>.AND.<a class="code" href="namespaceipara.html#a05b32257189f2a78d3240abeee76d8be">iholzflag</a>.EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    ibsmaxlocgvecamp=maxval(iorigingvecidentifier)</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    rmaxgmag=<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(ibsmaxlocgvecamp)</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordflow">IF</span>(<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(ibsmaxlocgvecamp).GE.<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(<a class="code" href="namespaceipara.html#acb246c6c38569637049523935014fd2d">iminreflectionpool</a>)) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;      rmaxgmag = <a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(<a class="code" href="namespaceipara.html#acb246c6c38569637049523935014fd2d">iminreflectionpool</a>)</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordflow">ELSE</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    rmaxgmag = <a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(<a class="code" href="namespaceipara.html#acb246c6c38569637049523935014fd2d">iminreflectionpool</a>)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  </div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="comment">! count reflections up to cutoff magnitude</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>=0_ikind</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordflow">DO</span> ind=1,inhkl</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">IF</span> (abs(<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>(ind)).LE.rmaxgmag) <a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>=<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>+1</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="keywordflow">  ENDDO</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>.LT.<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>) <a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a> = <a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  </div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="comment">! deallocation</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="keyword">DEALLOCATE</span>(rgpoolmaglaue)<span class="comment">!</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordflow">IF</span> (<a class="code" href="namespacerpara.html#a046c2835d55be915c22548463c97b14c">racceptanceangle</a>.NE.<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>.AND.<a class="code" href="namespaceipara.html#a05b32257189f2a78d3240abeee76d8be">iholzflag</a>.EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keyword">DEALLOCATE</span>(iorigingvecidentifier)</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="comment">! allocate Ug arrays</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="comment">! Calculate Ug matrix etc.</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>),stat=ierr)<span class="comment">! Ug Matrix without absorption</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate CUgMatNoAbs&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cugmatprime</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>),stat=ierr)<span class="comment">! U&#39;g Matrix of just absorption</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate CUgMatPrime&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacecpara.html#ab994df5c023832e6fbc15e15b5b28358">cugmat</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>),stat=ierr)<span class="comment">! Ug+U&#39;g Matrix, including absorption</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate CUgMat&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="comment">! Matrix of 2pi*g-vectors that corresponds to the CUgMatNoAbs matrix</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a>),stat=ierr)</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgMatrix&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  <span class="comment">! Matrix of their magnitudes </span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>),stat=ierr)</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgMatrixMagnitude&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  <span class="comment">! Matrix of sums of indices - for symmetry equivalence in the Ug matrix</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a9d1675bd0647c4bdb98816ea5d62623f">rgsummat</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>),stat=ierr) </div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RgSumMat&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="comment">! Matrix with numbers marking equivalent Ug&#39;s</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">isymmetryrelations</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>),stat=ierr)</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate ISymmetryRelations&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  </div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="comment">! calculate reflection matrix &amp; initialise structure factors</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="comment">! Calculate matrix  of g-vectors that corresponds to the Ug matrix</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>= nint((<a class="code" href="namespacerpara.html#af9f3198452e138d909821f0909a33d41">rfinalthickness</a>-<a class="code" href="namespacerpara.html#a9bda8546175cae80b32168a101cf5823">rinitialthickness</a>)/<a class="code" href="namespacerpara.html#a77bf2d4da8669434639c8c6a48f9a65d">rdeltathickness</a>) + 1</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <span class="keywordflow">DO</span> ind=1,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="keywordflow">DO</span> jnd=1,<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      <a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(ind,jnd,:)= <a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(ind,:)-<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>(jnd,:)</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      <a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>(ind,jnd) = &amp; </div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;           sqrt(dot_product(<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(ind,jnd,:),<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(ind,jnd,:)))</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="keywordflow">    ENDDO</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keywordflow">  ENDDO</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>,<span class="stringliteral">&quot;g-vector magnitude matrix (2pi/A)&quot;</span>, <a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>(1:16,1:8)) </div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a034f270863f434ad6d1add2c5a6e712a">lxl</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>,<span class="stringliteral">&quot;first 16 g-vectors&quot;</span>, <a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>(1:16,1,:)) </div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="comment">! structure factor initialization</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="comment">! Calculate Ug matrix for each entry in CUgMatNoAbs(1:nReflections,1:nReflections)</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#aefbfaa87735de589ffff68e6d7faaa86">structurefactorinitialisation</a>(ierr)</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;StructureFactorInitialisation&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="comment">! NB IEquivalentUgKey and CUniqueUg allocated in here</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <span class="comment">! CUniqueUg vector produced here to later fill RIndependentVariable</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;  </div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  <span class="comment">! calculate absorptive scattering factors</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  <span class="keyword">CALL </span>system_clock( istarttime2 )</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>,<span class="stringliteral">&quot;Starting absorption calculation... &quot;</span>)</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceug__matrix__mod.html#add186c4b63f545bc1cec1d65317fd4fa">absorption</a> (ierr)</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>, <span class="stringliteral">&quot;Initial Ug matrix, with absorption (nm^-2)&quot;</span> )</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  <span class="keywordflow">DO</span> ind = 1,16</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(3(I2,1X),A2,1X,8(F7.4,1X))&#39;</span>) nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(ind,:)),<span class="stringliteral">&quot;: &quot;</span>,100*<a class="code" href="namespacecpara.html#ab994df5c023832e6fbc15e15b5b28358">cugmat</a>(ind,1:4)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">lm</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>, sprintstring)</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="keywordflow">  END DO</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;Absorption&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacemessage__mod.html#a984a91f7533b6975ca99ebe57ed9f770">printendtime</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,istarttime2, <span class="stringliteral">&quot;Absorption&quot;</span> )</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>,<a class="code" href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">dbg3</a>,<span class="stringliteral">&quot;g-vector magnitude matrix (2pi/A)&quot;</span>, <a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>(1:16,1:8)) </div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <span class="keyword">CALL </span>system_clock( istarttime2 )</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  <span class="comment">! INoOfVariables calculated depending upon Ug and non-Ug refinement</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="comment">! Ug refinement is a special case and must be done alone</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="comment">! cannot do any other refinement alongside</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#affe4955befe0b01618d77941d0c70fe9">isimflag</a>.EQ.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(1).EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! It&#39;s a Ug refinement, A</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;      <span class="comment">! Count the number of Independent Variables</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;        <a class="code" href="namespaceipara.html#a8dbc1fbcf67a9f17b683553859de202b">iugoffset</a>=1  <span class="comment">! can skip Ug&#39;s in refinement using offset, 1 is inner potential</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;      jnd=1</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;      <span class="keywordflow">DO</span> ind = 1+<a class="code" href="namespaceipara.html#a8dbc1fbcf67a9f17b683553859de202b">iugoffset</a>,<a class="code" href="namespaceipara.html#a1416f7f0a49b5272510fa759473bb2eb">inoofugs</a>+<a class="code" href="namespaceipara.html#a8dbc1fbcf67a9f17b683553859de202b">iugoffset</a></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <span class="keywordflow">IF</span> ( abs(<span class="keywordtype">REAL(CUniqueUg(ind)</span>,RKIND)).GE.<a class="code" href="namespacerconst.html#a85ea14b9febb9539ac8d317add5cdadd">rtolerance</a> ) jnd=jnd+1</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">IF</span> ( abs(aimag(<a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>(ind))).GE.<a class="code" href="namespacerconst.html#a85ea14b9febb9539ac8d317add5cdadd">rtolerance</a> ) jnd=jnd+1</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;      <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#a4178ca9371949c00795220c776bf9d92">iabsorbflag</a>.EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! proportional absorption</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a> = jnd <span class="comment">! the last variable is for absorption, so included</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="keywordflow">ELSE</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a> = jnd-1 </div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;      <span class="keywordflow">IF</span> ( <a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>.EQ.1 ) <span class="keywordflow">THEN</span> </div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Only one independent variable&quot;</span>)</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      <span class="keywordflow">ELSE</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;number of independent variables = &quot;</span>,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>)</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <span class="keywordflow">ELSE</span> <span class="comment">! It&#39;s not a Ug refinement, so count refinement variables</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      <span class="comment">! Excluding Ug refinement, various variables can be refined together</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;      inoofvariablesforrefinementtype(1)=0</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      <span class="comment">! Atom coordinate refinement, B</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(2).EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ae90b8276ac3740e84da8bc67eef4e477">setupatommovements</a>(ierr)</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;SetupAtomMovements&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        inoofvariablesforrefinementtype(2)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(2)*<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#afc203a95f836819679531255dbcf2440">iatommovelist</a>)</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;      <span class="keywordflow">ELSE</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        inoofvariablesforrefinementtype(2)=0</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      <span class="comment">! Occupancy, C</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      inoofvariablesforrefinementtype(3)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(3)*<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;      <span class="comment">! Isotropic DW, D</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      inoofvariablesforrefinementtype(4)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(4)*<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;      <span class="comment">! Anisotropic DW, E</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;      inoofvariablesforrefinementtype(5)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(5)*<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)*6</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;      inoofvariablesforrefinementtype(6)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(6)*3<span class="comment">! Unit cell dimensions, F</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      inoofvariablesforrefinementtype(7)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(7)*3<span class="comment">! Unit cell angles, G</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;      inoofvariablesforrefinementtype(8)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(8)<span class="comment">! Convergence angle, H</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;      inoofvariablesforrefinementtype(9)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(9)<span class="comment">! Percentage Absorption, I</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      inoofvariablesforrefinementtype(10)=<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(10)<span class="comment">! kV, J</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;      <span class="comment">! Total number of independent variables</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;      <a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a> = sum(inoofvariablesforrefinementtype)</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;      <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>.EQ.0) <span class="keywordflow">THEN</span> </div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="comment">! there&#39;s no refinement requested, say so and quit</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        ierr = 1</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,&amp;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;              <span class="stringliteral">&quot;No refinement variables! Check IRefineModeFLAG in felix.inp. &quot;</span>// &amp;</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;              <span class="stringliteral">&quot;Valid refine modes are A,B,C,D,E,F,G,H,I,J,S&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="keyword">ALLOCATE</span>(rindependentvariable(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr) </div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RIndependentVariable&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="comment">! assign refinement variables depending upon Ug and non-Ug refinement</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(1).EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! It&#39;s a Ug refinement, A</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;      <span class="comment">! Fill up the IndependentVariable list with CUgMatNoAbs components</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      jnd=1</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      <span class="keywordflow">DO</span> ind = 1+<a class="code" href="namespaceipara.html#a8dbc1fbcf67a9f17b683553859de202b">iugoffset</a>,<a class="code" href="namespaceipara.html#a1416f7f0a49b5272510fa759473bb2eb">inoofugs</a>+<a class="code" href="namespaceipara.html#a8dbc1fbcf67a9f17b683553859de202b">iugoffset</a></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <span class="keywordflow">IF</span> ( abs(<span class="keywordtype">REAL(CUniqueUg(ind)</span>,rkind)).GE.<a class="code" href="namespacerconst.html#a85ea14b9febb9539ac8d317add5cdadd">rtolerance</a> ) then</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;          rindependentvariable(jnd) = <span class="keywordtype">REAL(CUniqueUg(ind)</span>,RKIND)</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;          jnd=jnd+1</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        <span class="keywordflow">IF</span> ( abs(aimag(<a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>(ind))).GE.<a class="code" href="namespacerconst.html#a85ea14b9febb9539ac8d317add5cdadd">rtolerance</a> ) <span class="keywordflow">THEN</span> </div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;          rindependentvariable(jnd) = aimag(<a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>(ind))</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;          jnd=jnd+1</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;      <span class="comment">! Proportional absorption included in structure factor refinement as last variable</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#a4178ca9371949c00795220c776bf9d92">iabsorbflag</a>.EQ.1) rindependentvariable(jnd) = <a class="code" href="namespacerpara.html#aa6e33f58b9a58ec8271fa0a00f187fc7">rabsorptionpercentage</a></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">ELSE</span> <span class="comment">! It&#39;s not a Ug refinement </span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      <span class="comment">! Fill up the IndependentVariable list </span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;      <span class="keyword">ALLOCATE</span>(rindependentvariable(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)  </div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      ind=1</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(2).EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! Atomic coordinates, B</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;          <span class="keywordflow">DO</span> jnd=1,<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#afc203a95f836819679531255dbcf2440">iatommovelist</a>)</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            rindependentvariable(ind)=dot_product(<a class="code" href="namespacerpara.html#ad410dacc219d75ed02822705e40185c0">rbasisatomposition</a>(<a class="code" href="namespaceipara.html#afc203a95f836819679531255dbcf2440">iatommovelist</a>(jnd),:),<a class="code" href="namespacerpara.html#a93e42ab6d253823f52158db3a2f61369">rvector</a>(jnd,:))</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;            ind=ind+1</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="keywordflow">          END DO</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;      <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(3).EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! Occupancy, C</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;          <span class="keywordflow">DO</span> jnd=1,<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            rindependentvariable(ind)=<a class="code" href="namespacerpara.html#a132781a742699634e36b131c3dab95cc">rbasisoccupancy</a>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>(jnd))</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;            ind=ind+1</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="keywordflow">          END DO</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;      <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(4).EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! Isotropic DW, D</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;          <span class="keywordflow">DO</span> jnd=1,<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            rindependentvariable(ind)=<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>(jnd))</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            ind=ind+1</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="keywordflow">          END DO</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;      <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(8).EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! Convergence angle, H</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        rindependentvariable(ind)=<a class="code" href="namespacerpara.html#a6f6910638fe224fd061d7cdeeb21d1c0">rconvergenceangle</a></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        ind=ind+1</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;      <span class="comment">! Assign IDs - not needed for a Ug refinement</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;      <span class="keyword">ALLOCATE</span>(<a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>,2),stat=ierr)</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate IIterativeVariableUniqueIDs&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a> = 0 </div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;      <span class="keywordflow">DO</span> ind = 2,<a class="code" href="namespaceiconst.html#a8a382193072e7a2709bacc4804d31085">irefinementvariabletypes</a> <span class="comment">! Loop over iterative variables apart from Ug&#39;s</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <span class="keywordflow">IF</span>(<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(ind).EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;          <span class="keywordflow">DO</span> jnd = 1,inoofvariablesforrefinementtype(ind)</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;            iarrayindex = sum(inoofvariablesforrefinementtype(:(ind-1))) + jnd</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <span class="keywordflow">SELECT CASE</span>(ind)</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;            <span class="keywordflow">CASE</span>(1) <span class="comment">! Ugs, A</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,2) = &amp;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                    nint(<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a1416f7f0a49b5272510fa759473bb2eb">inoofugs</a>,rkind)*(<span class="keywordtype">REAL(jnd/REAL(INoofUgs,RKIND)</span>,rkind)-&amp;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                    CEILING(<span class="keywordtype">REAL(jnd/REAL(INoofUgs,RKIND)</span>,rkind)))+<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a1416f7f0a49b5272510fa759473bb2eb">inoofugs</a>,rkind))</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            <span class="keywordflow">CASE</span>(2) <span class="comment">! Coordinates (x,y,z), B</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,2) = jnd</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            <span class="keywordflow">CASE</span>(3) <span class="comment">! Occupancies, C</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,2) = <a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>(jnd)</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            <span class="keywordflow">CASE</span>(4) <span class="comment">! Isotropic Debye Waller Factors , D</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,2) = <a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>(jnd)</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;            <span class="keywordflow">CASE</span>(5) <span class="comment">! Anisotropic Debye Waller Factors (a11-a33), E</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;              <span class="comment">!?? not currently implemented</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;              ierr=1;<span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,&amp;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                    <span class="stringliteral">&quot;Anisotropic Debye Waller Factors not implemented&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="comment">!            IIterativeVariableUniqueIDs(IArrayIndex,1) = ind</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  <span class="comment">!            IIterativeVariableUniqueIDs(IArrayIndex,2) = &amp;</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="comment">!                  IAtomsToRefine(INT(CEILING(REAL(jnd/6.0D0,RKIND))))</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="comment">!            IAnisotropicDebyeWallerFactorElementNo = &amp;</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;  <span class="comment">!                  NINT(6.D0*(REAL(jnd/6.0D0,RKIND) - &amp;</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  <span class="comment">!                  CEILING(REAL(jnd/6.0D0,RKIND)))+6.0D0)</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="comment">!            SELECT CASE(IAnisotropicDebyeWallerFactorElementNo)</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  <span class="comment">!            CASE(1)</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;  <span class="comment">!              IIterativeVariableUniqueIDs(IArrayIndex,4:5) = [1,1]</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  <span class="comment">!            CASE(2)</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  <span class="comment">!              IIterativeVariableUniqueIDs(IArrayIndex,4:5) = [2,1]</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;  <span class="comment">!            CASE(3)</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  <span class="comment">!              IIterativeVariableUniqueIDs(IArrayIndex,4:5) = [2,2]</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  <span class="comment">!            CASE(4)</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  <span class="comment">!              IIterativeVariableUniqueIDs(IArrayIndex,4:5) = [3,1]</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  <span class="comment">!            CASE(5)</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="comment">!              IIterativeVariableUniqueIDs(IArrayIndex,4:5) = [3,2]</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <span class="comment">!            CASE(6)</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;  <span class="comment">!              IIterativeVariableUniqueIDs(IArrayIndex,4:5) = [3,3]</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  <span class="comment">!            END SELECT</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;            <span class="keywordflow">CASE</span>(6) <span class="comment">! Lattice Parameters, E</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,2) = &amp;</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                    nint(3.d0*(<span class="keywordtype">REAL(jnd/3.0D0,RKIND)</span> - CEILING(<span class="keywordtype">REAL</span>(jnd/3.0d0,rkind)))+3.0d0)</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;               </div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            <span class="keywordflow">CASE</span>(7) <span class="comment">! Lattice Angles, F</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,2) = &amp;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                    nint(3.d0*(<span class="keywordtype">REAL(jnd/3.0D0,RKIND)</span> - CEILING(<span class="keywordtype">REAL</span>(jnd/3.0d0,rkind)))+3.0d0)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;            <span class="keywordflow">CASE</span>(8) <span class="comment">! Convergence angle, H</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="keywordflow">CASE</span>(9) <span class="comment">! Percentage Absorption, I</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;            <span class="keywordflow">CASE</span>(10) <span class="comment">! kV, J</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;              <a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(iarrayindex,1) = ind</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="keywordflow">            END SELECT</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keywordflow">          END DO</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keywordflow">      END DO</span> </div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  <span class="comment">! allocate, ImageInitialisation, ImageMaskInitialisation</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a27f30c68e56d029e40941f7ac0963448">rhklpositions</a>(<a class="code" href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">nreflections</a>,2),stat=ierr)</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RhklPositions&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespaceipara.html#a038c7fed38c8836d5512fe816e27e3b7">imask</a>(2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>),stat=ierr)</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RhklPositions&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceimage__initialisation__mod.html#a57132a9ff98ab1f59b056f268f0cd446">imageinitialisation</a>( ierr )</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ImageInitialisation&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;  <span class="comment">! creates circular or square image mask depending upon IMaskFLAG and assign </span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;  <span class="comment">! IPixelLocations ALLOCATED here</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespaceimage__initialisation__mod.html#aeef829221538e73b32c971174e409878">imagemaskinitialisation</a>(ierr)</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ImageMaskInitialisation&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  <span class="comment">! allocate &amp; setup image arrays for pixel-parallel simulations</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="comment">! All the individual calculations go into RSimulatedPatterns later with MPI_GATHERV</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  <span class="comment">! NB RSimulatedPatterns is a vector with respect to pixels, not a 2D image</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a907dadcc6ec52933b1333320ac15a88a">rsimulatedpatterns</a>(<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>,<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>,<a class="code" href="namespaceipara.html#afc0dd3ec460044c563736fb0843695fb">ipixeltotal</a>),stat=ierr)</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RSimulatedPatterns&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;  <span class="comment">! Images to match RImageExpi</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#ab72431aad9e9d382dc1f476e49bc2a32">rimagesimi</a>(2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>,<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>),&amp;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        stat=ierr)</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RImageSimi&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;  <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#ac39bf45c011d1e46a07b6c347dfc9a30">icorrelationflag</a>.EQ.3) <span class="keywordflow">THEN</span> <span class="comment">! allocate images for masked correlation</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <span class="comment">! Baseline Images to calculate mask</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a6ab2df0cea1276c566d73bbead89897a">rimagebase</a>(2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>,<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>),&amp;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;          stat=ierr)</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RImageBase&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="comment">! Average Images to calculate mask</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#aadce6fc00eb10274490391bec2a2e187">rimageavi</a>(2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>,<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>),&amp;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;          stat=ierr)</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RImageAvi&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <a class="code" href="namespacerpara.html#aadce6fc00eb10274490391bec2a2e187">rimageavi</a>=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    <span class="comment">! Mask Images</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rimagemask</a>(2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>),stat=ierr)</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RImageMask&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  <a class="code" href="namespacerpara.html#a907dadcc6ec52933b1333320ac15a88a">rsimulatedpatterns</a> = <a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;  <span class="comment">! The pixels to be calculated by this core  </span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  <a class="code" href="namespaceipara.html#a460470fc5decb9c0737a769aaa625f25">ilocalpixelcountmin</a>= (<a class="code" href="namespaceipara.html#afc0dd3ec460044c563736fb0843695fb">ipixeltotal</a>*(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>)+1</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;  <a class="code" href="namespaceipara.html#a1998b5137425282bf883191b9f895a9c">ilocalpixelcountmax</a>= (<a class="code" href="namespaceipara.html#afc0dd3ec460044c563736fb0843695fb">ipixeltotal</a>*(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>+1)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>) </div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#af0fc16b6134b0c3859d4484c8c2c1622">rindividualreflections</a>(<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>,<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>,&amp;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;         (<a class="code" href="namespaceipara.html#a1998b5137425282bf883191b9f895a9c">ilocalpixelcountmax</a>-<a class="code" href="namespaceipara.html#a460470fc5decb9c0737a769aaa625f25">ilocalpixelcountmin</a>)+1),stat=ierr)</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RIndividualReflections&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  <span class="comment">! position of pixels calculated by this core, IDisplacements &amp; ICount are global variables</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;  <span class="keyword">ALLOCATE</span>(<a class="code" href="namespaceipara.html#a387bc1758e5dc90d95e76e6e14aa5e39">idisplacements</a>(<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>),<a class="code" href="namespaceipara.html#a9c00e2225af3c6d6460906caa90fcc73">icount</a>(<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>),stat=ierr)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;allocate RhklPositions&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  <span class="keywordflow">DO</span> ind = 1,<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <a class="code" href="namespaceipara.html#a387bc1758e5dc90d95e76e6e14aa5e39">idisplacements</a>(ind) = (<a class="code" href="namespaceipara.html#afc0dd3ec460044c563736fb0843695fb">ipixeltotal</a>*(ind-1)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>)*<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>*<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <a class="code" href="namespaceipara.html#a9c00e2225af3c6d6460906caa90fcc73">icount</a>(ind) = (((<a class="code" href="namespaceipara.html#afc0dd3ec460044c563736fb0843695fb">ipixeltotal</a>*(ind)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>) - (<a class="code" href="namespaceipara.html#afc0dd3ec460044c563736fb0843695fb">ipixeltotal</a>*(ind-1)/<a class="code" href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">p</a>)))* &amp;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;          <a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a>*<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>    </div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordflow">  END DO</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;  <span class="comment">! baseline simulation</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  <a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>=666.666 <span class="comment">! Initial large value, diabolically</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  iter = 0</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;  <span class="comment">! baseline simulation with timer</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#a399ecac264d4f6480f5ee698c94d2fce">simulate</a>(ierr)</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;Simulate&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacemessage__mod.html#a984a91f7533b6975ca99ebe57ed9f770">printendtime</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,istarttime2, <span class="stringliteral">&quot;Simulation&quot;</span> )</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="comment">! baseline simulation</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  iexitflag = 0 <span class="comment">! Do not exit</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <a class="code" href="namespaceipara.html#acb7d51a164ff0fb9b6817c94e6d9cdb9">ipreviousprintediteration</a> = 0  <span class="comment">! ensures baseline simulation is printed</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#affe4955befe0b01618d77941d0c70fe9">isimflag</a>.EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! Simulation only mode   </span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  </div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <span class="comment">! simulation only mode</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    </div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    <span class="comment">! simulate multiple thicknesses</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="keywordflow">IF</span>(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>.EQ.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Writing simulations with the number of thicknesses =&quot;</span>, <a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a>)</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      <span class="keywordflow">DO</span> ithicknessindex = 1,<a class="code" href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ithicknesscount</a></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#ace6e8de1fd70ac8abeca26778da0cf5b">writeiterationoutput</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutput&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a> </div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="keywordflow">      END DO</span>  </div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="keywordflow">    END IF</span> </div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;  </div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  <span class="keywordflow">ELSE</span> <span class="comment">! Refinement Mode</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="keywordflow">IF</span>(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>.EQ.0) then<span class="comment">!outputs to disc come from core 0 only</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      <span class="comment">! Figure of merit is passed back as a global variable</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#a47e9366f180d69b9cf263fdb1510d349">figureofmeritandthickness</a>(iter,ithicknessindex,ierr)</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,&amp;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            <span class="stringliteral">&quot;FigureOfMeritAndThickness&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a> </div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;      <span class="comment">! Keep baseline simulation for masked correlation</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;      <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#ac39bf45c011d1e46a07b6c347dfc9a30">icorrelationflag</a>.EQ.3) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <a class="code" href="namespacerpara.html#a6ab2df0cea1276c566d73bbead89897a">rimagebase</a>=<a class="code" href="namespacerpara.html#ab72431aad9e9d382dc1f476e49bc2a32">rimagesimi</a>  </div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        <a class="code" href="namespacerpara.html#aadce6fc00eb10274490391bec2a2e187">rimageavi</a>=<a class="code" href="namespacerpara.html#ab72431aad9e9d382dc1f476e49bc2a32">rimagesimi</a> </div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Writing output; baseline simulation&quot;</span> )</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#ace6e8de1fd70ac8abeca26778da0cf5b">writeiterationoutput</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutput&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    </div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <span class="comment">!===================================== ! Send the fit index to all cores</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="keyword">CALL </span>mpi_bcast(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,1,mpi_double_precision,0,mpi_comm_world,ierr)</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="comment">!=====================================</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  </div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <span class="comment">! Iterations and refinement begin</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="comment">! Branch depending upon refinement method</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="comment">! We have INoOfVariables to refine, held in RIndependentVariable(1:INoOfVariables)</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    <span class="comment">! For single variables, their type is held in </span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="comment">! IIterativeVariableUniqueIDs(1:INoOfVariables,2)</span></div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">SELECT CASE</span>(<a class="code" href="namespaceipara.html#a627e840f6bb077220aae0df2e14f4a8e">irefinemethodflag</a>)</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    <span class="keywordflow">CASE</span>(1)</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;      <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a320beee495d927712cf38ff1119d0eef">simplexrefinement</a></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;SimplexRefinement&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a> </div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    </div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="keywordflow">CASE</span>(2)</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;      <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a8b553926c9c6f1855ce2f6873c4204b8">maxgradientrefinement</a></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a> </div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;      </div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="keywordflow">CASE</span>(3)</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;      <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#aa3ac25cfee1d00cf8de55756f300626e">parabolicrefinement</a></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>)) <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a> </div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;     </div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="keywordflow">    CASE DEFAULT</span> <span class="comment">! Simulation only, should never happen</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;No refinement, simulation only&quot;</span>)</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;       </div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="keywordflow">    END SELECT</span> </div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="comment">! deallocate Memory</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacecpara.html#ab994df5c023832e6fbc15e15b5b28358">cugmat</a>,stat=ierr) </div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cugmatnoabs</a>,stat=ierr)</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cugmatprime</a>,stat=ierr)</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">isymmetryrelations</a>,stat=ierr)</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespaceipara.html#aced1da6491258b042163e55f4231e905">iequivalentugkey</a>,stat=ierr)</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cuniqueug</a>,stat=ierr)</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#af0fc16b6134b0c3859d4484c8c2c1622">rindividualreflections</a>,stat=ierr)</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespaceipara.html#a387bc1758e5dc90d95e76e6e14aa5e39">idisplacements</a>,stat=ierr)</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespaceipara.html#a9c00e2225af3c6d6460906caa90fcc73">icount</a>,stat=ierr)</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>,stat=ierr)</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rgpoolmag</a>,stat=ierr)</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rgpool</a>,stat=ierr)</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rgmatrix</a>,stat=ierr)</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#a9d1675bd0647c4bdb98816ea5d62623f">rgsummat</a>,stat=ierr)</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#a907dadcc6ec52933b1333320ac15a88a">rsimulatedpatterns</a>,stat=ierr)</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#a0876e889f6ebb06fa81cc8276ec6a131">ratomposition</a>,stat=ierr)</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacespara.html#a6a49bd4357ec329e1bb9c4de6be9c276">satomname</a>,stat=ierr)</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#aefec739ba942da517044c39761b42979">risodw</a>,stat=ierr)</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">roccupancy</a>,stat=ierr)</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">iatomicnumber</a>,stat=ierr)</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespaceipara.html#adee5a4247435a83b19c439de4b1f3138">ianisodw</a>,stat=ierr)</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">ratomcoordinate</a>,stat=ierr)</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rgmatrixmagnitude</a>,stat=ierr)</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpseudoatom</a>,stat=ierr)</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpseudoscatt</a>,stat=ierr)</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;  <span class="comment">! These are global variables, see smodules.f90</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;  <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(1).EQ.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>,stat=ierr)</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="keywordflow">  END IF</span></div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#affe4955befe0b01618d77941d0c70fe9">isimflag</a>.EQ.0) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="keyword">DEALLOCATE</span>(<a class="code" href="namespacerpara.html#ace33cd9a5b6ab325821876a86059d399">rimageexpi</a>,stat=ierr)  </div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="keywordflow">  END IF</span>  </div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  </div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  <span class="comment">! finish off</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;  <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;--------------------------------&quot;</span> )</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;  <span class="keyword">CALL </span><a class="code" href="namespacemessage__mod.html#a984a91f7533b6975ca99ebe57ed9f770">printendtime</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, istarttime, <span class="stringliteral">&quot;Calculation&quot;</span> )</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;--------------------------------&quot;</span>)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;||||||||||||||||||||||||||||||||&quot;</span>)</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  </div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <span class="comment">! clean shutdown</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keyword">CALL </span>mpi_finalize(ierr)</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;  stop</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  </div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="keyword">CONTAINS</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  <span class="comment">! these internal SUBROUTINEs use felixrefine&#39;s whole variable namespace</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00882"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">  882</a></span>&#160;    ierr=1</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;felixrefine&quot;</span>,<span class="stringliteral">&quot;ABORTING&quot;</span>)) <span class="keywordflow">CONTINUE</span> </div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="keyword">CALL </span>mpi_abort(mpi_comm_world,1,ierr)</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    stop</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a320beee495d927712cf38ff1119d0eef">simplexrefinement</a></div><div class="line"><a name="l00894"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#a320beee495d927712cf38ff1119d0eef">  894</a></span>&#160;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="comment">! array allocations &amp; make simplex matrix parallel</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    <span class="keyword">ALLOCATE</span>(rsimplexvariable(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>), stat=ierr)  </div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keyword">ALLOCATE</span>(rsimplexfom(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1),stat=ierr)  </div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    <span class="keywordflow">IF</span>(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>.EQ.0) <span class="keywordflow">THEN</span> <span class="comment">!?? Since simplex not random, could be calculated by all cores</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        <span class="keyword">ALLOCATE</span>(rones(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>), stat=ierr) <span class="comment">! matrix of ones</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SimplexRefinement&quot;</span>,<span class="stringliteral">&quot;allocate ROnes&quot;</span>)) <span class="keywordflow">RETURN</span> </div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;      <span class="comment">! matrix of one +/-RSimplexLengthScale</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        <span class="keyword">ALLOCATE</span>(rsimp(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>), stat=ierr)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SimplexRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RSimp&quot;</span>)) <span class="keywordflow">RETURN</span> </div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;      <span class="comment">! diagonal matrix of variables as rows</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="keyword">ALLOCATE</span>(rvarmatrix(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>), stat=ierr)</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SimplexRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RVarMatrix&quot;</span>)) <span class="keywordflow">RETURN</span> </div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        rones=<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        rsimp=<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        rvarmatrix=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        <span class="keywordflow">FORALL</span>(ind = 1:<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>) rsimp(ind,ind) = -1.0</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        rsimp=rsimp*<a class="code" href="namespacerpara.html#a43818a014ce924c6df2ba2632e15741c">rsimplexlengthscale</a> + rones</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        <span class="keywordflow">FORALL</span>(ind = 1:<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>) rvarmatrix(ind,ind) = rindependentvariable(ind)</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        rsimplexvariable=matmul(rsimp,rvarmatrix)</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="comment">!===================================== ! send RSimplexVariable OUT to all cores</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="keyword">CALL </span>mpi_bcast(rsimplexvariable,(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1)*(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),&amp;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;          mpi_double_precision,0,mpi_comm_world,ierr)</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="comment">!=====================================</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="comment">! perform initial simplex simulations</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="keywordflow">DO</span> ind = 1,(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1)</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;--------------------------------&quot;</span>)</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<a class="code" href="namespacemessage__mod.html#a62189da4447c39939fe1e822e897b1a5">no_tag</a>,<span class="stringliteral">&quot;Simplex &quot;</span>,ind, <span class="stringliteral">&quot; of &quot;</span>, <a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1)</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;--------------------------------&quot;</span>)</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rsimplexvariable(ind,:),iter,ithicknessindex,ierr)<span class="comment">! Working as iteration 0?</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SimplexRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;      rsimplexfom(ind)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a> <span class="comment">! RFigureofMerit returned as global variable</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;      <span class="comment">! For masked correlation, add to &#39;average&#39; (extreme difference from baseline)?</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;      <span class="keywordflow">IF</span>(<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>.EQ.0.AND.<a class="code" href="namespaceipara.html#ac39bf45c011d1e46a07b6c347dfc9a30">icorrelationflag</a>.EQ.3) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        <span class="comment">! replace pixels that are the most different from baseline</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        <span class="keywordflow">WHERE</span> (abs(<a class="code" href="namespacerpara.html#ab72431aad9e9d382dc1f476e49bc2a32">rimagesimi</a>-<a class="code" href="namespacerpara.html#a6ab2df0cea1276c566d73bbead89897a">rimagebase</a>).GT.abs(<a class="code" href="namespacerpara.html#aadce6fc00eb10274490391bec2a2e187">rimageavi</a>-<a class="code" href="namespacerpara.html#a6ab2df0cea1276c566d73bbead89897a">rimagebase</a>))</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;          <a class="code" href="namespacerpara.html#aadce6fc00eb10274490391bec2a2e187">rimageavi</a>=<a class="code" href="namespacerpara.html#ab72431aad9e9d382dc1f476e49bc2a32">rimagesimi</a></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="keywordflow">        END WHERE</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="comment">! set up masked fitting using the simplex setup</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    <span class="keywordflow">IF</span> (<a class="code" href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">my_rank</a>.EQ.0.AND.<a class="code" href="namespaceipara.html#ac39bf45c011d1e46a07b6c347dfc9a30">icorrelationflag</a>.EQ.3) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;      <span class="comment">! Simple start, just take thickness 1 </span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;      <a class="code" href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rimagemask</a>=<a class="code" href="namespacerpara.html#aadce6fc00eb10274490391bec2a2e187">rimageavi</a>(:,:,:,1)-<a class="code" href="namespacerpara.html#a6ab2df0cea1276c566d73bbead89897a">rimagebase</a>(:,:,:,1)</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;      <span class="keywordflow">DO</span> ind = 1,<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a> <span class="comment">! mask each pattern individually</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        <span class="keywordflow">WHERE</span> (abs(<a class="code" href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rimagemask</a>(:,:,ind)).GT.0.1*maxval(abs(<a class="code" href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rimagemask</a>(:,:,ind))))</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;          <a class="code" href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rimagemask</a>(:,:,ind)=<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        <span class="keywordflow">ELSEWHERE</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;          <a class="code" href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rimagemask</a>(:,:,ind)=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;<span class="keywordflow">        END WHERE</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="keywordflow">      END DO</span>    </div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;      <span class="comment">! debug mode output to look at the masks</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;      <span class="keywordflow">IF</span> (<a class="code" href="namespacemessage__mod.html#af236d5d3b839d2a65cef3e50743f688b">dbg6</a>%LState) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        <span class="keyword">ALLOCATE</span>(rtestimage(2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>),stat=ierr)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        <span class="keywordflow">DO</span> ind = 1,<a class="code" href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">inooflacbedpatterns</a></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;          rtestimage=<a class="code" href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rimagemask</a>(:,:,ind)</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;          <span class="keyword">WRITE</span>(h,*)  nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(<a class="code" href="namespaceipara.html#a6217500ff5d28cf24b5019959cb75134">ioutputreflections</a>(ind),1))</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;          <span class="keyword">WRITE</span>(k,*)  nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(<a class="code" href="namespaceipara.html#a6217500ff5d28cf24b5019959cb75134">ioutputreflections</a>(ind),2))</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;          <span class="keyword">WRITE</span>(l,*)  nint(<a class="code" href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rhkl</a>(<a class="code" href="namespaceipara.html#a6217500ff5d28cf24b5019959cb75134">ioutputreflections</a>(ind),3))</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;          <span class="keyword">WRITE</span>(sprintstring,*) trim(adjustl(h)),trim(adjustl(k)),trim(adjustl(l)),<span class="stringliteral">&quot;.mask&quot;</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;          <span class="keyword">OPEN</span>(unit=<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>, status= <span class="stringliteral">&#39;UNKNOWN&#39;</span>, file=sprintstring,&amp;</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                form=<span class="stringliteral">&#39;UNFORMATTED&#39;</span>,access=<span class="stringliteral">&#39;DIRECT&#39;</span>,iostat=ierr,recl=2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a>*8)</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SimplexRefinement&quot;</span>,<span class="stringliteral">&quot;writing .mask file&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;          <span class="keywordflow">DO</span> jnd = 1,2*<a class="code" href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipixelcount</a></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            <span class="keyword">WRITE</span>(<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>,rec=jnd) rtestimage(jnd,:)</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;<span class="keywordflow">          END DO</span></div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;          <span class="keyword">CLOSE</span>(<a class="code" href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichoutwiimage</a>,iostat=ierr)</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;<span class="keywordflow">        END DO</span></div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        <span class="keyword">DEALLOCATE</span>(rtestimage)</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    </div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    <span class="comment">! Apply Simplex Method and iterate</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;    iter = 1  </div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespacesimplex__mod.html#a73ec7894bf3ce6e62d9638f50cdefdbc">ndimensionaldownhillsimplex</a>(rsimplexvariable,rsimplexfom,&amp;</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;          <a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>+1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>,&amp;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;          <a class="code" href="namespacerpara.html#af0e6a45e493ff75f8f7e03d528f59ba9">rexitcriteria</a>,iter,rstandarddeviation,rmean,ierr)</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SimplexRefinement&quot;</span>,<span class="stringliteral">&quot;NDimensionalDownhillSimplex&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a320beee495d927712cf38ff1119d0eef">simplexrefinement</a></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;  <span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  </div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a8b553926c9c6f1855ce2f6873c4204b8">maxgradientrefinement</a></div><div class="line"><a name="l00999"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#a8b553926c9c6f1855ce2f6873c4204b8">  999</a></span>&#160;</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    <span class="comment">! allocations &amp; intialise refinement variables</span></div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="keyword">ALLOCATE</span>(rvar0(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)<span class="comment">! incoming set of variables</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RVar0&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="comment">! set of variables to send out for simulations</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    <span class="keyword">ALLOCATE</span>(rcurrentvar(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RCurrentVar&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    <span class="keyword">ALLOCATE</span>(rlastvar(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr) <span class="comment">! set of variables updated each cycle</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RLastVar&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="comment">! the vector describing the current line in parameter space</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keyword">ALLOCATE</span>(rpvec(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RPVec&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="comment">! the list of fit indices resulting from small changes Rdf for each variable in RPVec</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="keyword">ALLOCATE</span>(rfitvec(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RFitVec&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    </div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    rbestfit=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    rlastfit=rbestfit</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    rlastvar=rindependentvariable</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    rcurrentvar=<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    rdf=<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    rscale=<a class="code" href="namespacerpara.html#a43818a014ce924c6df2ba2632e15741c">rsimplexlengthscale</a></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    nnd=0 <span class="comment">! max/min gradient flag</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="comment">! iteratively refine until improvement in fit below exit criteria</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="comment">!\/------------------------------------------------------------------</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="keywordflow">DO</span> <span class="keywordflow">WHILE</span> (rdf.GE.<a class="code" href="namespacerpara.html#af0e6a45e493ff75f8f7e03d528f59ba9">rexitcriteria</a>)</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      rvar0=rindependentvariable <span class="comment">! incoming point in n-dimensional parameter space</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;      rfit0=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a> <span class="comment">! incoming fit</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;      <span class="comment">! change max gradient vector (RPVec) depending upon max/min gradient situation </span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;      <span class="comment">!--------------------------------------------------------------------      </span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;      </div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;      <span class="keywordflow">IF</span> (nnd.EQ.0) <span class="keywordflow">THEN</span> <span class="comment">! max gradient</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        <span class="keywordflow">DO</span> ind=1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a> <span class="comment">! calculate individual gradients</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;          <span class="comment">! The type of variable being refined </span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;          ivariabletype=<a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(ind,1) </div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;          <span class="comment">! variable type as in what refinement mode/variables, &#39;type&#39; used throughout</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;           </div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;          <span class="comment">! print to screen</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;          <span class="keywordflow">SELECT CASE</span>(ivariabletype)</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;            <span class="keywordflow">CASE</span>(1)</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;              <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Ug refinement&quot;</span>)</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;            <span class="keywordflow">CASE</span>(2)</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;              <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Atomic coordinate refinement&quot;</span>)</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            <span class="keywordflow">CASE</span>(3)</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;              <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Occupancy refinement&quot;</span>)</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;            <span class="keywordflow">CASE</span>(4)</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;              <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Isotropic Debye-Waller factor refinement&quot;</span>)</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;            <span class="keywordflow">CASE</span>(5)</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;              <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Convergence angle refinement&quot;</span>)</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="keywordflow">          END SELECT</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;          <span class="keywordflow">IF</span> (rcurrentvar(ind).LE.<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>.AND.ivariabletype.EQ.4) <span class="keywordflow">THEN</span> <span class="comment">! skip zero DW factor</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;            rpvec(ind)=<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            cycle</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;          <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A18,I3,A4,I3)&#39;</span>) <span class="stringliteral">&quot;Finding gradient, &quot;</span>,ind,<span class="stringliteral">&quot; of &quot;</span>,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;          sprintstring=trim(adjustl(sprintstring))</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,sprintstring)</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;          <span class="comment">! Make a random number to vary the sign of dx, using system clock</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;          <span class="keyword">CALL </span>system_clock(mnd)</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;          rdx=(<span class="keywordtype">REAL</span>(mod(mnd,10))/TEN)-0.45 <span class="comment">! numbers 0-4 give minus, 5-9 give plus</span></div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;          rdx=0.1*rdx*rscale/abs(rdx) <span class="comment">! small change in current variable (RScale/10)is dx</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;          rcurrentvar=rvar0</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;          rcurrentvar(ind)=rcurrentvar(ind)+rdx</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;          <span class="comment">! Do not increment iteration here nor write iteration output</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;          iter=iter+1</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;          <span class="comment">! BestFitCheck copies RCurrentVar into RIndependentVariable</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;          <span class="comment">! and updates RBestFit if the fit is better</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;          rfitvec(ind)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;          rpvec(ind)=(rfit0-<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>)/rdx <span class="comment">! -df/dx: need the dx to keep track of sign</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="keywordflow">        END DO</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;        nnd=1 <span class="comment">! do min gradient next time</span></div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;      <span class="keywordflow">ELSE</span> <span class="comment">! min gradient - to explore along a valley</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="keywordflow">DO</span> ind=1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;          <span class="comment">! invert gradient</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;          <span class="keywordflow">IF</span> (abs(rpvec(ind)).GT.<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>) <span class="keywordflow">THEN</span> <span class="comment">! don&#39;t invert zeros</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            rpvec(ind)=1/rpvec(ind)</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;          <span class="keywordflow">ELSE</span> <span class="comment">! just make them quite big</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            rpvec(ind)=ten</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="keywordflow">        END DO</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Checking minimum gradient&quot;</span>)</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        nnd=0 <span class="comment">! do max gradient next time</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;      </div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      <span class="comment">! normalise the max gradient vector RPvec &amp; set the first point</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;      rpvecmag=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      <span class="keywordflow">DO</span> ind=1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        rpvecmag=rpvecmag+rpvec(ind)**2</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;      <span class="keywordflow">IF</span> ((rpvecmag-<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>.EQ.rpvecmag).OR.(rpvecmag.NE.rpvecmag)) <span class="keywordflow">THEN</span> <span class="comment">! Infinity and NaN check</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        ierr=1</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        <span class="keyword">WRITE</span>(sprintstring,*) rpvec</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,&amp;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;              <span class="stringliteral">&quot;Infinity or NaN error, refinement vector =&quot;</span>//trim(sprintstring))) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;      rpvec=rpvec/sqrt(rpvecmag) <span class="comment">! unity vector along direction of max gradient</span></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;      <span class="keyword">WRITE</span>(sprintstring,*) <span class="stringliteral">&quot;(A18,&quot;</span>,<span class="keyword">SIZE</span>(rpvec),<span class="stringliteral">&quot;(F7.4,1X))&quot;</span></div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;      <span class="keyword">WRITE</span>(sprintstring,fmt=sprintstring)<span class="stringliteral">&quot;Refinement vector &quot;</span>,rpvec</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;      sprintstring=trim(adjustl(sprintstring))</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,sprintstring)</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;      rvar0=rindependentvariable <span class="comment">! the best point of gradient calculation</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;      <a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>=rbestfit <span class="comment">! the best fit so far</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;      <span class="comment">! First point, three points to find the miniimum</span></div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;      r3var(1)=rvar0(1)<span class="comment">! first point is current value</span></div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;      r3fit(1)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a><span class="comment">! point 1 is the incoming simulation and fit index</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;      rpvecmag=rvar0(1)*rscale <span class="comment">! RPvecMag gives the magnitude of vector in parameter space</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;      rcurrentvar=rvar0+rpvec*rpvecmag <span class="comment">! Update the parameters to simulate</span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;      </div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;      <span class="comment">! simulate and set the 2nd and 3rd point</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;      <span class="comment">! Second point</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;      r3var(2)=rcurrentvar(1) </div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<span class="stringliteral">&quot;Refining, point 2 of 3&quot;</span>)</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;      iter=iter+1</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;      <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;      r3fit(2)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;      <span class="comment">! Third point</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;      <span class="keywordflow">IF</span> (r3fit(2).GT.r3fit(1)) <span class="keywordflow">THEN</span> <span class="comment">! new 2 is not better than 1, go the other way</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        rpvecmag=-rpvecmag</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;      <span class="keywordflow">ELSE</span> <span class="comment">! it is better, so keep going</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        rvar0=rcurrentvar</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      rcurrentvar=rvar0+rpvec*rpvecmag</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;      r3var(3)=rcurrentvar(1) <span class="comment">! third point</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Refining, point 3 of 3&quot;</span>)</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;      iter=iter+1</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;      <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;      r3fit(3)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;      <span class="comment">! iterate until 3 points concave set</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;      <span class="comment">! check the three points make a concave set</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;      jnd=maxloc(r3var,1) <span class="comment">! highest x</span></div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;      knd=minloc(r3var,1) <span class="comment">! lowest x</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;      lnd=6-jnd-knd <span class="comment">! the mid x</span></div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;      <span class="comment">! Rtest=0.0 would be a straight line, &gt;0=convex, &lt;0=concave</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;      rtest=-abs(r3fit(jnd)-r3fit(knd))</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;      <span class="comment">! Rconvex is the calculated fit index at the mid x,</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      <span class="comment">! if ithere was a straight line between lowest and highest x</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;      rconvex=r3fit(lnd)-(r3fit(knd)+(r3var(lnd)-r3var(knd))*&amp;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;            (r3fit(jnd)-r3fit(knd))/(r3var(jnd)-r3var(knd)))</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;      </div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;      <span class="comment">! if it isn&#39;t more than 10% concave, keep going until it is sufficiently concave</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;      <span class="keywordflow">DO</span> <span class="keywordflow">WHILE</span> (rconvex.GT.0.1*rtest)</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Convex, continuing&quot;</span>)</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        jnd=maxloc(r3fit,1) <span class="comment">! worst fit</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        knd=minloc(r3fit,1) <span class="comment">! best fit</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;        lnd=6-jnd-knd <span class="comment">! the mid fit</span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        <span class="comment">! replace mid point with a step on from best point</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        <span class="comment">!?? RB increase the step size by the golden ratio</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        <span class="comment">!?? RPvecMag=(R3var(knd)-RVar0(1))*(0.5+SQRT(5.0)/2.0)/RPvec(1)</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        rpvecmag=<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*rpvecmag <span class="comment">! double the step size</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;        <span class="comment">! maximum step in Ug is RMaxUgStep</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        <span class="keywordflow">IF</span> (abs(rpvecmag).GT.rmaxugstep.AND.<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(1).EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;          rpvecmag=sign(rmaxugstep,rpvecmag)</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;        rcurrentvar=rvar0+rpvec*rpvecmag</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        r3var(lnd)=rcurrentvar(1)<span class="comment">! next point</span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        iter=iter+1</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        r3fit(lnd)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        jnd=maxloc(r3var,1) <span class="comment">! highest x</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        knd=minloc(r3var,1) <span class="comment">! lowest x</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        lnd=6-jnd-knd <span class="comment">! the mid x</span></div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        rconvex=r3fit(lnd)-(r3fit(knd)+(r3var(lnd)-r3var(knd))*&amp;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;              (r3fit(jnd)-r3fit(knd))/(r3var(jnd)-r3var(knd)))</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        rtest=-abs(r3fit(jnd)-r3fit(knd))</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;      <span class="comment">! make prediction and update last fit</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      <span class="comment">! now make a prediction</span></div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a054997d70bc773359dcc5c88b3c86445">parabo3</a>(r3var,r3fit,rvarmin,rfitmin,ierr)</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;      <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A32,F7.4,A16,F7.4)&#39;</span>) &amp;</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;      <span class="stringliteral">&quot;Concave set, predict minimum at &quot;</span>,rvarmin,<span class="stringliteral">&quot; with fit index &quot;</span>,rfitmin</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;      sprintstring=trim(adjustl(sprintstring))</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;      <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> (<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, sprintstring)</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;      rcurrentvar=rvar0+rpvec*(rvarmin-rvar0(1))/rpvec(1) <span class="comment">! Put prediction into RCurrentVar</span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;      iter=iter+1</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;      <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;      <span class="comment">! check where we go next and update last fit etc.</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;      <span class="keywordflow">IF</span> (nnd.EQ.0) <span class="keywordflow">THEN</span> <span class="comment">! only update LastFit after a max gradient refinement</span></div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        rdf=rlastfit-rbestfit </div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        rlastfit=rbestfit</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;--------------------------------&quot;</span>)</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;        <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A19,F8.6,A15,F8.6)&#39;</span>) <span class="stringliteral">&quot;Improvement in fit &quot;</span>,rdf,<span class="stringliteral">&quot;, will stop at &quot;</span>,<a class="code" href="namespacerpara.html#af0e6a45e493ff75f8f7e03d528f59ba9">rexitcriteria</a></div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> (<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, sprintstring)</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;      <span class="comment">! shrink length scale as we progress, by a smaller amount</span></div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;      <span class="comment">! depending on the no of variables: 1-&gt;1/2; 2-&gt;3/4; 3-&gt;5/6; 4-&gt;7/8; 5-&gt;9/10;</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;      rscale=rscale*(<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>-<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>/(<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>)))</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <span class="comment">!/\------------------------------------------------------------------</span></div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;  </div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="comment">! We are done, simulate and output the best fit</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    iexitflag=1</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    iter=iter+1</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rindependentvariable,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;MaxGradientRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    <span class="keyword">DEALLOCATE</span>(rvar0,rcurrentvar,rlastvar,rpvec,rfitvec,stat=ierr)  </div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a8b553926c9c6f1855ce2f6873c4204b8">maxgradientrefinement</a></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;  <span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#aa3ac25cfee1d00cf8de55756f300626e">parabolicrefinement</a></div><div class="line"><a name="l01253"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#aa3ac25cfee1d00cf8de55756f300626e"> 1253</a></span>&#160;</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <span class="comment">! allocate &amp; intilise refinement variables</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    <span class="keyword">ALLOCATE</span>(rvar0(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)<span class="comment">! incoming set of variables</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RVar0&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    <span class="comment">! set of variables to send out for simulations</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;    <span class="keyword">ALLOCATE</span>(rcurrentvar(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RCurrentVar&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    <span class="keyword">ALLOCATE</span>(rlastvar(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)<span class="comment">! set of variables updated each cycle</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RLastVar&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    <span class="comment">! the vector describing the current line in parameter space</span></div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    <span class="keyword">ALLOCATE</span>(rpvec(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>),stat=ierr)</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;allocate RPVec&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    rlastfit=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    rlastvar=rindependentvariable</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    rbestfit=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    rdf=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    icycle=0 </div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    rscale=<a class="code" href="namespacerpara.html#a43818a014ce924c6df2ba2632e15741c">rsimplexlengthscale</a></div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    rmaxugstep=0.005 <span class="comment">! maximum step in Ug is 0.5 nm^-2, 0.005 A^-2</span></div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <span class="comment">! iteratively refine until improvement in fit below exit criteria</span></div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="comment">!--------------------------------------------------------------------   </span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    <span class="comment">! Each complete cycle we will look down the average refinement direction</span></div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    <span class="comment">!\/\/------------------------------------------------------------------</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    <span class="keywordflow">DO</span> <span class="keywordflow">WHILE</span> (rdf.GE.<a class="code" href="namespacerpara.html#af0e6a45e493ff75f8f7e03d528f59ba9">rexitcriteria</a>)</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;      </div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;      <span class="comment">! iterate over each variable to refine</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;      <span class="comment">!\/------------------------------------------------------------------    </span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;      <span class="keywordflow">DO</span> ind=1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        <span class="comment">! optional terminal output types of variables refined</span></div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        ivariabletype=<a class="code" href="namespaceipara.html#a23c03e260666815555342dd982a7c506">iiterativevariableuniqueids</a>(ind,1)</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="keywordflow">SELECT CASE</span>(ivariabletype)</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;          <span class="keywordflow">CASE</span>(1)</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;            <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Ug refinement&quot;</span>)</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;          <span class="keywordflow">CASE</span>(2)</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Atomic coordinate refinement&quot;</span>)</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;          <span class="keywordflow">CASE</span>(3)</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;            <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Occupancy refinement&quot;</span>)</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;          <span class="keywordflow">CASE</span>(4)</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;            <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Isotropic Debye-Waller factor refinement&quot;</span>)</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;          <span class="keywordflow">CASE</span>(5)</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;            <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Convergence angle refinement&quot;</span>)</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="keywordflow">        END SELECT</span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;          <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>.GT.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;            <span class="keywordflow">IF</span> (icycle.EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;              <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Refining all variables&quot;</span>)</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;            <span class="keywordflow">ELSE</span></div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;              <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Refining pairs of variables&quot;</span>)</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="keywordflow">            END IF</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;        <span class="comment">! look down average refinement direction or do pair-wise maximum gradient</span></div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;         rvar0=rindependentvariable <span class="comment">! incoming point in n-dimensional parameter space</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        rpvec=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a> <span class="comment">! Vector in n-dimensional parameter space for this refinement</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>, <span class="stringliteral">&quot;Current parameters=&quot;</span>,rindependentvariable )</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        <span class="keywordflow">IF</span> (icycle.EQ.1) <span class="keywordflow">THEN</span> <span class="comment">! look down the average refinement direction</span></div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;          rpvec=(rcurrentvar-rlastvar)/(rcurrentvar(1)-rlastvar(1))</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;          rpvecmag=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;          <span class="keywordflow">DO</span> jnd=1,<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;            rpvecmag=rpvecmag+rpvec(jnd)**2</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;<span class="keywordflow">          END DO</span></div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;          rpvec=rpvec/sqrt(rpvecmag) <span class="comment">! unity vector</span></div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;          rlastvar=rcurrentvar</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <span class="keywordflow">ELSE</span> <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>.GT.1) <span class="keywordflow">THEN</span> <span class="comment">! pair-wise maximum gradient</span></div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;          <span class="keywordflow">IF</span> (ind.EQ.<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>) <span class="keywordflow">EXIT</span> <span class="comment">! skip the last variable</span></div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>,<a class="code" href="namespacemessage__mod.html#a62189da4447c39939fe1e822e897b1a5">no_tag</a>,&amp;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;                <span class="stringliteral">&quot;Finding maximum gradient for variables&quot;</span>,ind,<span class="stringliteral">&quot; and&quot;</span>,ind+1)</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;          <span class="comment">! NB R3fit CONTAINS the three fit indices</span></div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;          r3fit(1)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a> <span class="comment">! point 1 is the incoming simulation and fit index</span></div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;          rpvec(ind)=rscale/5.0 <span class="comment">! small change in current variable for second point</span></div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;          rcurrentvar=rvar0+rpvec <span class="comment">! second point</span></div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;          r3fit(2)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;          <span class="comment">! now look along combination of 2 parameters for third point</span></div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;          rpvec(ind+1)=rscale/5.0 </div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;          rcurrentvar=rvar0+rpvec <span class="comment">! Update the parameters to simulate</span></div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;          r3fit(3)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;          <span class="comment">! optimum gradient vector from the three points, magnitude unity</span></div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;          rpvec=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a><span class="comment">!reset</span></div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;          rpvecmag=sqrt((r3fit(1)-r3fit(2))**2+(r3fit(2)-r3fit(3))**2)</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;          rpvec(ind)=(r3fit(1)-r3fit(2))/rpvecmag</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;          rpvec(ind+1)=(r3fit(2)-r3fit(3))/rpvecmag</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Refinement vector = &quot;</span>,rpvec)</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        <span class="comment">! Infinity and NaN check and set 1st point</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        <span class="comment">! Infinity and NaN check</span></div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        <span class="keywordflow">IF</span> (abs(sum(rpvec))-1.GT.abs(sum(rpvec)).OR.abs(sum(rpvec)).NE.abs(sum(rpvec))) <span class="keywordflow">EXIT</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        rvar0=rindependentvariable <span class="comment">! the best point of the three</span></div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        <a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>=minval(r3fit) <span class="comment">! the best fit of the three</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;        <span class="comment">! Small DW factor (&lt;0.1) check</span></div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        <span class="keywordflow">IF</span> (ivariabletype.EQ.4.AND.rvar0(ind).LE.0.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Small Debye Waller factor, resetting to 0.1&quot;</span>)</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;          rvar0(ind)=0.1</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;          rcurrentvar=rvar0</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;          rpvecmag=rscale</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;          iter=iter+1</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;          <span class="comment">! update RIndependentVariable if necessary</span></div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;        r3var(1)=rvar0(ind) <span class="comment">! first point is current value</span></div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;        r3fit(1)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a> <span class="comment">! with the current fit index</span></div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;        rpvecmag=rvar0(ind)*rscale  <span class="comment">! magnitude of vector in parameter space</span></div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;        rcurrentvar=rvar0+rpvec*rpvecmag <span class="comment">! Update the parameters to simulate</span></div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>, <span class="stringliteral">&quot;point 1&quot;</span>,r3var(1) )</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>, <span class="stringliteral">&quot;fit&quot;</span>,r3fit(1) )</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> ( <a class="code" href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">ll</a>, <span class="stringliteral">&quot;RPvecMag=&quot;</span>,rpvecmag )</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        <span class="comment">! set 2nd and 3rd point</span></div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;        <span class="comment">! second point</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        r3var(2)=rcurrentvar(ind) </div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;simulation 2&quot;</span>)</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        iter=iter+1</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;        <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        r3fit(2)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        <span class="comment">!CALL message ( LM, &quot;point 2&quot;,R3var(2) )</span></div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        <span class="comment">!CALL message ( LM, &quot;fit&quot;,R3fit(2) )</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;        <span class="comment">!third point</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        <span class="keywordflow">IF</span> (r3fit(2).GT.r3fit(1)) <span class="keywordflow">THEN</span> <span class="comment">! new 2 is not better than 1, go the other way</span></div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;          rpvecmag=-rpvecmag</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;          rcurrentvar=rvar0+rpvec*rpvecmag</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;        <span class="keywordflow">ELSE</span> <span class="comment">! it is better, so keep going</span></div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;          rcurrentvar=rvar0+<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*rpvec*rpvecmag</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        </div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        <span class="comment">! third point</span></div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        r3var(3)=rcurrentvar(ind)</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;        <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;simulation 2&quot;</span>) <span class="comment">!?? JR should this be &#39;simulation 3&#39; for 3rd point (remove this comment once changed)</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;        iter=iter+1</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        r3fit(3)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;        <span class="comment">!CALL message ( LM, &quot;point 3&quot;,R3var(3) )</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        <span class="comment">!CALL message ( LM, &quot;fit&quot;,R3fit(3) )</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;        <span class="comment">!?? repeated code around here like maximum gradient JR</span></div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        <span class="comment">! iterate until 3 points concave set</span></div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;        <span class="comment">! check the three points make a concave set</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        jnd=maxloc(r3var,1) <span class="comment">! highest x</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        knd=minloc(r3var,1) <span class="comment">! lowest x</span></div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;        lnd=6-jnd-knd <span class="comment">! the mid x</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        <span class="comment">! covering the unlikely scenario that all simulations have the same fit index</span></div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;        <span class="keywordflow">IF</span> (jnd.EQ.knd) lnd=jnd</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;        <span class="comment">! Rtest=0.0 would be a straight line, &gt;0=convex, &lt;0=concave</span></div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        rtest=-abs(r3fit(jnd)-r3fit(knd))</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        <span class="comment">! Rconvex is the calculated fit index at the mid x,</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        <span class="comment">! if ithere was a straight line between lowest and highest x</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        rconvex=r3fit(lnd)-(r3fit(knd)+(r3var(lnd)-r3var(knd))*&amp;</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;              (r3fit(jnd)-r3fit(knd))/(r3var(jnd)-r3var(knd)))</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;        <span class="comment">! if it isn&#39;t more than 10% concave, keep going until it is sufficiently concave</span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;        <span class="keywordflow">DO</span> <span class="keywordflow">WHILE</span> (rconvex.GT.0.1*rtest)</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Convex, continuing&quot;</span>)</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;          jnd=maxloc(r3fit,1) <span class="comment">! worst fit</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;          knd=minloc(r3fit,1) <span class="comment">! best fit</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;          lnd=6-jnd-knd <span class="comment">! the mid fit</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;          <span class="comment">! replace mid point with a step on from best point</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;          <span class="comment">! increase the step size by the golden ratio</span></div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;          rpvecmag=(r3var(knd)-rvar0(ind))*(0.5+sqrt(5.0)/2.0)/rpvec(ind)</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;          <span class="comment">! maximum step in Ug is RMaxUgStep</span></div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;          <span class="keywordflow">IF</span> (abs(rpvecmag).GT.rmaxugstep.AND.<a class="code" href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">irefinemode</a>(1).EQ.1) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;            rpvecmag=sign(rmaxugstep,rpvecmag)</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;          </div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;          rcurrentvar=rvar0+rpvec*rpvecmag     </div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;          r3var(lnd)=rcurrentvar(ind)    <span class="comment">! next point</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;          <span class="keywordflow">IF</span> (r3var(lnd).LE.<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>.AND.ivariabletype.EQ.4) <span class="keywordflow">THEN</span> <span class="comment">! less than zero DW is requested</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;            r3var(lnd)=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a> <span class="comment">! limit it to 0.0</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;            rcurrentvar=rvar0-rpvec*rvar0(ind) <span class="comment">! and set up for simulation outside the loop</span></div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;            <span class="keywordflow">EXIT</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;<span class="keywordflow">          END IF</span></div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;          iter=iter+1</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;          r3fit(lnd)=<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;          jnd=maxloc(r3var,1) <span class="comment">! highest x</span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;          knd=minloc(r3var,1) <span class="comment">! lowest x</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;          lnd=6-jnd-knd <span class="comment">! the mid x</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;          rconvex=r3fit(lnd)-(r3fit(knd)+(r3var(lnd)-r3var(knd))*&amp;</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;          (r3fit(jnd)-r3fit(knd))/(r3var(jnd)-r3var(knd)))</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;          rtest=-abs(r3fit(jnd)-r3fit(knd))  <span class="comment">!?? repeated code around here</span></div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="keywordflow">        END DO</span></div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;        <span class="comment">! make prediction and finish with this variable</span></div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;        <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;        <span class="keywordflow">IF</span> (rcurrentvar(ind).LE.<a class="code" href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">tiny</a>.AND.ivariabletype.EQ.4) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;          <span class="comment">! We reached zero D-W factor in convexity test, skip the prediction</span></div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Using zero Debye Waller factor, simulate and refine next variable&quot;</span> )</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;          iter=iter+1</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;        <span class="keywordflow">ELSE</span></div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a054997d70bc773359dcc5c88b3c86445">parabo3</a>(r3var,r3fit,rvarmin,rfitmin,ierr)</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;Concave set, predict minimum at &quot;</span>,rvarmin)</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;       with fit index &quot;</span>,rfitmin)</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;          jnd=maxloc(r3fit,1)<span class="comment">!worst point</span></div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;          knd=minloc(r3fit,1)<span class="comment">!best point</span></div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;          <span class="comment">! replace worst point with prediction and put into RIndependentVariable</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;          <span class="comment">! checnk if we have reached zero D-W factor</span></div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;          <span class="keywordflow">IF</span> (rvarmin.LT.<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a>.AND.ivariabletype.EQ.4) rvarmin=<a class="code" href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">zero</a></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;          rcurrentvar=rvar0+rpvec*(rvarmin-rvar0(ind))/rpvec(ind)</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;          <span class="comment">!R3var(jnd)=RCurrentVar(ind)!do I need this?</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;          iter=iter+1</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rcurrentvar,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;          <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;          <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;          <span class="keyword">CALL </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(<a class="code" href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rfigureofmerit</a>,rbestfit,rcurrentvar,rindependentvariable,ierr)</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;        <span class="comment">! we have just done an average direction refinement, quit the NoOfVariables loop</span></div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;        <span class="keywordflow">IF</span> (icycle.EQ.1) <span class="keywordflow">EXIT</span></div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;      <span class="comment">!/\------------------------------------------------------------------</span></div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;      <span class="comment">! check where we go next and update last fit</span></div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;      <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;      <span class="comment">! We have refined all variables, check where we go next and update last fit etc.</span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;      <span class="keywordflow">IF</span> (<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>.GT.2) <span class="keywordflow">THEN</span> <span class="comment">! refining multiple variables</span></div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;        <span class="keywordflow">IF</span> (icycle.EQ.0) <span class="keywordflow">THEN</span> <span class="comment">! we haven&#39;t done an average direction refinement, set the flag</span></div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;          icycle=1</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        <span class="keywordflow">ELSE</span> <span class="comment">! we just did an average direction refinement</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;          <span class="comment">! go back to pairwise and update RLastFit and Rdf</span></div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;          icycle=0</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;          rdf=rlastfit-rbestfit </div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;          rlastfit=rbestfit</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;--------------------------------&quot;</span>)</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;          <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A19,F8.6,A15,F8.6)&#39;</span>) <span class="stringliteral">&quot;Improvement in fit &quot;</span>,rdf,<span class="stringliteral">&quot;, will stop at &quot;</span>,<a class="code" href="namespacerpara.html#af0e6a45e493ff75f8f7e03d528f59ba9">rexitcriteria</a></div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> (<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, sprintstring)</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;      <span class="keywordflow">ELSE</span> <span class="comment">! refining just one variable</span></div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;        <span class="keywordflow">IF</span> (rbestfit.LT.rlastfit) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;          rdf=rlastfit-rbestfit </div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;          rlastfit=rbestfit</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>(<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, <span class="stringliteral">&quot;--------------------------------&quot;</span>)</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;          <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A19,F8.6,A15,F8.6)&#39;</span>) <span class="stringliteral">&quot;Improvement in fit &quot;</span>,rdf,<span class="stringliteral">&quot;, will stop at &quot;</span>,<a class="code" href="namespacerpara.html#af0e6a45e493ff75f8f7e03d528f59ba9">rexitcriteria</a></div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;          <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a> (<a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, sprintstring)</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;<span class="keywordflow">        END IF</span></div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;<span class="keywordflow">      END IF</span></div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;      <span class="comment">! shrink length scale as we progress, by a smaller amount</span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;      <span class="comment">! depending on the no of variables: 1-&gt;1/2; 2-&gt;3/4; 3-&gt;5/6; 4-&gt;7/8; 5-&gt;9/10;</span></div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;      rscale=rscale*(<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>-<a class="code" href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">one</a>/(<a class="code" href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">two</a>*<span class="keywordtype">REAL</span>(<a class="code" href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">inoofvariables</a>)))</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;<span class="keywordflow">    END DO</span> </div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    <span class="comment">!/\/\----------------------------------------------------------------</span></div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    <span class="comment">! We are done, finally simulate and output the best fit</span></div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    <span class="comment">!--------------------------------------------------------------------</span></div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    iexitflag=1</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;    iter=iter+1</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">simulateandfit</a>(rindependentvariable,iter,ithicknessindex,ierr)</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;SimulateAndFit&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">writeiterationoutputwrapper</a>(iter,ithicknessindex,iexitflag,ierr)</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;ParabolicRefinement&quot;</span>,<span class="stringliteral">&quot;WriteIterationOutputWrapper&quot;</span>)) <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;    <span class="keyword">DEALLOCATE</span>(rvar0,rcurrentvar,rlastvar,rpvec,stat=ierr)</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160; </div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#aa3ac25cfee1d00cf8de55756f300626e">parabolicrefinement</a></div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;  <span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#ae90b8276ac3740e84da8bc67eef4e477">setupatommovements</a>(IErr)</div><div class="line"><a name="l01575"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#ae90b8276ac3740e84da8bc67eef4e477"> 1575</a></span>&#160;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <span class="comment">! called once in felixrefine IF(IRefineMode(2)==1) atom coordinate refinement, B</span></div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: IErr,knd,jnd,ind,ISpaceGrp</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span>,<span class="keywordtype">DIMENSION(:)</span>,<span class="keywordtype">ALLOCATABLE</span> :: IDegreesOfFreedom</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(ITHREE,ITHREE)</span> :: RMoveMatrix</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    </div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;    <span class="keyword">CALL </span><a class="code" href="namespacesetup__space__group__mod.html#a7aba60fcce3086e6ef45d5946181259d">convertspacegrouptonumber</a>(ispacegrp,ierr)</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SetupAtomMovements&quot;</span>,<span class="stringliteral">&quot;ConvertSpaceGroupToNumber&quot;</span>)) <span class="keywordflow">RETURN</span>  </div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;    <span class="keyword">ALLOCATE</span>(idegreesoffreedom(<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)),stat=ierr)</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SetupAtomMovements&quot;</span>,<span class="stringliteral">&quot;allocate IDegreesOfFreedom&quot;</span>)) <span class="keywordflow">RETURN</span>  </div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;    <span class="comment">!Count the degrees of freedom of movement for each atom to be refined    </span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;    <span class="keywordflow">DO</span> ind = 1,<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacesetup__space__group__mod.html#ab89d78c4ee07b71696f8d9bf10d11ff3">countallowedmovements</a>(ispacegrp,<a class="code" href="namespacespara.html#a98cae59fac1811dc59f79eb311a23621">swyckoffsymbol</a>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>(ind)),&amp;</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;            idegreesoffreedom(ind),ierr)</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SetupAtomMovements&quot;</span>,<span class="stringliteral">&quot;CountAllowedMovements&quot;</span>)) <span class="keywordflow">RETURN</span>     </div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    </div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;    <span class="keyword">ALLOCATE</span>(<a class="code" href="namespaceipara.html#afc203a95f836819679531255dbcf2440">iatommovelist</a>(sum(idegreesoffreedom)),stat=ierr)</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SetupAtomMovements&quot;</span>,<span class="stringliteral">&quot;allocate IAtomMoveList&quot;</span>)) <span class="keywordflow">RETURN</span>  </div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;    <span class="keyword">ALLOCATE</span>(<a class="code" href="namespacerpara.html#a93e42ab6d253823f52158db3a2f61369">rvector</a>(sum(idegreesoffreedom),<a class="code" href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">ithree</a>),stat=ierr)</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;    <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SetupAtomMovements&quot;</span>,<span class="stringliteral">&quot;allocate RVector&quot;</span>)) <span class="keywordflow">RETURN</span>  </div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;    </div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;    <span class="comment">!make a list of vectors and the atoms they move</span></div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;    knd = 0</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;    <span class="keywordflow">DO</span> ind = 1,<span class="keyword">SIZE</span>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>)</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;      <span class="keyword">CALL </span><a class="code" href="namespacesetup__space__group__mod.html#a65b53003b4b1d2f554e090b441b647ff">determineallowedmovements</a>(ispacegrp,<a class="code" href="namespacespara.html#a98cae59fac1811dc59f79eb311a23621">swyckoffsymbol</a>(<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>(ind)),&amp;</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            rmovematrix,ierr)</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;      <span class="keywordflow">IF</span>(l_alert(ierr,<span class="stringliteral">&quot;SetupAtomMovements&quot;</span>,<span class="stringliteral">&quot;DetermineAllowedMovements&quot;</span>)) <span class="keywordflow">RETURN</span>  </div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;      <span class="keywordflow">DO</span> jnd = 1,idegreesoffreedom(ind)</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;        knd=knd+1</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;        <a class="code" href="namespacerpara.html#a93e42ab6d253823f52158db3a2f61369">rvector</a>(knd,:)=rmovematrix(jnd,:)<span class="comment">!the movement, global variable</span></div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;        <a class="code" href="namespaceipara.html#afc203a95f836819679531255dbcf2440">iatommovelist</a>(knd)=<a class="code" href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">iatomstorefine</a>(ind)<span class="comment">!the atom, global variable</span></div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="keywordflow">      END DO</span></div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="keywordflow">    END DO</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#ae90b8276ac3740e84da8bc67eef4e477">setupatommovements</a>     </div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;  <span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;                                                                                                                                    </div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a>(RFoM,RBest,RCurrent,RIndependentVariable,IErr)</div><div class="line"><a name="l01623"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce"> 1623</a></span>&#160;    <span class="comment">! called in felixrefine multiple times, utility with variable refinement and FigureOfMerit</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    </div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: RFoM,RBest <span class="comment">! current figure of merit and the best figure of merit</span></div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;    <span class="comment">! current and best set of variables</span></div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(INoOfVariables)</span> :: RCurrent,RIndependentVariable</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: IErr</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    <span class="keywordflow">IF</span> (rfom.LT.rbest) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;      rbest=rfom</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      rindependentvariable=rcurrent</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="keywordflow">    END IF</span></div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;    <span class="keyword">WRITE</span>(sprintstring,fmt=<span class="stringliteral">&#39;(A29,F7.2,A1)&#39;</span>) <span class="stringliteral">&quot;Current best figure of merit &quot;</span>,100*rbest,<span class="stringliteral">&quot;%&quot;</span></div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;    sprintstring=trim(adjustl(sprintstring))</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;    <span class="keyword">CALL </span><a class="code" href="interfacemessage__mod_1_1message.html">message</a>( <a class="code" href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">ls</a>, sprintstring)</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;          </div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;  <span class="comment">!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="keyword">  SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a054997d70bc773359dcc5c88b3c86445">parabo3</a>(Rx,Ry,Rxv,Ryv,IErr)</div><div class="line"><a name="l01652"></a><span class="lineno"><a class="line" href="felixrefine_8f90.html#a054997d70bc773359dcc5c88b3c86445"> 1652</a></span>&#160;    <span class="comment">! called twice in felixrefine, utility for MaxGradient/ParabolicRefinement</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    </div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;    <span class="keywordtype">REAL(RKIND)</span> :: Ra,Rb,Rc,Rd,Rxv,Ryv</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;    <span class="keywordtype">REAL(RKIND)</span>,<span class="keywordtype">DIMENSION(3)</span> :: Rx,Ry</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    <span class="keywordtype">INTEGER(IKIND)</span> :: IErr</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    </div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;    rd = rx(1)*rx(1)*(rx(2)-rx(3)) + rx(2)*rx(2)*(rx(3)-rx(1)) + rx(3)*rx(3)*(rx(1)-rx(2))</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;    ra =(rx(1)*(ry(3)-ry(2)) + rx(2)*(ry(1)-ry(3)) + rx(3)*(ry(2)-ry(1)))/rd</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    rb =( rx(1)*rx(1)*(ry(2)-ry(3)) + rx(2)*rx(2)*(ry(3)-ry(1)) + &amp;</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;          rx(3)*rx(3)*(ry(1)-ry(2)) )/rd</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    rc =(rx(1)*rx(1)*(rx(2)*ry(3)-rx(3)*ry(2)) + rx(2)*rx(2)*(rx(3)*ry(1)-rx(1)*ry(3))&amp;</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;        +rx(3)*rx(3)*(rx(1)*ry(2)-rx(2)*ry(1)))/rd</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    rxv = -rb/(2*ra);<span class="comment">!x-coord</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;    ryv = rc-rb*rb/(4*ra)<span class="comment">!y-coord</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="keyword">  END SUBROUTINE </span><a class="code" href="felixrefine_8f90.html#a054997d70bc773359dcc5c88b3c86445">parabo3</a> </div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="keyword">END PROGRAM </span><a class="code" href="felixrefine_8f90.html#aecbf263fc9c06070ed63b7a31c76bbef">felixrefine</a></div><div class="ttc" id="namespacewrite__output__mod_html_ace6e8de1fd70ac8abeca26778da0cf5b"><div class="ttname"><a href="namespacewrite__output__mod.html#ace6e8de1fd70ac8abeca26778da0cf5b">write_output_mod::writeiterationoutput</a></div><div class="ttdeci">subroutine, public writeiterationoutput(Iter, IThicknessIndex, IExitFlag, IErr)</div><div class="ttdoc">Procedure-description: Writes output for interations including simulated .bin files, structureFactors.txt and structure.cif. </div><div class="ttdef"><b>Definition:</b> <a href="write__output__mod_8f90_source.html#l00085">write_output_mod.f90:85</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a329f2b63cff4fd55c1d08da7d826ebcc"><div class="ttname"><a href="namespacemessage__mod.html#a329f2b63cff4fd55c1d08da7d826ebcc">message_mod::setmessagemode</a></div><div class="ttdeci">subroutine setmessagemode(IWriteFLAG, IErr)</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00232">message_mod.f90:232</a></div></div>
<div class="ttc" id="namespacerconst_html_abf3e0e151d78d15c709e9f2c6165075b"><div class="ttname"><a href="namespacerconst.html#abf3e0e151d78d15c709e9f2c6165075b">rconst::rangstromconversion</a></div><div class="ttdeci">real(rkind), parameter rangstromconversion</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespaceipara_html_adee5a4247435a83b19c439de4b1f3138"><div class="ttname"><a href="namespaceipara.html#adee5a4247435a83b19c439de4b1f3138">ipara::ianisodw</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable ianisodw</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00187">smodules.f90:187</a></div></div>
<div class="ttc" id="namespacerpara_html_a3e1ea863b25489d2f5a117bf018898f8"><div class="ttname"><a href="namespacerpara.html#a3e1ea863b25489d2f5a117bf018898f8">rpara::racceleratingvoltage</a></div><div class="ttdeci">real(rkind) racceleratingvoltage</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00245">smodules.f90:245</a></div></div>
<div class="ttc" id="namespacerpara_html_ac6e1b12192449367c347418574c2aaac"><div class="ttname"><a href="namespacerpara.html#ac6e1b12192449367c347418574c2aaac">rpara::relectronvelocity</a></div><div class="ttdeci">real(rkind) relectronvelocity</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacerconst_html_a77ee671bb619df43cd56811461facac8"><div class="ttname"><a href="namespacerconst.html#a77ee671bb619df43cd56811461facac8">rconst::relectronmass</a></div><div class="ttdeci">real(rkind), parameter relectronmass</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespaceipara_html_ac39bf45c011d1e46a07b6c347dfc9a30"><div class="ttname"><a href="namespaceipara.html#ac39bf45c011d1e46a07b6c347dfc9a30">ipara::icorrelationflag</a></div><div class="ttdeci">integer(ikind) icorrelationflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespacerpara_html"><div class="ttname"><a href="namespacerpara.html">rpara</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00231">smodules.f90:231</a></div></div>
<div class="ttc" id="namespaceipara_html_aced1da6491258b042163e55f4231e905"><div class="ttname"><a href="namespaceipara.html#aced1da6491258b042163e55f4231e905">ipara::iequivalentugkey</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable iequivalentugkey</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00195">smodules.f90:195</a></div></div>
<div class="ttc" id="namespacerpara_html_a046c2835d55be915c22548463c97b14c"><div class="ttname"><a href="namespacerpara.html#a046c2835d55be915c22548463c97b14c">rpara::racceptanceangle</a></div><div class="ttdeci">real(rkind) racceptanceangle</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacemympi_html"><div class="ttname"><a href="namespacemympi.html">mympi</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00124">gmodules.f90:124</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_a054997d70bc773359dcc5c88b3c86445"><div class="ttname"><a href="felixrefine_8f90.html#a054997d70bc773359dcc5c88b3c86445">parabo3</a></div><div class="ttdeci">subroutine parabo3(Rx, Ry, Rxv, Ryv, IErr)</div><div class="ttdoc">Procedure-description: Input is a vector Rx with three x-coordinates and Ry with three y-coordinates...</div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l01652">felixrefine.f90:1652</a></div></div>
<div class="ttc" id="namespacerpara_html_a93e42ab6d253823f52158db3a2f61369"><div class="ttname"><a href="namespacerpara.html#a93e42ab6d253823f52158db3a2f61369">rpara::rvector</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rvector</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00314">smodules.f90:314</a></div></div>
<div class="ttc" id="namespacesetup__space__group__mod_html"><div class="ttname"><a href="namespacesetup__space__group__mod.html">setup_space_group_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="setup__space__group__mod_8f90_source.html#l00040">setup_space_group_mod.f90:40</a></div></div>
<div class="ttc" id="namespacerpara_html_a9bda8546175cae80b32168a101cf5823"><div class="ttname"><a href="namespacerpara.html#a9bda8546175cae80b32168a101cf5823">rpara::rinitialthickness</a></div><div class="ttdeci">real(rkind) rinitialthickness</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00250">smodules.f90:250</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a5f9279872ada05b1ce8888a3a9a64b78"><div class="ttname"><a href="namespacemynumbers.html#a5f9279872ada05b1ce8888a3a9a64b78">mynumbers::twodeg2radian</a></div><div class="ttdeci">real(rkind) twodeg2radian</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00048">gmodules.f90:48</a></div></div>
<div class="ttc" id="namespaceipara_html_acb7d51a164ff0fb9b6817c94e6d9cdb9"><div class="ttname"><a href="namespaceipara.html#acb7d51a164ff0fb9b6817c94e6d9cdb9">ipara::ipreviousprintediteration</a></div><div class="ttdeci">integer(ikind) ipreviousprintediteration</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00222">smodules.f90:222</a></div></div>
<div class="ttc" id="namespaceipara_html_afc0dd3ec460044c563736fb0843695fb"><div class="ttname"><a href="namespaceipara.html#afc0dd3ec460044c563736fb0843695fb">ipara::ipixeltotal</a></div><div class="ttdeci">integer(ikind) ipixeltotal</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00189">smodules.f90:189</a></div></div>
<div class="ttc" id="namespacesetup__reflections__mod_html_a698f914dd9471567b485f41c6b7c8f2f"><div class="ttname"><a href="namespacesetup__reflections__mod.html#a698f914dd9471567b485f41c6b7c8f2f">setup_reflections_mod::hkllist</a></div><div class="ttdeci">subroutine, public hkllist(IErr)</div><div class="ttdoc">Procedure-description: Assign numbers to the different reflections in IOutputReflections. </div><div class="ttdef"><b>Definition:</b> <a href="setup__reflections__mod_8f90_source.html#l00056">setup_reflections_mod.f90:56</a></div></div>
<div class="ttc" id="namespaceipara_html_afc4f119295fdea846160e89888095a6d"><div class="ttname"><a href="namespaceipara.html#afc4f119295fdea846160e89888095a6d">ipara::iscatterfactormethodflag</a></div><div class="ttdeci">integer(ikind) iscatterfactormethodflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespacerpara_html_ac3f76b98beae63fa0068cc5fbf2e3ef9"><div class="ttname"><a href="namespacerpara.html#ac3f76b98beae63fa0068cc5fbf2e3ef9">rpara::rarvecm</a></div><div class="ttdeci">real(rkind), dimension(ithree) rarvecm</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00265">smodules.f90:265</a></div></div>
<div class="ttc" id="namespacerpara_html_a6ab2df0cea1276c566d73bbead89897a"><div class="ttname"><a href="namespacerpara.html#a6ab2df0cea1276c566d73bbead89897a">rpara::rimagebase</a></div><div class="ttdeci">real(rkind), dimension(:,:,:,:), allocatable rimagebase</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00308">smodules.f90:308</a></div></div>
<div class="ttc" id="namespaceipara_html_a6217500ff5d28cf24b5019959cb75134"><div class="ttname"><a href="namespaceipara.html#a6217500ff5d28cf24b5019959cb75134">ipara::ioutputreflections</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable ioutputreflections</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00195">smodules.f90:195</a></div></div>
<div class="ttc" id="namespaceipara_html_a387bc1758e5dc90d95e76e6e14aa5e39"><div class="ttname"><a href="namespaceipara.html#a387bc1758e5dc90d95e76e6e14aa5e39">ipara::idisplacements</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable idisplacements</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00219">smodules.f90:219</a></div></div>
<div class="ttc" id="namespacecpara_html_aafee78324879785fd9f639bd433c23bc"><div class="ttname"><a href="namespacecpara.html#aafee78324879785fd9f639bd433c23bc">cpara::cpseudoatom</a></div><div class="ttdeci">complex(ckind), dimension(:,:,:), allocatable cpseudoatom</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00334">smodules.f90:334</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_aefbfaa87735de589ffff68e6d7faaa86"><div class="ttname"><a href="namespaceug__matrix__mod.html#aefbfaa87735de589ffff68e6d7faaa86">ug_matrix_mod::structurefactorinitialisation</a></div><div class="ttdeci">subroutine, public structurefactorinitialisation(IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00341">ug_matrix_mod.f90:341</a></div></div>
<div class="ttc" id="namespaceichannels_html"><div class="ttname"><a href="namespaceichannels.html">ichannels</a></div><div class="ttdoc">Module-description: Input and output channels. </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00362">smodules.f90:362</a></div></div>
<div class="ttc" id="namespacerconst_html_acd0b84e445113cfb708f67d2490699b8"><div class="ttname"><a href="namespacerconst.html#acd0b84e445113cfb708f67d2490699b8">rconst::rspeedoflight</a></div><div class="ttdeci">real(rkind), parameter rspeedoflight</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespaceipara_html_a76cb3f709ca8ca3f1444325f4a5906a5"><div class="ttname"><a href="namespaceipara.html#a76cb3f709ca8ca3f1444325f4a5906a5">ipara::ihklmaxvalue</a></div><div class="ttdeci">integer(ikind) ihklmaxvalue</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00186">smodules.f90:186</a></div></div>
<div class="ttc" id="namespacerpara_html_ad410dacc219d75ed02822705e40185c0"><div class="ttname"><a href="namespacerpara.html#ad410dacc219d75ed02822705e40185c0">rpara::rbasisatomposition</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rbasisatomposition</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00241">smodules.f90:241</a></div></div>
<div class="ttc" id="namespaceimage__initialisation__mod_html_a57132a9ff98ab1f59b056f268f0cd446"><div class="ttname"><a href="namespaceimage__initialisation__mod.html#a57132a9ff98ab1f59b056f268f0cd446">image_initialisation_mod::imageinitialisation</a></div><div class="ttdeci">subroutine, public imageinitialisation(IErr)</div><div class="ttdoc">Procedure-description: Sets the positions of the centres of the disks and calculate the size of the f...</div><div class="ttdef"><b>Definition:</b> <a href="image__initialisation__mod_8f90_source.html#l00051">image_initialisation_mod.f90:51</a></div></div>
<div class="ttc" id="namespacerpara_html_a17372b60679b620c6d7727811dc92d27"><div class="ttname"><a href="namespacerpara.html#a17372b60679b620c6d7727811dc92d27">rpara::rcrvecm</a></div><div class="ttdeci">real(rkind), dimension(ithree) rcrvecm</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00265">smodules.f90:265</a></div></div>
<div class="ttc" id="namespacerpara_html_af0e6a45e493ff75f8f7e03d528f59ba9"><div class="ttname"><a href="namespacerpara.html#af0e6a45e493ff75f8f7e03d528f59ba9">rpara::rexitcriteria</a></div><div class="ttdeci">real(rkind) rexitcriteria</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00315">smodules.f90:315</a></div></div>
<div class="ttc" id="namespaceset__scatter__factors__mod_html_afa6ecf739cd73eb7ab07728f42ccb4d5"><div class="ttname"><a href="namespaceset__scatter__factors__mod.html#afa6ecf739cd73eb7ab07728f42ccb4d5">set_scatter_factors_mod::setscatteringfactors</a></div><div class="ttdeci">subroutine, public setscatteringfactors(IScatteringMethodSwitch, IErr)</div><div class="ttdef"><b>Definition:</b> <a href="set__scatter__factors__mod_8f90_source.html#l00050">set_scatter_factors_mod.f90:50</a></div></div>
<div class="ttc" id="namespacecpara_html_ad5180d94d16b2d27f935a3fd8f473ed2"><div class="ttname"><a href="namespacecpara.html#ad5180d94d16b2d27f935a3fd8f473ed2">cpara::cpseudoscatt</a></div><div class="ttdeci">complex(ckind), dimension(:,:,:), allocatable cpseudoscatt</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00334">smodules.f90:334</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_ad19a33e2e66fd82be71a87ebed368c8d"><div class="ttname"><a href="felixrefine_8f90.html#ad19a33e2e66fd82be71a87ebed368c8d">abort</a></div><div class="ttdeci">subroutine abort</div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l00882">felixrefine.f90:882</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a58e7d42c3fbc3ff54b387ea470e4ec67"><div class="ttname"><a href="namespacemessage__mod.html#a58e7d42c3fbc3ff54b387ea470e4ec67">message_mod::dbg3</a></div><div class="ttdeci">type(msgtags) dbg3</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00201">message_mod.f90:201</a></div></div>
<div class="ttc" id="namespaceipara_html_afc203a95f836819679531255dbcf2440"><div class="ttname"><a href="namespaceipara.html#afc203a95f836819679531255dbcf2440">ipara::iatommovelist</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable iatommovelist</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00221">smodules.f90:221</a></div></div>
<div class="ttc" id="namespacesetup__reflections__mod_html_a74fc591a7e77c30486b2b93a0640caa9"><div class="ttname"><a href="namespacesetup__reflections__mod.html#a74fc591a7e77c30486b2b93a0640caa9">setup_reflections_mod::hklmake</a></div><div class="ttdeci">subroutine, public hklmake(Ihklmax, Rhkl0Vec, RHOLZAcceptanceAngle, IErr)</div><div class="ttdoc">Procedure-description: Fills the list of reciprocal space vectors Rhkl. </div><div class="ttdef"><b>Definition:</b> <a href="setup__reflections__mod_8f90_source.html#l00277">setup_reflections_mod.f90:277</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a782923fd3fc790ea0a52f32ed16d2ab5"><div class="ttname"><a href="namespacemynumbers.html#a782923fd3fc790ea0a52f32ed16d2ab5">mynumbers::one</a></div><div class="ttdeci">real(rkind), parameter one</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespaceipara_html_a8df9db4bd56d00b01dbf96206f1e3338"><div class="ttname"><a href="namespaceipara.html#a8df9db4bd56d00b01dbf96206f1e3338">ipara::iatomicnumber</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable iatomicnumber</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00175">smodules.f90:175</a></div></div>
<div class="ttc" id="namespacerpara_html_af6e03ad961551b3b6797d6a3e1d26c41"><div class="ttname"><a href="namespacerpara.html#af6e03ad961551b3b6797d6a3e1d26c41">rpara::rgpool</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rgpool</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00277">smodules.f90:277</a></div></div>
<div class="ttc" id="namespacerpara_html_ab72431aad9e9d382dc1f476e49bc2a32"><div class="ttname"><a href="namespacerpara.html#ab72431aad9e9d382dc1f476e49bc2a32">rpara::rimagesimi</a></div><div class="ttdeci">real(rkind), dimension(:,:,:,:), allocatable rimagesimi</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00306">smodules.f90:306</a></div></div>
<div class="ttc" id="namespacerconst_html_a197d5b0781324ed2c51391b89387589f"><div class="ttname"><a href="namespacerconst.html#a197d5b0781324ed2c51391b89387589f">rconst::rplanckconstant</a></div><div class="ttdeci">real(rkind), parameter rplanckconstant</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespacespara_html_a68b06af6b6fec154d76e1267678421c3"><div class="ttname"><a href="namespacespara.html#a68b06af6b6fec154d76e1267678421c3">spara::satomlabel</a></div><div class="ttdeci">character *5, dimension(:), allocatable satomlabel</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00350">smodules.f90:350</a></div></div>
<div class="ttc" id="namespacerpara_html_ace58eb6ea2923f20fe329cb88d8f91e4"><div class="ttname"><a href="namespacerpara.html#ace58eb6ea2923f20fe329cb88d8f91e4">rpara::rgmatrixmagnitude</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rgmatrixmagnitude</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00287">smodules.f90:287</a></div></div>
<div class="ttc" id="namespacerpara_html_ace33cd9a5b6ab325821876a86059d399"><div class="ttname"><a href="namespacerpara.html#ace33cd9a5b6ab325821876a86059d399">rpara::rimageexpi</a></div><div class="ttdeci">real(rkind), dimension(:,:,:), allocatable rimageexpi</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00302">smodules.f90:302</a></div></div>
<div class="ttc" id="namespacecpara_html_a8d69fd485c9166c98eccabb12182af55"><div class="ttname"><a href="namespacecpara.html#a8d69fd485c9166c98eccabb12182af55">cpara::cugmatnoabs</a></div><div class="ttdeci">complex(ckind), dimension(:,:), allocatable cugmatnoabs</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00331">smodules.f90:331</a></div></div>
<div class="ttc" id="namespaceipara_html_a627e840f6bb077220aae0df2e14f4a8e"><div class="ttname"><a href="namespaceipara.html#a627e840f6bb077220aae0df2e14f4a8e">ipara::irefinemethodflag</a></div><div class="ttdeci">integer(ikind) irefinemethodflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespaceipara_html_a328551d3e73c899d0adcb6c81de6015e"><div class="ttname"><a href="namespaceipara.html#a328551d3e73c899d0adcb6c81de6015e">ipara::iwriteflag</a></div><div class="ttdeci">integer(ikind) iwriteflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespacespara_html_a6a49bd4357ec329e1bb9c4de6be9c276"><div class="ttname"><a href="namespacespara.html#a6a49bd4357ec329e1bb9c4de6be9c276">spara::satomname</a></div><div class="ttdeci">character *2, dimension(:), allocatable satomname</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00351">smodules.f90:351</a></div></div>
<div class="ttc" id="namespaceipara_html_a962f6f736377a49001fa53a2af50b998"><div class="ttname"><a href="namespaceipara.html#a962f6f736377a49001fa53a2af50b998">ipara::iatomstorefine</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable iatomstorefine</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00216">smodules.f90:216</a></div></div>
<div class="ttc" id="namespacewrite__output__mod_html_aad64380d580f31e354d67a7375834152"><div class="ttname"><a href="namespacewrite__output__mod.html#aad64380d580f31e354d67a7375834152">write_output_mod::writeiterationoutputwrapper</a></div><div class="ttdeci">subroutine, public writeiterationoutputwrapper(Iter, IThicknessIndex, IExitFLAG, IErr)</div><div class="ttdef"><b>Definition:</b> <a href="write__output__mod_8f90_source.html#l00046">write_output_mod.f90:46</a></div></div>
<div class="ttc" id="namespacesetup__space__group__mod_html_a7aba60fcce3086e6ef45d5946181259d"><div class="ttname"><a href="namespacesetup__space__group__mod.html#a7aba60fcce3086e6ef45d5946181259d">setup_space_group_mod::convertspacegrouptonumber</a></div><div class="ttdeci">subroutine, public convertspacegrouptonumber(ISpaceGrp, IErr)</div><div class="ttdoc">Procedure-description: Convert SSpacegrp to lower case and Compare SSpaceGrpNoSpaces with every space...</div><div class="ttdef"><b>Definition:</b> <a href="setup__space__group__mod_8f90_source.html#l00615">setup_space_group_mod.f90:615</a></div></div>
<div class="ttc" id="namespacerefinementcontrol__mod_html_ada61968d8e09d3c32c28fd4be936df69"><div class="ttname"><a href="namespacerefinementcontrol__mod.html#ada61968d8e09d3c32c28fd4be936df69">refinementcontrol_mod::simulateandfit</a></div><div class="ttdeci">subroutine, public simulateandfit(RIndependentVariable, Iter, IThicknessIndex, IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="refinementcontrol__mod_8f90_source.html#l00054">refinementcontrol_mod.f90:54</a></div></div>
<div class="ttc" id="namespacerpara_html_a28e140902500ccaf75631cb870647256"><div class="ttname"><a href="namespacerpara.html#a28e140902500ccaf75631cb870647256">rpara::rdeltak</a></div><div class="ttdeci">real(rkind) rdeltak</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00279">smodules.f90:279</a></div></div>
<div class="ttc" id="namespacecrystallography__mod_html"><div class="ttname"><a href="namespacecrystallography__mod.html">crystallography_mod</a></div><div class="ttdoc">Module-description: This handle lattice vectors as well as the fractional atomic positions. </div><div class="ttdef"><b>Definition:</b> <a href="crystallography__mod_8f90_source.html#l00036">crystallography_mod.f90:36</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a956c73bb092dda3957965063393d991c"><div class="ttname"><a href="namespacemynumbers.html#a956c73bb092dda3957965063393d991c">mynumbers::two</a></div><div class="ttdeci">real(rkind), parameter two</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespaceipara_html_a4178ca9371949c00795220c776bf9d92"><div class="ttname"><a href="namespaceipara.html#a4178ca9371949c00795220c776bf9d92">ipara::iabsorbflag</a></div><div class="ttdeci">integer(ikind) iabsorbflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespaceipara_html"><div class="ttname"><a href="namespaceipara.html">ipara</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00151">smodules.f90:151</a></div></div>
<div class="ttc" id="namespacemympi_html_a596963d73195aa4cf33f7cf8d3239560"><div class="ttname"><a href="namespacemympi.html#a596963d73195aa4cf33f7cf8d3239560">mympi::my_rank</a></div><div class="ttdeci">integer(ikind) my_rank</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00129">gmodules.f90:129</a></div></div>
<div class="ttc" id="namespacecpara_html"><div class="ttname"><a href="namespacecpara.html">cpara</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00326">smodules.f90:326</a></div></div>
<div class="ttc" id="namespacerpara_html_a52787d6e96b170221373591f4e1ef159"><div class="ttname"><a href="namespacerpara.html#a52787d6e96b170221373591f4e1ef159">rpara::rvolume</a></div><div class="ttdeci">real(rkind) rvolume</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespacemynumbers_html_af4c9376fd4e698082245efc2fd7416fe"><div class="ttname"><a href="namespacemynumbers.html#af4c9376fd4e698082245efc2fd7416fe">mynumbers::tiny</a></div><div class="ttdeci">real(rkind) tiny</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00054">gmodules.f90:54</a></div></div>
<div class="ttc" id="namespacerpara_html_abc550cca4c99bd31b505746288b104d4"><div class="ttname"><a href="namespacerpara.html#abc550cca4c99bd31b505746288b104d4">rpara::relectronwavevectormagnitude</a></div><div class="ttdeci">real(rkind) relectronwavevectormagnitude</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacemessage__mod_html"><div class="ttname"><a href="namespacemessage__mod.html">message_mod</a></div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00034">message_mod.f90:34</a></div></div>
<div class="ttc" id="namespacerpara_html_a978f58fc9c3fbad2e3358d6723e5059d"><div class="ttname"><a href="namespacerpara.html#a978f58fc9c3fbad2e3358d6723e5059d">rpara::rhkl</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rhkl</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00258">smodules.f90:258</a></div></div>
<div class="ttc" id="namespaceimage__initialisation__mod_html_aeef829221538e73b32c971174e409878"><div class="ttname"><a href="namespaceimage__initialisation__mod.html#aeef829221538e73b32c971174e409878">image_initialisation_mod::imagemaskinitialisation</a></div><div class="ttdeci">subroutine, public imagemaskinitialisation(IErr)</div><div class="ttdoc">Procedure-description: Creates a circular or square image mask depending on the value of IMaskFLAG an...</div><div class="ttdef"><b>Definition:</b> <a href="image__initialisation__mod_8f90_source.html#l00115">image_initialisation_mod.f90:115</a></div></div>
<div class="ttc" id="namespacerpara_html_a9c2af5aebf9f72fa157caa770d60ce13"><div class="ttname"><a href="namespacerpara.html#a9c2af5aebf9f72fa157caa770d60ce13">rpara::roccupancy</a></div><div class="ttdeci">real(rkind), dimension(:), allocatable roccupancy</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00240">smodules.f90:240</a></div></div>
<div class="ttc" id="namespacerpara_html_af0fc16b6134b0c3859d4484c8c2c1622"><div class="ttname"><a href="namespacerpara.html#af0fc16b6134b0c3859d4484c8c2c1622">rpara::rindividualreflections</a></div><div class="ttdeci">real(rkind), dimension(:,:,:), allocatable rindividualreflections</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00295">smodules.f90:295</a></div></div>
<div class="ttc" id="namespaceichannels_html_ad296a36723368957d48d82a46df5d0b5"><div class="ttname"><a href="namespaceichannels.html#ad296a36723368957d48d82a46df5d0b5">ichannels::ichoutwiimage</a></div><div class="ttdeci">integer, parameter ichoutwiimage</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00369">smodules.f90:369</a></div></div>
<div class="ttc" id="namespacerpara_html_a77bf2d4da8669434639c8c6a48f9a65d"><div class="ttname"><a href="namespacerpara.html#a77bf2d4da8669434639c8c6a48f9a65d">rpara::rdeltathickness</a></div><div class="ttdeci">real(rkind) rdeltathickness</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00250">smodules.f90:250</a></div></div>
<div class="ttc" id="namespacerpara_html_aa6e33f58b9a58ec8271fa0a00f187fc7"><div class="ttname"><a href="namespacerpara.html#aa6e33f58b9a58ec8271fa0a00f187fc7">rpara::rabsorptionpercentage</a></div><div class="ttdeci">real(rkind) rabsorptionpercentage</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00238">smodules.f90:238</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_af236d5d3b839d2a65cef3e50743f688b"><div class="ttname"><a href="namespacemessage__mod.html#af236d5d3b839d2a65cef3e50743f688b">message_mod::dbg6</a></div><div class="ttdeci">type(msgtags) dbg6</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00201">message_mod.f90:201</a></div></div>
<div class="ttc" id="namespaceipara_html_a2619ac66077b12f37446261601018738"><div class="ttname"><a href="namespaceipara.html#a2619ac66077b12f37446261601018738">ipara::iinitialsimulationflag</a></div><div class="ttdeci">integer(ikind) iinitialsimulationflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00168">smodules.f90:168</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_ad65131f38bb57632c5079934b5b9bb0e"><div class="ttname"><a href="namespacemessage__mod.html#ad65131f38bb57632c5079934b5b9bb0e">message_mod::initialisemessage</a></div><div class="ttdeci">subroutine initialisemessage</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00214">message_mod.f90:214</a></div></div>
<div class="ttc" id="namespaceread__files__mod_html_a54c266f7664ec67ee2668b302f21b857"><div class="ttname"><a href="namespaceread__files__mod.html#a54c266f7664ec67ee2668b302f21b857">read_files_mod::readinpfile</a></div><div class="ttdeci">subroutine, public readinpfile(IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="read__files__mod_8f90_source.html#l00047">read_files_mod.f90:47</a></div></div>
<div class="ttc" id="namespacesconst_html"><div class="ttname"><a href="namespacesconst.html">sconst</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00050">smodules.f90:50</a></div></div>
<div class="ttc" id="namespacerpara_html_a339178d3a4919cad9490211dc57bae40"><div class="ttname"><a href="namespacerpara.html#a339178d3a4919cad9490211dc57bae40">rpara::rrelativisticcorrection</a></div><div class="ttdeci">real(rkind) rrelativisticcorrection</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespaceimage__initialisation__mod_html"><div class="ttname"><a href="namespaceimage__initialisation__mod.html">image_initialisation_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="image__initialisation__mod_8f90_source.html#l00036">image_initialisation_mod.f90:36</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_aa3ac25cfee1d00cf8de55756f300626e"><div class="ttname"><a href="felixrefine_8f90.html#aa3ac25cfee1d00cf8de55756f300626e">parabolicrefinement</a></div><div class="ttdeci">subroutine parabolicrefinement</div><div class="ttdoc">Procedure-description: Refinement using the parabola method. </div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l01253">felixrefine.f90:1253</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a5c266f541edfc0a52edd776d60130086"><div class="ttname"><a href="namespacemessage__mod.html#a5c266f541edfc0a52edd776d60130086">message_mod::dbg7</a></div><div class="ttdeci">type(msgtags) dbg7</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00201">message_mod.f90:201</a></div></div>
<div class="ttc" id="namespacerpara_html_aaa5725bd4529596115fd23f71615c59a"><div class="ttname"><a href="namespacerpara.html#aaa5725bd4529596115fd23f71615c59a">rpara::rfigureofmerit</a></div><div class="ttdeci">real(rkind) rfigureofmerit</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00298">smodules.f90:298</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a9eaca1a20a550c924bcb94deb804d1d8"><div class="ttname"><a href="namespacemynumbers.html#a9eaca1a20a550c924bcb94deb804d1d8">mynumbers::deg2radian</a></div><div class="ttdeci">real(rkind) deg2radian</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00048">gmodules.f90:48</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a034f270863f434ad6d1add2c5a6e712a"><div class="ttname"><a href="namespacemessage__mod.html#a034f270863f434ad6d1add2c5a6e712a">message_mod::lxl</a></div><div class="ttdeci">type(msgpriorities) lxl</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00200">message_mod.f90:200</a></div></div>
<div class="ttc" id="namespaceread__files__mod_html_ab3053752748a330bd9bdfbbe9b5bb90e"><div class="ttname"><a href="namespaceread__files__mod.html#ab3053752748a330bd9bdfbbe9b5bb90e">read_files_mod::readhklfile</a></div><div class="ttdeci">subroutine, public readhklfile(IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="read__files__mod_8f90_source.html#l00355">read_files_mod.f90:355</a></div></div>
<div class="ttc" id="namespaceipara_html_a05b32257189f2a78d3240abeee76d8be"><div class="ttname"><a href="namespaceipara.html#a05b32257189f2a78d3240abeee76d8be">ipara::iholzflag</a></div><div class="ttdeci">integer(ikind) iholzflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_ae398ebe57130cf5ef472717a97184d53"><div class="ttname"><a href="namespacemessage__mod.html#ae398ebe57130cf5ef472717a97184d53">message_mod::ls</a></div><div class="ttdeci">type(msgpriorities) ls</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00200">message_mod.f90:200</a></div></div>
<div class="ttc" id="interfacemessage__mod_1_1message_html"><div class="ttname"><a href="interfacemessage__mod_1_1message.html">message_mod::message</a></div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00144">message_mod.f90:144</a></div></div>
<div class="ttc" id="namespacerpara_html_a5f621d5437e3eee27971ec962a75db0e"><div class="ttname"><a href="namespacerpara.html#a5f621d5437e3eee27971ec962a75db0e">rpara::rgdotnorm</a></div><div class="ttdeci">real(rkind), dimension(:), allocatable rgdotnorm</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00281">smodules.f90:281</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html"><div class="ttname"><a href="namespaceug__matrix__mod.html">ug_matrix_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00036">ug_matrix_mod.f90:36</a></div></div>
<div class="ttc" id="namespacerpara_html_a8e36d6af507d9c8a3678c311ab32b979"><div class="ttname"><a href="namespacerpara.html#a8e36d6af507d9c8a3678c311ab32b979">rpara::relectronwavelength</a></div><div class="ttdeci">real(rkind) relectronwavelength</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespaceread__files__mod_html_afc88192b25e5a8c1d0ac2b88d8e2e29a"><div class="ttname"><a href="namespaceread__files__mod.html#afc88192b25e5a8c1d0ac2b88d8e2e29a">read_files_mod::readexperimentalimages</a></div><div class="ttdeci">subroutine, public readexperimentalimages(IErr)</div><div class="ttdoc">Procedure-description: This subroutine reads in the input experimental images. It inquires whether th...</div><div class="ttdef"><b>Definition:</b> <a href="read__files__mod_8f90_source.html#l00437">read_files_mod.f90:437</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a6494cb5525586ad433cd54d5590adbca"><div class="ttname"><a href="namespacemynumbers.html#a6494cb5525586ad433cd54d5590adbca">mynumbers::thousand</a></div><div class="ttdeci">real(rkind), parameter thousand</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_aecbf263fc9c06070ed63b7a31c76bbef"><div class="ttname"><a href="felixrefine_8f90.html#aecbf263fc9c06070ed63b7a31c76bbef">felixrefine</a></div><div class="ttdeci">program felixrefine</div><div class="ttdoc">felixrefine </div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l00036">felixrefine.f90:36</a></div></div>
<div class="ttc" id="namespacecrystallography__mod_html_a8bcf725498414cb7ac7ce808ba2051be"><div class="ttname"><a href="namespacecrystallography__mod.html#a8bcf725498414cb7ac7ce808ba2051be">crystallography_mod::reciprocallattice</a></div><div class="ttdeci">subroutine, public reciprocallattice(IErr)</div><div class="ttdoc">Procedure-description: Creates reciprocal lattice vectors in Microscope reference frame...</div><div class="ttdef"><b>Definition:</b> <a href="crystallography__mod_8f90_source.html#l00051">crystallography_mod.f90:51</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a6aff313862cb947c1e0ba29dddeaf9b0"><div class="ttname"><a href="namespacemynumbers.html#a6aff313862cb947c1e0ba29dddeaf9b0">mynumbers::twopi</a></div><div class="ttdeci">real(rkind) twopi</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00048">gmodules.f90:48</a></div></div>
<div class="ttc" id="namespacerpara_html_a0969e192bfe5abf3e5bd3dd41e1eabe4"><div class="ttname"><a href="namespacerpara.html#a0969e192bfe5abf3e5bd3dd41e1eabe4">rpara::rnormdirm</a></div><div class="ttdeci">real(rkind), dimension(ithree) rnormdirm</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00265">smodules.f90:265</a></div></div>
<div class="ttc" id="namespacemympi_html_ac0410c4231c11381dc6f3809435b993f"><div class="ttname"><a href="namespacemympi.html#ac0410c4231c11381dc6f3809435b993f">mympi::p</a></div><div class="ttdeci">integer(ikind) p</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00129">gmodules.f90:129</a></div></div>
<div class="ttc" id="namespaceipara_html_ac2fc611e13e537adda7e9a570cc6d380"><div class="ttname"><a href="namespaceipara.html#ac2fc611e13e537adda7e9a570cc6d380">ipara::iblochmethodflag</a></div><div class="ttdeci">integer(ikind) iblochmethodflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00158">smodules.f90:158</a></div></div>
<div class="ttc" id="namespaceipara_html_a1998b5137425282bf883191b9f895a9c"><div class="ttname"><a href="namespaceipara.html#a1998b5137425282bf883191b9f895a9c">ipara::ilocalpixelcountmax</a></div><div class="ttdeci">integer(ikind) ilocalpixelcountmax</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00218">smodules.f90:218</a></div></div>
<div class="ttc" id="namespaceipara_html_a08d578b805eddc8db9d05552a0ff44c7"><div class="ttname"><a href="namespaceipara.html#a08d578b805eddc8db9d05552a0ff44c7">ipara::inoofvariables</a></div><div class="ttdeci">integer(ikind) inoofvariables</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00218">smodules.f90:218</a></div></div>
<div class="ttc" id="namespaceipara_html_a9c00e2225af3c6d6460906caa90fcc73"><div class="ttname"><a href="namespaceipara.html#a9c00e2225af3c6d6460906caa90fcc73">ipara::icount</a></div><div class="ttdeci">integer(ikind), dimension(:), allocatable icount</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00219">smodules.f90:219</a></div></div>
<div class="ttc" id="namespacerpara_html_af9f3198452e138d909821f0909a33d41"><div class="ttname"><a href="namespacerpara.html#af9f3198452e138d909821f0909a33d41">rpara::rfinalthickness</a></div><div class="ttdeci">real(rkind) rfinalthickness</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00250">smodules.f90:250</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_ae90b8276ac3740e84da8bc67eef4e477"><div class="ttname"><a href="felixrefine_8f90.html#ae90b8276ac3740e84da8bc67eef4e477">setupatommovements</a></div><div class="ttdeci">subroutine setupatommovements(IErr)</div><div class="ttdoc">Procedure-description: Setup atomic vector movements. </div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l01575">felixrefine.f90:1575</a></div></div>
<div class="ttc" id="namespaceiconst_html_a8a382193072e7a2709bacc4804d31085"><div class="ttname"><a href="namespaceiconst.html#a8a382193072e7a2709bacc4804d31085">iconst::irefinementvariabletypes</a></div><div class="ttdeci">integer(ikind), parameter irefinementvariabletypes</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00114">smodules.f90:114</a></div></div>
<div class="ttc" id="namespacesetup__reflections__mod_html_aacc9940f2b54fd9de9c07819b6c63fc9"><div class="ttname"><a href="namespacesetup__reflections__mod.html#aacc9940f2b54fd9de9c07819b6c63fc9">setup_reflections_mod::hklcount</a></div><div class="ttdeci">subroutine, public hklcount(Ihklmax, Rhkl0Vec, INhkl, RHOLZAcceptanceAngle, IErr)</div><div class="ttdoc">Procedure-description: Counts the number of reflections limited by Ihklmax and the acceptance angle...</div><div class="ttdef"><b>Definition:</b> <a href="setup__reflections__mod_8f90_source.html#l00123">setup_reflections_mod.f90:123</a></div></div>
<div class="ttc" id="namespacemynumbers_html"><div class="ttname"><a href="namespacemynumbers.html">mynumbers</a></div><div class="ttdoc">Module-description: Some numeric computational and mathematical paramter constants as well as maths f...</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00039">gmodules.f90:39</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a6c534f4b86169a7c5d8d3296e270c3f0"><div class="ttname"><a href="namespacemynumbers.html#a6c534f4b86169a7c5d8d3296e270c3f0">mynumbers::init_numbers</a></div><div class="ttdeci">subroutine init_numbers</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00062">gmodules.f90:62</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a5cd27d8a0370b0f228dd54c51a761481"><div class="ttname"><a href="namespacemynumbers.html#a5cd27d8a0370b0f228dd54c51a761481">mynumbers::zero</a></div><div class="ttdeci">real(rkind), parameter zero</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00049">gmodules.f90:49</a></div></div>
<div class="ttc" id="namespacerpara_html_a43818a014ce924c6df2ba2632e15741c"><div class="ttname"><a href="namespacerpara.html#a43818a014ce924c6df2ba2632e15741c">rpara::rsimplexlengthscale</a></div><div class="ttdeci">real(rkind) rsimplexlengthscale</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00315">smodules.f90:315</a></div></div>
<div class="ttc" id="namespacespara_html"><div class="ttname"><a href="namespacespara.html">spara</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00344">smodules.f90:344</a></div></div>
<div class="ttc" id="namespacerpara_html_a27f30c68e56d029e40941f7ac0963448"><div class="ttname"><a href="namespacerpara.html#a27f30c68e56d029e40941f7ac0963448">rpara::rhklpositions</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rhklpositions</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00283">smodules.f90:283</a></div></div>
<div class="ttc" id="namespaceread__cif__mod_html"><div class="ttname"><a href="namespaceread__cif__mod.html">read_cif_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="read__cif__mod_8f90_source.html#l00036">read_cif_mod.f90:36</a></div></div>
<div class="ttc" id="namespaceipara_html_a460470fc5decb9c0737a769aaa625f25"><div class="ttname"><a href="namespaceipara.html#a460470fc5decb9c0737a769aaa625f25">ipara::ilocalpixelcountmin</a></div><div class="ttdeci">integer(ikind) ilocalpixelcountmin</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00218">smodules.f90:218</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a31c0ed8207e9cd37552632a597a2f067"><div class="ttname"><a href="namespacemynumbers.html#a31c0ed8207e9cd37552632a597a2f067">mynumbers::rkind</a></div><div class="ttdeci">integer, parameter rkind</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00043">gmodules.f90:43</a></div></div>
<div class="ttc" id="namespaceblochpara_html"><div class="ttname"><a href="namespaceblochpara.html">blochpara</a></div><div class="ttdoc">Module-description: Eigen problem variables. </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00379">smodules.f90:379</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a2ce1f69b267a1987dcd11f9028a6072d"><div class="ttname"><a href="namespacemessage__mod.html#a2ce1f69b267a1987dcd11f9028a6072d">message_mod::ll</a></div><div class="ttdeci">type(msgpriorities) ll</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00200">message_mod.f90:200</a></div></div>
<div class="ttc" id="namespacerpara_html_ab1731f4ae162ab200a815480d08e1ee4"><div class="ttname"><a href="namespacerpara.html#ab1731f4ae162ab200a815480d08e1ee4">rpara::rgpoolmag</a></div><div class="ttdeci">real(rkind), dimension(:), allocatable rgpoolmag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00276">smodules.f90:276</a></div></div>
<div class="ttc" id="namespacerpara_html_ae5ce1aff41155b702b4313ac8af0ab82"><div class="ttname"><a href="namespacerpara.html#ae5ce1aff41155b702b4313ac8af0ab82">rpara::ratomcoordinate</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable ratomcoordinate</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00271">smodules.f90:271</a></div></div>
<div class="ttc" id="namespacerpara_html_abf7f3dc8894a56b57fbcb141530b562d"><div class="ttname"><a href="namespacerpara.html#abf7f3dc8894a56b57fbcb141530b562d">rpara::rimagemask</a></div><div class="ttdeci">real(rkind), dimension(:,:,:), allocatable rimagemask</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00310">smodules.f90:310</a></div></div>
<div class="ttc" id="namespacesimplex__mod_html"><div class="ttname"><a href="namespacesimplex__mod.html">simplex_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="simplex__mod_8f90_source.html#l00036">simplex_mod.f90:36</a></div></div>
<div class="ttc" id="namespacerpara_html_a60e0ebdfd9538d38bf140bd8ccdda637"><div class="ttname"><a href="namespacerpara.html#a60e0ebdfd9538d38bf140bd8ccdda637">rpara::rgmatrix</a></div><div class="ttdeci">real(rkind), dimension(:,:,:), allocatable rgmatrix</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00288">smodules.f90:288</a></div></div>
<div class="ttc" id="namespaceset__scatter__factors__mod_html"><div class="ttname"><a href="namespaceset__scatter__factors__mod.html">set_scatter_factors_mod</a></div><div class="ttdoc">Module-description: Contains all of the scattering coefficients for each of the following methods: Ki...</div><div class="ttdef"><b>Definition:</b> <a href="set__scatter__factors__mod_8f90_source.html#l00041">set_scatter_factors_mod.f90:41</a></div></div>
<div class="ttc" id="namespaceipara_html_affe4955befe0b01618d77941d0c70fe9"><div class="ttname"><a href="namespaceipara.html#affe4955befe0b01618d77941d0c70fe9">ipara::isimflag</a></div><div class="ttdeci">integer(ikind) isimflag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00169">smodules.f90:169</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_a320beee495d927712cf38ff1119d0eef"><div class="ttname"><a href="felixrefine_8f90.html#a320beee495d927712cf38ff1119d0eef">simplexrefinement</a></div><div class="ttdeci">subroutine simplexrefinement</div><div class="ttdoc">Procedure-description: Refinement using the simplex method. </div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l00894">felixrefine.f90:894</a></div></div>
<div class="ttc" id="namespaceipara_html_a1416f7f0a49b5272510fa759473bb2eb"><div class="ttname"><a href="namespaceipara.html#a1416f7f0a49b5272510fa759473bb2eb">ipara::inoofugs</a></div><div class="ttdeci">integer(ikind) inoofugs</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00182">smodules.f90:182</a></div></div>
<div class="ttc" id="namespacerpara_html_a907dadcc6ec52933b1333320ac15a88a"><div class="ttname"><a href="namespacerpara.html#a907dadcc6ec52933b1333320ac15a88a">rpara::rsimulatedpatterns</a></div><div class="ttdeci">real(rkind), dimension(:,:,:), allocatable rsimulatedpatterns</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00304">smodules.f90:304</a></div></div>
<div class="ttc" id="namespacerconst_html_a85ea14b9febb9539ac8d317add5cdadd"><div class="ttname"><a href="namespacerconst.html#a85ea14b9febb9539ac8d317add5cdadd">rconst::rtolerance</a></div><div class="ttdeci">real(rkind), parameter rtolerance</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00141">smodules.f90:141</a></div></div>
<div class="ttc" id="namespaceipara_html_acb246c6c38569637049523935014fd2d"><div class="ttname"><a href="namespaceipara.html#acb246c6c38569637049523935014fd2d">ipara::iminreflectionpool</a></div><div class="ttdeci">integer(ikind) iminreflectionpool</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00165">smodules.f90:165</a></div></div>
<div class="ttc" id="namespacesetup__reflections__mod_html_a27b6c4289cce9c86414ea90509990d30"><div class="ttname"><a href="namespacesetup__reflections__mod.html#a27b6c4289cce9c86414ea90509990d30">setup_reflections_mod::hklsort</a></div><div class="ttdeci">subroutine, public hklsort(LocalRhkl, N, IErr)</div><div class="ttdoc">Procedure-description: Sorts array into descending order. </div><div class="ttdef"><b>Definition:</b> <a href="setup__reflections__mod_8f90_source.html#l00452">setup_reflections_mod.f90:452</a></div></div>
<div class="ttc" id="namespacewrite__output__mod_html"><div class="ttname"><a href="namespacewrite__output__mod.html">write_output_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="write__output__mod_8f90_source.html#l00036">write_output_mod.f90:36</a></div></div>
<div class="ttc" id="namespacerpara_html_a52616e7e78c617015f75d7ef990beba7"><div class="ttname"><a href="namespacerpara.html#a52616e7e78c617015f75d7ef990beba7">rpara::rrelativisticmass</a></div><div class="ttdeci">real(rkind) rrelativisticmass</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00246">smodules.f90:246</a></div></div>
<div class="ttc" id="namespacemynumbers_html_aef1f88d6d9cee31ea30f159824c42000"><div class="ttname"><a href="namespacemynumbers.html#aef1f88d6d9cee31ea30f159824c42000">mynumbers::ithree</a></div><div class="ttdeci">integer(ikind), parameter ithree</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00046">gmodules.f90:46</a></div></div>
<div class="ttc" id="namespaceipara_html_a37b853026542315a295df2e63a51dbd4"><div class="ttname"><a href="namespaceipara.html#a37b853026542315a295df2e63a51dbd4">ipara::isymmetryrelations</a></div><div class="ttdeci">integer(ikind), dimension(:,:), allocatable isymmetryrelations</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00194">smodules.f90:194</a></div></div>
<div class="ttc" id="namespaceread__cif__mod_html_a6e43e371f6f9c1aa08a172d0fc6ef061"><div class="ttname"><a href="namespaceread__cif__mod.html#a6e43e371f6f9c1aa08a172d0fc6ef061">read_cif_mod::read_cif</a></div><div class="ttdeci">subroutine, public read_cif(IErr)</div><div class="ttdoc">Procedure-description: Reads from felix.cif input file using toolbox. </div><div class="ttdef"><b>Definition:</b> <a href="read__cif__mod_8f90_source.html#l00050">read_cif_mod.f90:50</a></div></div>
<div class="ttc" id="namespaceipara_html_ad159cf79ceb8d3b646c0110467969418"><div class="ttname"><a href="namespaceipara.html#ad159cf79ceb8d3b646c0110467969418">ipara::nreflections</a></div><div class="ttdeci">integer(ikind) nreflections</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00186">smodules.f90:186</a></div></div>
<div class="ttc" id="namespacecrystallography__mod_html_a2ee814f536b5ab881409758b980dcd10"><div class="ttname"><a href="namespacecrystallography__mod.html#a2ee814f536b5ab881409758b980dcd10">crystallography_mod::uniqueatompositions</a></div><div class="ttdeci">subroutine, public uniqueatompositions(IErr)</div><div class="ttdoc">Procedure-description: Calculates the full set of possible fractional atomic positions and then gets ...</div><div class="ttdef"><b>Definition:</b> <a href="crystallography__mod_8f90_source.html#l00185">crystallography_mod.f90:185</a></div></div>
<div class="ttc" id="namespacerpara_html_a8cf94222498f09d89ab12f4ea792c3cc"><div class="ttname"><a href="namespacerpara.html#a8cf94222498f09d89ab12f4ea792c3cc">rpara::rzdirc</a></div><div class="ttdeci">real(rkind), dimension(ithree) rzdirc</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00265">smodules.f90:265</a></div></div>
<div class="ttc" id="namespaceiconst_html"><div class="ttname"><a href="namespaceiconst.html">iconst</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00112">smodules.f90:112</a></div></div>
<div class="ttc" id="namespacerpara_html_aefec739ba942da517044c39761b42979"><div class="ttname"><a href="namespacerpara.html#aefec739ba942da517044c39761b42979">rpara::risodw</a></div><div class="ttdeci">real(rkind), dimension(:), allocatable risodw</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00240">smodules.f90:240</a></div></div>
<div class="ttc" id="namespaceipara_html_a86e5b4cbd1a1c93621a370ca668950eb"><div class="ttname"><a href="namespaceipara.html#a86e5b4cbd1a1c93621a370ca668950eb">ipara::inooflacbedpatterns</a></div><div class="ttdeci">integer(ikind) inooflacbedpatterns</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00184">smodules.f90:184</a></div></div>
<div class="ttc" id="namespacerpara_html_a7fa8bfd8c3361f8ba839ec6461dcd0ae"><div class="ttname"><a href="namespacerpara.html#a7fa8bfd8c3361f8ba839ec6461dcd0ae">rpara::rbrvecm</a></div><div class="ttdeci">real(rkind), dimension(ithree) rbrvecm</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00265">smodules.f90:265</a></div></div>
<div class="ttc" id="namespacerpara_html_aadce6fc00eb10274490391bec2a2e187"><div class="ttname"><a href="namespacerpara.html#aadce6fc00eb10274490391bec2a2e187">rpara::rimageavi</a></div><div class="ttdeci">real(rkind), dimension(:,:,:,:), allocatable rimageavi</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00308">smodules.f90:308</a></div></div>
<div class="ttc" id="namespacesetup__space__group__mod_html_a65b53003b4b1d2f554e090b441b647ff"><div class="ttname"><a href="namespacesetup__space__group__mod.html#a65b53003b4b1d2f554e090b441b647ff">setup_space_group_mod::determineallowedmovements</a></div><div class="ttdeci">subroutine, public determineallowedmovements(ISpaceGrp, SWyckoff, RMoveMatrix, IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="setup__space__group__mod_8f90_source.html#l00054">setup_space_group_mod.f90:54</a></div></div>
<div class="ttc" id="namespacerpara_html_a6f6910638fe224fd061d7cdeeb21d1c0"><div class="ttname"><a href="namespacerpara.html#a6f6910638fe224fd061d7cdeeb21d1c0">rpara::rconvergenceangle</a></div><div class="ttdeci">real(rkind) rconvergenceangle</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00245">smodules.f90:245</a></div></div>
<div class="ttc" id="namespacesimplex__mod_html_a73ec7894bf3ce6e62d9638f50cdefdbc"><div class="ttname"><a href="namespacesimplex__mod.html#a73ec7894bf3ce6e62d9638f50cdefdbc">simplex_mod::ndimensionaldownhillsimplex</a></div><div class="ttdeci">subroutine, public ndimensionaldownhillsimplex(RSimplexVariable, y, mp, np, ndim, ftol, iter, RStandardDeviation, RMean, IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="simplex__mod_8f90_source.html#l00050">simplex_mod.f90:50</a></div></div>
<div class="ttc" id="namespaceipara_html_a038c7fed38c8836d5512fe816e27e3b7"><div class="ttname"><a href="namespaceipara.html#a038c7fed38c8836d5512fe816e27e3b7">ipara::imask</a></div><div class="ttdeci">integer(ikind), dimension(:,:), allocatable imask</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00197">smodules.f90:197</a></div></div>
<div class="ttc" id="namespacerefinementcontrol__mod_html_a47e9366f180d69b9cf263fdb1510d349"><div class="ttname"><a href="namespacerefinementcontrol__mod.html#a47e9366f180d69b9cf263fdb1510d349">refinementcontrol_mod::figureofmeritandthickness</a></div><div class="ttdeci">subroutine, public figureofmeritandthickness(Iter, IBestThicknessIndex, IErr)</div><div class="ttdoc">Procedure-description: Calculates figure of merit and determines which thickness matches best...</div><div class="ttdef"><b>Definition:</b> <a href="refinementcontrol__mod_8f90_source.html#l00325">refinementcontrol_mod.f90:325</a></div></div>
<div class="ttc" id="namespacesetup__reflections__mod_html"><div class="ttname"><a href="namespacesetup__reflections__mod.html">setup_reflections_mod</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="setup__reflections__mod_8f90_source.html#l00041">setup_reflections_mod.f90:41</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a62189da4447c39939fe1e822e897b1a5"><div class="ttname"><a href="namespacemessage__mod.html#a62189da4447c39939fe1e822e897b1a5">message_mod::no_tag</a></div><div class="ttdeci">type(msgtags) no_tag</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00201">message_mod.f90:201</a></div></div>
<div class="ttc" id="namespaceipara_html_a23c03e260666815555342dd982a7c506"><div class="ttname"><a href="namespaceipara.html#a23c03e260666815555342dd982a7c506">ipara::iiterativevariableuniqueids</a></div><div class="ttdeci">integer(ikind), dimension(:,:), allocatable iiterativevariableuniqueids</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00214">smodules.f90:214</a></div></div>
<div class="ttc" id="namespacemynumbers_html_a42ec1d61ae72aab517835b64eb079242"><div class="ttname"><a href="namespacemynumbers.html#a42ec1d61ae72aab517835b64eb079242">mynumbers::neghuge</a></div><div class="ttdeci">real(rkind) neghuge</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00054">gmodules.f90:54</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_ab1e3789e4680b59e9d81bd1d30e3f88a"><div class="ttname"><a href="namespacemessage__mod.html#ab1e3789e4680b59e9d81bd1d30e3f88a">message_mod::lm</a></div><div class="ttdeci">type(msgpriorities) lm</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00200">message_mod.f90:200</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_a984a91f7533b6975ca99ebe57ed9f770"><div class="ttname"><a href="namespacemessage__mod.html#a984a91f7533b6975ca99ebe57ed9f770">message_mod::printendtime</a></div><div class="ttdeci">subroutine printendtime(MsgPriority, IStartTime, STaskName)</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00292">message_mod.f90:292</a></div></div>
<div class="ttc" id="namespacesconst_html_a774e4ba9dd9a2730ad4a811f7bbe5163"><div class="ttname"><a href="namespacesconst.html#a774e4ba9dd9a2730ad4a811f7bbe5163">sconst::astr</a></div><div class="ttdeci">character *50, parameter astr</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00054">smodules.f90:54</a></div></div>
<div class="ttc" id="namespacecpara_html_a2e58cbe91faca3bbe004c6995f0a086e"><div class="ttname"><a href="namespacecpara.html#a2e58cbe91faca3bbe004c6995f0a086e">cpara::cugmatprime</a></div><div class="ttdeci">complex(ckind), dimension(:,:), allocatable cugmatprime</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00331">smodules.f90:331</a></div></div>
<div class="ttc" id="namespacespara_html_a98cae59fac1811dc59f79eb311a23621"><div class="ttname"><a href="namespacespara.html#a98cae59fac1811dc59f79eb311a23621">spara::swyckoffsymbol</a></div><div class="ttdeci">character *1, dimension(:), allocatable swyckoffsymbol</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00352">smodules.f90:352</a></div></div>
<div class="ttc" id="namespacecpara_html_a587592c122334a3ab662dc0283313bc5"><div class="ttname"><a href="namespacecpara.html#a587592c122334a3ab662dc0283313bc5">cpara::cuniqueug</a></div><div class="ttdeci">complex(ckind), dimension(:), allocatable cuniqueug</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00329">smodules.f90:329</a></div></div>
<div class="ttc" id="namespacesconst_html_a0203aa3599dd217fe8d28989aca34ae6"><div class="ttname"><a href="namespacesconst.html#a0203aa3599dd217fe8d28989aca34ae6">sconst::rstr</a></div><div class="ttdeci">character *50, parameter rstr</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00052">smodules.f90:52</a></div></div>
<div class="ttc" id="namespacemessage__mod_html_acbdfcb06d476307c8feb5c6bd1100384"><div class="ttname"><a href="namespacemessage__mod.html#acbdfcb06d476307c8feb5c6bd1100384">message_mod::iclockrate</a></div><div class="ttdeci">integer(ikind) iclockrate</div><div class="ttdef"><b>Definition:</b> <a href="message__mod_8f90_source.html#l00205">message_mod.f90:205</a></div></div>
<div class="ttc" id="namespaceipara_html_ad0186153d74deddab5c141201ec726d5"><div class="ttname"><a href="namespaceipara.html#ad0186153d74deddab5c141201ec726d5">ipara::irefinemode</a></div><div class="ttdeci">integer(ikind), dimension(irefinementvariabletypes) irefinemode</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00212">smodules.f90:212</a></div></div>
<div class="ttc" id="namespacemynumbers_html_aa13f60b32e8784cd78d2fdc5bf775dca"><div class="ttname"><a href="namespacemynumbers.html#aa13f60b32e8784cd78d2fdc5bf775dca">mynumbers::ikind</a></div><div class="ttdeci">integer, parameter ikind</div><div class="ttdef"><b>Definition:</b> <a href="gmodules_8f90_source.html#l00042">gmodules.f90:42</a></div></div>
<div class="ttc" id="namespacerpara_html_a02a9b407c398ac1fa9d488aa4f30fad5"><div class="ttname"><a href="namespacerpara.html#a02a9b407c398ac1fa9d488aa4f30fad5">rpara::rsymvec</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rsymvec</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00241">smodules.f90:241</a></div></div>
<div class="ttc" id="namespaceipara_html_afd60261f8e994e6676cd4fbc9498e8d0"><div class="ttname"><a href="namespaceipara.html#afd60261f8e994e6676cd4fbc9498e8d0">ipara::ithicknesscount</a></div><div class="ttdeci">integer(ikind) ithicknesscount</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00203">smodules.f90:203</a></div></div>
<div class="ttc" id="namespaceipara_html_a523e7442ffe4e47ba0150da851a2182a"><div class="ttname"><a href="namespaceipara.html#a523e7442ffe4e47ba0150da851a2182a">ipara::ipixelcount</a></div><div class="ttdeci">integer(ikind) ipixelcount</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00171">smodules.f90:171</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_a8b553926c9c6f1855ce2f6873c4204b8"><div class="ttname"><a href="felixrefine_8f90.html#a8b553926c9c6f1855ce2f6873c4204b8">maxgradientrefinement</a></div><div class="ttdeci">subroutine maxgradientrefinement</div><div class="ttdoc">Procedure-description: Refinement using the maximum gradient method. </div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l00999">felixrefine.f90:999</a></div></div>
<div class="ttc" id="namespaceipara_html_afcba3fe857dae5f644fc0c17c6dcc285"><div class="ttname"><a href="namespaceipara.html#afcba3fe857dae5f644fc0c17c6dcc285">ipara::imaxpossiblenatomsunitcell</a></div><div class="ttdeci">integer(ikind) imaxpossiblenatomsunitcell</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00173">smodules.f90:173</a></div></div>
<div class="ttc" id="namespacerpara_html_ab7db7986597161f727087ceddf86b5ab"><div class="ttname"><a href="namespacerpara.html#ab7db7986597161f727087ceddf86b5ab">rpara::rminimumgmag</a></div><div class="ttdeci">real(rkind) rminimumgmag</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00279">smodules.f90:279</a></div></div>
<div class="ttc" id="namespacesetup__space__group__mod_html_ab89d78c4ee07b71696f8d9bf10d11ff3"><div class="ttname"><a href="namespacesetup__space__group__mod.html#ab89d78c4ee07b71696f8d9bf10d11ff3">setup_space_group_mod::countallowedmovements</a></div><div class="ttdeci">subroutine, public countallowedmovements(ISpaceGrp, SWyckoff, IVectors, IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="setup__space__group__mod_8f90_source.html#l00338">setup_space_group_mod.f90:338</a></div></div>
<div class="ttc" id="namespaceread__files__mod_html"><div class="ttname"><a href="namespaceread__files__mod.html">read_files_mod</a></div><div class="ttdef"><b>Definition:</b> <a href="read__files__mod_8f90_source.html#l00033">read_files_mod.f90:33</a></div></div>
<div class="ttc" id="namespacerpara_html_a0876e889f6ebb06fa81cc8276ec6a131"><div class="ttname"><a href="namespacerpara.html#a0876e889f6ebb06fa81cc8276ec6a131">rpara::ratomposition</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable ratomposition</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00241">smodules.f90:241</a></div></div>
<div class="ttc" id="namespacerpara_html_a132781a742699634e36b131c3dab95cc"><div class="ttname"><a href="namespacerpara.html#a132781a742699634e36b131c3dab95cc">rpara::rbasisoccupancy</a></div><div class="ttdeci">real(rkind), dimension(:), allocatable rbasisoccupancy</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00240">smodules.f90:240</a></div></div>
<div class="ttc" id="namespacecpara_html_ab994df5c023832e6fbc15e15b5b28358"><div class="ttname"><a href="namespacecpara.html#ab994df5c023832e6fbc15e15b5b28358">cpara::cugmat</a></div><div class="ttdeci">complex(ckind), dimension(:,:), allocatable cugmat</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00331">smodules.f90:331</a></div></div>
<div class="ttc" id="namespacesconst_html_abd18ba1f2720af1402a35dd82dee22dc"><div class="ttname"><a href="namespacesconst.html#abd18ba1f2720af1402a35dd82dee22dc">sconst::dstr</a></div><div class="ttdeci">character *50, parameter dstr</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00053">smodules.f90:53</a></div></div>
<div class="ttc" id="namespacerconst_html_aa897c1c825282cfa362db0fb72b9b8ad"><div class="ttname"><a href="namespacerconst.html#aa897c1c825282cfa362db0fb72b9b8ad">rconst::relectroncharge</a></div><div class="ttdeci">real(rkind), parameter relectroncharge</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00134">smodules.f90:134</a></div></div>
<div class="ttc" id="namespacerpara_html_a89cf29de5c55a865bd717f19cc538f1d"><div class="ttname"><a href="namespacerpara.html#a89cf29de5c55a865bd717f19cc538f1d">rpara::rscattfactovolts</a></div><div class="ttdeci">real(rkind) rscattfactovolts</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00286">smodules.f90:286</a></div></div>
<div class="ttc" id="namespaceug__matrix__mod_html_add186c4b63f545bc1cec1d65317fd4fa"><div class="ttname"><a href="namespaceug__matrix__mod.html#add186c4b63f545bc1cec1d65317fd4fa">ug_matrix_mod::absorption</a></div><div class="ttdeci">subroutine, public absorption(IErr)</div><div class="ttdoc">Procedure-description: Select case using IAbsorbFLAG and calculate U&amp;#39;g prime in parallel. </div><div class="ttdef"><b>Definition:</b> <a href="ug__matrix__mod_8f90_source.html#l00048">ug_matrix_mod.f90:48</a></div></div>
<div class="ttc" id="namespaceipara_html_a8dbc1fbcf67a9f17b683553859de202b"><div class="ttname"><a href="namespaceipara.html#a8dbc1fbcf67a9f17b683553859de202b">ipara::iugoffset</a></div><div class="ttdeci">integer(ikind) iugoffset</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00218">smodules.f90:218</a></div></div>
<div class="ttc" id="namespacerefinementcontrol__mod_html"><div class="ttname"><a href="namespacerefinementcontrol__mod.html">refinementcontrol_mod</a></div><div class="ttdoc">Module-description: Holds main top level simulating SUBROUTINEs considering different thicknesses...</div><div class="ttdef"><b>Definition:</b> <a href="refinementcontrol__mod_8f90_source.html#l00041">refinementcontrol_mod.f90:41</a></div></div>
<div class="ttc" id="namespacerconst_html"><div class="ttname"><a href="namespacerconst.html">rconst</a></div><div class="ttdoc">Module-description: </div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00131">smodules.f90:131</a></div></div>
<div class="ttc" id="namespacerpara_html_a9d1675bd0647c4bdb98816ea5d62623f"><div class="ttname"><a href="namespacerpara.html#a9d1675bd0647c4bdb98816ea5d62623f">rpara::rgsummat</a></div><div class="ttdeci">real(rkind), dimension(:,:), allocatable rgsummat</div><div class="ttdef"><b>Definition:</b> <a href="smodules_8f90_source.html#l00287">smodules.f90:287</a></div></div>
<div class="ttc" id="felixrefine_8f90_html_a9a167b6970ffe0bac49df813e1f252ce"><div class="ttname"><a href="felixrefine_8f90.html#a9a167b6970ffe0bac49df813e1f252ce">bestfitcheck</a></div><div class="ttdeci">subroutine bestfitcheck(RFoM, RBest, RCurrent, RIndependentVariable, IErr)</div><div class="ttdoc">Procedure-description: </div><div class="ttdef"><b>Definition:</b> <a href="felixrefine_8f90_source.html#l01623">felixrefine.f90:1623</a></div></div>
<div class="ttc" id="namespacerefinementcontrol__mod_html_a399ecac264d4f6480f5ee698c94d2fce"><div class="ttname"><a href="namespacerefinementcontrol__mod.html#a399ecac264d4f6480f5ee698c94d2fce">refinementcontrol_mod::simulate</a></div><div class="ttdeci">subroutine, public simulate(IErr)</div><div class="ttdoc">Procedure-description: Simulates and produces images for each thickness. </div><div class="ttdef"><b>Definition:</b> <a href="refinementcontrol__mod_8f90_source.html#l00235">refinementcontrol_mod.f90:235</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
